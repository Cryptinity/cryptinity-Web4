<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0d0d0d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CRYPTINITY | Web4 Hybrid OS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, getDoc, getDocs, limit, where, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8FWRzYUnP8Q475Lb6KCqb-Ag9J4txgfM",
            authDomain: "cryptinity-web4-v01.firebaseapp.com",
            projectId: "cryptinity-web4-v01",
            storageBucket: "cryptinity-web4-v01.firebasestorage.app",
            messagingSenderId: "431735391458",
            appId: "1:431735391458:web:0b3280efb230ef36870abb",
            measurementId: "G-TWY5X0K9VP"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.fb = { 
                auth: getAuth(app), 
                db: getFirestore(app),
                fns: { 
                    signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, 
                    collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, getDoc, getDocs, limit, where, arrayUnion, arrayRemove, deleteDoc
                } 
            };
            console.log("Web4 Node Initialized");
        } catch(e) { console.error("Firebase Error:", e); }
    </script>

    <style>
        /* --- ENHANCED THEME ENGINE (Based on User Palette) --- */
        :root { 
            --neon: #9bf364;       /* Bright Lime */
            --cyan: #4ed5d2;       /* Hybrid Cyan */
            --dark: #0d0d0d;       /* Deep Black Background */
            --panel: #1e251f;      /* Dark Moss/Black (Card Background) */
            --text-main: #becabf;  /* Mist Grey */
            --accent-dark: #0e6011; /* Deep Green (Borders/Shadows) */
            --glass-border: rgba(155, 243, 100, 0.2);
        }
        
        body { 
            font-family: 'Rajdhani', sans-serif; 
            background-color: var(--dark); 
            color: var(--text-main); 
            overflow: hidden; 
            overscroll-behavior: none; 
            touch-action: manipulation; 
        }
        
        .brand-font { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        
        /* UTILS */
        .glass { 
            background: rgba(30, 37, 31, 0.85); /* Slightly more opaque for better contrast */
            backdrop-filter: blur(12px); 
            border: 1px solid var(--glass-border); 
            box-shadow: 0 4px 20px rgba(14, 96, 17, 0.3); /* Deep Green Shadow */
        }
        
        .glass-panel {
            background: var(--panel);
            border: 1px solid rgba(78, 213, 210, 0.1);
        }

        .hybrid-gradient-text {
            background: linear-gradient(to right, var(--neon), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(155, 243, 100, 0.3);
        }

        .hybrid-gradient-bg {
            background: linear-gradient(135deg, var(--neon), var(--cyan));
            color: #0d0d0d;
            box-shadow: 0 0 15px rgba(155, 243, 100, 0.4);
        }

        .accent-border { border: 1px solid var(--accent-dark); }
        .neon-border { border: 1px solid var(--neon); box-shadow: 0 0 10px rgba(155, 243, 100, 0.2); }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ANIMATIONS & BACKGROUNDS */
        .spot-bg { position: absolute; inset: 0; overflow: hidden; pointer-events: none; z-index: 0; }
        .spot { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.15; animation: spotMove 20s infinite alternate; }
        @keyframes spotMove { 0% { transform: translate(0,0) scale(1); } 100% { transform: translate(30px, -30px) scale(1.2); } }
        
        .chat-media { max-width: 100%; max-height: 400px; border-radius: 8px; margin-top: 5px; object-fit: cover; }
        
        /* REELS SNAP SCROLL */
        .snap-y-mandatory { scroll-snap-type: y mandatory; }
        .snap-center { scroll-snap-align: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useContext, createContext } = React;
        const AppContext = createContext();

        // --- CLOUDINARY INTEGRATION (IMAGES & VIDEO) ---
        const CLOUD_NAME = "dx3ilgqcd"; 
        const UPLOAD_PRESET = "thfhybyv"; 

        const uploadToCloudinary = async (file) => {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);
            let resourceType = 'auto'; 
            try {
                const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${resourceType}/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                return data.secure_url;
            } catch (error) {
                console.error("Cloudinary Error:", error);
                throw error;
            }
        };

        // --- HELPERS ---
        const cleanPayload = (data) => {
            const clean = {};
            Object.keys(data).forEach(key => {
                if (data[key] === undefined) clean[key] = null;
                else clean[key] = data[key];
            });
            return clean;
        };

        const formatTime = (timestamp) => {
            if (!timestamp) return "Just now";
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            const now = new Date();
            const diff = (now - date) / 1000; 
            if (diff < 60) return "Just now";
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        };

        // ENHANCED COMPRESSION FOR DATABASE SAFETY
        const compressImage = (file, maxWidth = 600, quality = 0.6) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // Calculate Aspect Ratio
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Compress to JPEG
                        resolve(canvas.toDataURL('image/jpeg', quality)); 
                    };
                };
            });
        };

        const fileToDataURL = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        };

        // ROBUST UPLOAD HANDLER
        const uploadWithFallback = async (file, isProfile = false) => {
            try {
                if (file.type.startsWith('video') || file.type.startsWith('audio')) {
                    const url = await uploadToCloudinary(file);
                    return { url: url, type: file.type.startsWith('video') ? 'video' : 'audio' };
                }
                
                try {
                    const url = await uploadToCloudinary(file);
                    return { url: url, type: 'image' };
                } catch (cloudErr) {
                    console.warn("Cloudinary failed, falling back to local compression.", cloudErr);
                    // Fallback to Aggressive Compression for Firestore Storage
                    const size = isProfile ? 300 : 600; 
                    const qual = isProfile ? 0.5 : 0.6;
                    const b64 = await compressImage(file, size, qual);
                    return { url: b64, type: 'image' };
                }
            } catch (e) {
                console.error("All upload methods failed", e);
                throw new Error("Upload failed. File might be too large.");
            }
        };

        const callGemini = async (prompt, systemPrompt) => {
            const systemKey = "AIzaSyCollQIyk7t_oy82278mF3ChsyzYr0CNIA"; 
            const userKey = localStorage.getItem('cryptinity_ai_key'); 
            const apiKey = userKey || systemKey;
            if (!apiKey) return "⚠️ NEURAL OFFLINE.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "System Error";
            } catch (error) { return "Connection Fault"; }
        };

        const DOCS = {
            whitepaper: "CRYPTINITY WEB4 WHITE PAPER\n\nEXECUTIVE SUMMARY:\nCryptinity Web4 is a futuristic hybrid super-application combining social media, digital finance, entertainment, and decentralized services. Native Token: CRYPT (CTY).\n\nARCHITECTURE:\nBuilt on a hybrid lattice-blockchain, ensuring quantum-resistant security and infinite scalability.",
            vision: "To create the world's most advanced hybrid platform that merges social connectivity, digital identity, and decentralized financial systems into a seamless, secure, and self-evolving ecosystem.",
            mission: "Empowering humanity through Web4 technology. We aim to democratize finance, ensure data sovereignty, and create a persistent digital reality.",
            roadmap: "PHASE 1 (Current): Core OS Launch, Social Beta, Music Engine.\nPHASE 2: Wallet Integration, AI Finance, Mobile App.\nPHASE 3: NFT Marketplace, DeFi Protocols, Metaverse Gates.\nPHASE 4: Full Quantum Web4 Ecosystem."
        };

        // --- COMPONENTS ---

        const HybridLogo = ({ size = 200, active = true }) => {
            const mountRef = useRef(null);
            useEffect(() => {
                if(!mountRef.current || !window.THREE) return;
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
                camera.position.z = 8;
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(size, size);
                renderer.setPixelRatio(window.devicePixelRatio);
                mountRef.current.innerHTML = '';
                mountRef.current.appendChild(renderer.domElement);
                const geometry = new THREE.TorusKnotGeometry(1.5, 0.4, 150, 8, 2, 3);
                const coreMat = new THREE.MeshBasicMaterial({ color: 0x0d0d0d }); // Deep Black Core
                const core = new THREE.Mesh(geometry, coreMat);
                core.material.polygonOffset = true; core.material.polygonOffsetFactor = 1;
                const wireMat = new THREE.MeshBasicMaterial({ color: 0x9bf364, wireframe: true, transparent: true, opacity: 1 }); // Neon Lime Wire
                const wire = new THREE.Mesh(geometry, wireMat);
                const group = new THREE.Group(); group.add(core); group.add(wire); scene.add(group);
                const animate = () => {
                    if(!mountRef.current) return;
                    requestAnimationFrame(animate);
                    if(active) { group.rotation.y += 0.015; group.rotation.x += 0.005; }
                    renderer.render(scene, camera);
                };
                animate();
                return () => { renderer.dispose(); };
            }, [size, active]);
            return <div ref={mountRef} className="filter drop-shadow-[0_0_15px_rgba(155,243,100,0.4)]" />;
        };

        const Auth = ({ setUser }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [loading, setLoading] = useState(false);
            const [form, setForm] = useState({email:'', pass:'', name:''});
            const handleAuth = async (e) => {
                e.preventDefault(); if(!window.fb) return alert("System Initializing...");
                setLoading(true); const { auth, db, fns } = window.fb;
                try {
                    let userCred;
                    if(isLogin) { userCred = await fns.signInWithEmailAndPassword(auth, form.email, form.pass); } 
                    else {
                        userCred = await fns.createUserWithEmailAndPassword(auth, form.email, form.pass);
                        const robotAvatar = `https://api.dicebear.com/9.x/bottts-neutral/svg?seed=${userCred.user.uid}`;
                        await fns.updateProfile(userCred.user, { displayName: form.name, photoURL: robotAvatar });
                        await fns.setDoc(fns.doc(db, "users", userCred.user.uid), {
                            displayName: form.name, email: form.email, joined: fns.serverTimestamp(),
                            avatar: robotAvatar, cover: "#0e6011", bio: "Web4 Early Adopter",
                            anthem: null, followers: [], following: [], verified: false, balance: 0.00000000,
                            savedPosts: [],
                            settings: { notifications: true, privacy: false, security: true }, visitors: []
                        });
                    }
                    setUser(userCred.user);
                } catch(err) { alert(err.message); }
                setLoading(false);
            };
            return (
                <div className="h-screen w-full bg-[#0d0d0d] flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    <div className="spot-bg">
                        <div className="spot w-96 h-96 top-0 left-0 bg-[#0e6011]"></div>
                        <div className="spot w-96 h-96 bottom-0 right-0 bg-[#1e251f]"></div>
                    </div>
                    <div className="z-10 w-full max-w-sm flex flex-col items-center">
                        <HybridLogo size={180} />
                        <h1 className="text-3xl font-bold text-white brand-font mt-4 tracking-widest hybrid-gradient-text">CRYPTINITY</h1>
                        <p className="text-[#9bf364] text-[10px] tracking-[0.4em] uppercase font-bold mb-8">Web4 Hybrid OS</p>
                        <div className="glass w-full p-6 rounded-2xl border-t border-[#9bf364]">
                            <form onSubmit={handleAuth} className="space-y-4">
                                {!isLogin && <input required placeholder="Display Name" className="w-full bg-[#1e251f] border border-[#0e6011] rounded p-3 text-white outline-none focus:border-[#9bf364] placeholder-gray-500" onChange={e=>setForm({...form, name:e.target.value})} />}
                                <input required type="email" placeholder="Email Access ID" className="w-full bg-[#1e251f] border border-[#0e6011] rounded p-3 text-white outline-none focus:border-[#9bf364] placeholder-gray-500" onChange={e=>setForm({...form, email:e.target.value})} />
                                <input required type="password" placeholder="Passkey" className="w-full bg-[#1e251f] border border-[#0e6011] rounded p-3 text-white outline-none focus:border-[#9bf364] placeholder-gray-500" onChange={e=>setForm({...form, pass:e.target.value})} />
                                <button type="submit" className="w-full py-3 hybrid-gradient-bg text-[#0d0d0d] font-bold brand-font rounded hover:opacity-90 transition flex justify-center shadow-[0_0_15px_rgba(155,243,100,0.4)]">{loading ? 'INITIALIZING...' : (isLogin ? 'INITIALIZE' : 'CREATE WEB4 ID')}</button>
                            </form>
                            <button onClick={()=>setIsLogin(!isLogin)} className="w-full mt-4 text-xs text-gray-400 hover:text-[#9bf364] transition">{isLogin ? 'Request New Identity' : 'Access Existing Node'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const CallManager = ({ user }) => {
            const [incomingCall, setIncomingCall] = useState(null);
            const [activeCall, setActiveCall] = useState(null);
            const [callStatus, setCallStatus] = useState("Connecting...");
            const [cameraOn, setCameraOn] = useState(true);
            const [muted, setMuted] = useState(false);

            useEffect(() => {
                if(!user) return;
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "calls"), window.fb.fns.where("to", "==", user.uid), window.fb.fns.where("status", "==", "ringing"));
                const unsub = window.fb.fns.onSnapshot(q, snap => {
                    if(!snap.empty) { const callData = snap.docs[0].data(); setIncomingCall({ id: snap.docs[0].id, ...callData }); } else { setIncomingCall(null); }
                });
                return () => unsub();
            }, [user]);

            const acceptCall = async () => { 
                if(!incomingCall) return; 
                await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "calls", incomingCall.id), { status: "connected" }); 
                setActiveCall(incomingCall); 
                setIncomingCall(null); 
                setCallStatus("Secure Neural Link Established"); 
            };

            const declineCall = async () => {
                if(incomingCall) { await window.fb.fns.deleteDoc(window.fb.fns.doc(window.fb.db, "calls", incomingCall.id)); setIncomingCall(null); }
                if(activeCall) { try { await window.fb.fns.deleteDoc(window.fb.fns.doc(window.fb.db, "calls", activeCall.id)); } catch(e){} setActiveCall(null); }
            };

            if(incomingCall) {
                return (
                    <div className="absolute inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center p-6 animate-fade-in">
                        <div className="w-32 h-32 rounded-full border-4 border-[#9bf364] overflow-hidden mb-4 animate-pulse"><img src={incomingCall.callerAvatar} className="w-full h-full object-cover"/></div>
                        <h2 className="text-2xl text-white font-bold mb-2">{incomingCall.callerName}</h2><p className="text-[#9bf364] animate-pulse mb-10">INCOMING ENCRYPTED CALL...</p>
                        <div className="flex gap-8"><button onClick={declineCall} className="w-16 h-16 rounded-full bg-red-500 text-white flex items-center justify-center text-2xl"><i className="fas fa-phone-slash"></i></button><button onClick={acceptCall} className="w-16 h-16 rounded-full hybrid-gradient-bg text-black flex items-center justify-center text-2xl animate-bounce"><i className="fas fa-video"></i></button></div>
                    </div>
                );
            }
            if(activeCall) {
                return (
                    <div className="absolute inset-0 z-[100] bg-black flex flex-col">
                        <div className="flex-1 relative overflow-hidden">
                            {/* Local Camera (Simulated Full Screen) */}
                            {cameraOn ? (
                                <video ref={v => { if(v && !v.srcObject) navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s=>v.srcObject=s).catch(e=>console.log(e)) }} autoPlay muted className="w-full h-full object-cover transform scale-x-[-1]" />
                            ) : (
                                <div className="w-full h-full flex items-center justify-center bg-gray-900"><i className="fas fa-video-slash text-6xl text-gray-700"></i></div>
                            )}
                            
                            {/* Remote User (Simulated Picture in Picture) */}
                            <div className="absolute top-4 right-4 w-28 h-40 bg-gray-900 border border-[#9bf364] rounded-xl overflow-hidden shadow-2xl z-20">
                                <img src={activeCall.callerAvatar} className="w-full h-full object-cover"/>
                                <div className="absolute bottom-0 w-full bg-black/60 text-[8px] text-center text-white py-1">{activeCall.callerName}</div>
                            </div>

                            <div className="absolute top-10 left-0 right-0 flex justify-center"><div className="bg-black/50 px-4 py-1 rounded-full text-[#9bf364] text-xs font-mono border border-[#9bf364]/30">{callStatus}</div></div>
                        </div>
                        <div className="h-24 bg-black/80 backdrop-blur flex items-center justify-center gap-8 pb-safe">
                            <button onClick={()=>setMuted(!muted)} className={`p-4 rounded-full text-white text-xl transition ${muted ? 'bg-white text-black' : 'bg-gray-800'}`}><i className={`fas fa-microphone${muted?'-slash':''}`}></i></button>
                            <button onClick={declineCall} className="p-6 bg-red-600 rounded-full text-white text-2xl shadow-[0_0_15px_rgba(255,0,0,0.5)] transform hover:scale-110 transition"><i className="fas fa-phone-slash"></i></button>
                            <button onClick={()=>setCameraOn(!cameraOn)} className={`p-4 rounded-full text-white text-xl transition ${!cameraOn ? 'bg-white text-black' : 'bg-gray-800'}`}><i className={`fas fa-video${!cameraOn?'-slash':''}`}></i></button>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const Search = ({ close, goToProfile }) => {
            const [queryStr, setQueryStr] = useState(""); const [results, setResults] = useState([]);
            useEffect(() => { 
                if(queryStr.length < 2) { setResults([]); return; } 
                const q = window.fb.fns.query(
                    window.fb.fns.collection(window.fb.db, "users"), 
                    window.fb.fns.where("displayName", ">=", queryStr), 
                    window.fb.fns.where("displayName", "<=", queryStr + '\uf8ff'), 
                    window.fb.fns.limit(20) 
                ); 
                const unsub = window.fb.fns.onSnapshot(q, snap => { setResults(snap.docs.map(d => ({...d.data(), uid: d.id}))); }); 
                return () => unsub(); 
            }, [queryStr]);

            return (
                <div className="absolute inset-0 bg-black/95 z-50 p-4 animate-fade-in">
                    <div className="flex gap-3 mb-6"><input autoFocus value={queryStr} onChange={e=>setQueryStr(e.target.value)} placeholder="Search Network (Case Sensitive)..." className="flex-1 bg-gray-900 border border-[#9bf364] rounded-full px-4 py-2 text-white outline-none" /><button onClick={close} className="text-gray-400">Cancel</button></div>
                    <div className="space-y-3">
                        {results.length === 0 && queryStr.length > 2 && <div className="text-gray-500 text-center text-xs">Searching global blockchain nodes...</div>}
                        {results.map(r => (<div key={r.uid} onClick={()=>{ goToProfile(r.uid); close(); }} className="flex items-center gap-3 p-3 glass rounded-xl cursor-pointer hover:border-[#9bf364]"><img src={r.avatar} className="w-10 h-10 rounded-full object-cover" /><div><div className="text-white font-bold text-sm">{r.displayName}</div><div className="text-gray-500 text-xs">UID: {r.uid.slice(0,5)}...</div></div></div>))}
                    </div>
                </div>
            );
        };
        
        const NotificationPanel = ({ user, close, goToProfile }) => {
            const [notifs, setNotifs] = useState([]);
            useEffect(() => {
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "notifications"), window.fb.fns.where("to", "==", user.uid), window.fb.fns.orderBy("createdAt", "desc"), window.fb.fns.limit(20));
                const unsub = window.fb.fns.onSnapshot(q, snap => setNotifs(snap.docs.map(d=>d.data())));
                return () => unsub();
            }, [user]);
            return (
                <div className="absolute inset-0 bg-black/95 z-40 p-4 animate-fade-in pt-16">
                     <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold text-white brand-font">NOTIFICATIONS</h2><button onClick={close}><i className="fas fa-times text-white"></i></button></div>
                     <div className="space-y-3">{notifs.length===0 && <div className="text-gray-500 text-center mt-10">No signals detected.</div>}{notifs.map((n,i) => (
                         <div key={i} className="glass p-3 rounded-xl flex gap-3 items-center border border-gray-800">
                             <img src={n.avatar} className="w-8 h-8 rounded-full border border-[#9bf364]"/>
                             <div className="flex-1 text-sm text-gray-300">
                                 <span className="text-white font-bold">{n.author}</span> {n.type === 'like' ? 'liked your transmission.' : (n.type === 'comment' ? 'commented on your post.' : 'started following you.')}
                             </div>
                             <div className="text-[10px] text-[#9bf364]">{formatTime(n.createdAt)}</div>
                         </div>
                     ))}</div>
                </div>
            );
        };

        const ReelsView = ({ user, close }) => {
            const [reels, setReels] = useState([]);
            useEffect(() => {
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "posts"), window.fb.fns.where("mediaType", "==", "video"), window.fb.fns.limit(10));
                const unsub = window.fb.fns.onSnapshot(q, snap => setReels(snap.docs.map(d => ({...d.data(), id:d.id}))));
                return () => unsub();
            }, []);
            return (
                <div className="absolute inset-0 bg-black z-30 snap-y-mandatory overflow-y-scroll h-full w-full">
                    <button onClick={close} className="fixed top-4 right-4 z-50 bg-black/50 text-white rounded-full p-2"><i className="fas fa-times"></i></button>
                    {reels.map((r) => (
                        <div key={r.id} className="snap-center h-full w-full relative flex items-center justify-center bg-[#0d0d0d]">
                            <video src={r.image} className="h-full w-full object-cover" autoPlay muted loop onClick={(e)=>e.target.muted=!e.target.muted}></video>
                            <div className="absolute bottom-20 left-4 right-4 z-10">
                                <div className="flex items-center gap-2 mb-2"><img src={r.avatar} className="w-8 h-8 rounded-full border border-[#9bf364]"/><span className="font-bold text-white text-shadow shadow-black">{r.author}</span></div>
                                <p className="text-white text-sm mb-2">{r.text}</p>
                            </div>
                            <div className="absolute right-4 bottom-32 flex flex-col gap-6 items-center text-white text-xl z-10">
                                <div className="flex flex-col items-center"><i className="fas fa-heart text-[#9bf364]"></i><span className="text-xs">{r.likes?.length||0}</span></div>
                                <div className="flex flex-col items-center"><i className="fas fa-comment"></i><span className="text-xs">{r.comments?.length||0}</span></div>
                            </div>
                        </div>
                    ))}
                    {reels.length===0 && <div className="h-full flex items-center justify-center text-gray-500">No Reels Signal Found.</div>}
                </div>
            );
        };

        const Mining = ({ user }) => {
            const [active, setActive] = useState(false);
            const [balance, setBalance] = useState(0);
            const [loaded, setLoaded] = useState(false);
            const [countdown, setCountdown] = useState("");
            const balanceRef = useRef(0);

            useEffect(() => {
                if(!user) return;
                const unsub = window.fb.fns.onSnapshot(window.fb.fns.doc(window.fb.db, "users", user.uid), (doc) => {
                    if(doc.exists()) {
                        const val = parseFloat(doc.data().balance) || 0;
                        if(!active && !loaded) {
                            balanceRef.current = val;
                            setBalance(val);
                            setLoaded(true);
                        }
                    }
                });
                return () => unsub();
            }, [user, active, loaded]);

            useEffect(() => {
                let interval;
                if(active) {
                    interval = setInterval(() => {
                        balanceRef.current += 0.00000012;
                        setBalance(balanceRef.current);
                    }, 100);
                }
                return () => clearInterval(interval);
            }, [active]);

            useEffect(() => {
                const saveInt = setInterval(() => {
                    if(active && loaded) {
                        window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", user.uid), {
                            balance: balanceRef.current
                        });
                    }
                }, 3000); 
                return () => clearInterval(saveInt);
            }, [active, loaded, user]);

            useEffect(() => {
                const targetDate = new Date("2026-01-25T00:00:00").getTime();
                const t = setInterval(() => { 
                    const now = Date.now(); const d = targetDate - now; if(d < 0) return; 
                    const days = Math.floor(d/(1000*60*60*24)); const hours = Math.floor((d%(1000*60*60*24))/(1000*60*60)); const mins = Math.floor((d%(1000*60*60))/(1000*60)); const secs = Math.floor((d%(1000*60))/1000); 
                    setCountdown(`${days}d ${hours}h ${mins}m ${secs}s`); 
                }, 1000);
                return () => clearInterval(t);
            }, []);

            return (
                <div className="h-full overflow-y-auto pb-24 relative flex flex-col items-center p-4">
                    <div className="spot-bg"><div className="spot w-80 h-80 top-0 left-0 bg-[#9bf364]"></div><div className="spot w-80 h-80 bottom-0 right-0 bg-[#4ed5d2]"></div></div>
                    <h2 className="text-2xl font-bold brand-font text-white mb-2 z-10 mt-4 tracking-widest">CLOUD <span className="text-[#9bf364]">MINING</span></h2>
                    <div className="z-10 bg-black/50 border border-[#9bf364]/50 rounded-full px-4 py-1 mb-4"><span className="text-white text-xs font-mono">1 CTY = <span className="text-[#9bf364] font-bold">$0.0004</span></span></div>
                    <div className={`transition-all duration-700 z-10 mb-8 ${active ? 'scale-110 drop-shadow-[0_0_30px_#9bf364]' : 'opacity-80 grayscale'}`}><HybridLogo size={220} active={active} /></div>
                    <div className="glass w-full rounded-2xl p-6 border-t border-[#9bf364] z-10 relative mb-4">
                        <div className="flex justify-between items-center mb-6"><div><div className="text-[10px] uppercase text-gray-500">Mined (Locked)</div><div className="text-3xl font-mono text-white tracking-widest">{loaded ? balance.toFixed(8) : "SYNCING..."} <span className="text-[#9bf364] text-sm">CTY</span></div></div><div className="text-right"><div className="text-[10px] uppercase text-gray-500">Active Miners</div><div className="font-bold text-[#9bf364] animate-pulse">98,104,530</div></div></div>
                        <div className="text-center mb-6"><div className="text-[9px] text-[#9bf364] uppercase tracking-[0.3em] mb-1">Launch Countdown</div><div className="text-2xl font-mono text-white font-bold">{countdown}</div></div>
                        <button onClick={()=>setActive(!active)} className={`w-full py-4 rounded-xl font-bold brand-font text-sm tracking-widest transition ${active ? 'bg-red-900/40 text-red-500 border border-red-500' : 'hybrid-gradient-bg text-black hover:opacity-90'}`}>{active ? 'HALT MINING SEQUENCE' : 'ACTIVATE CLOUD NODE'}</button>
                    </div>
                    <div className="w-full glass p-4 rounded-xl z-10 border border-[#0e6011] space-y-4">
                         <div className="text-[#9bf364] text-xs font-bold uppercase"><i className="fas fa-wallet mr-2"></i> Withdrawal Configuration</div>
                         <div><label className="text-[10px] text-gray-500 uppercase">CTY Wallet Address</label><div className="flex bg-[#0d0d0d] border border-gray-700 rounded p-2 items-center"><input placeholder="Enter your CTY Address..." className="flex-1 bg-transparent text-xs text-white outline-none font-mono"/><i className="fas fa-qrcode text-gray-500"></i></div></div>
                         <div><label className="text-[10px] text-gray-500 uppercase">Network</label><select className="w-full bg-[#0d0d0d] border border-gray-700 rounded p-2 text-xs text-white outline-none"><option>Web4 Chain (Native) - 0 Fee</option><option>Binance Smart Chain (BEP20)</option><option>Ethereum (ERC20)</option><option>Tron (TRC20)</option></select></div>
                         <div className="flex gap-4"><div className="flex-1 bg-black/50 border border-gray-800 p-2 rounded"><div className="text-[9px] text-gray-500">Min Withdrawal</div><div className="text-white font-mono text-xs">500 CTY</div></div><div className="flex-1 bg-black/50 border border-gray-800 p-2 rounded"><div className="text-[9px] text-gray-500">Max Withdrawal</div><div className="text-white font-mono text-xs">50,000 CTY</div></div></div>
                         <button className="w-full bg-gray-800 text-gray-500 font-bold py-3 rounded text-xs uppercase cursor-not-allowed">Withdrawal Locked Until Launch</button>
                    </div>
                </div>
            );
        };

        const WarehouseApp = ({ user, goBack }) => {
            const [view, setView] = useState('all'); const [files, setFiles] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => { 
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "warehouse"), window.fb.fns.where("uid", "==", user.uid)); 
                const unsub = window.fb.fns.onSnapshot(q, snap => {
                    const data = snap.docs.map(d => ({...d.data(), id: d.id}));
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setFiles(data);
                }); 
                return () => unsub(); 
            }, [user]);

            const handleUpload = async (e) => {
                const f = e.target.files[0]; if(!f) return;
                setLoading(true);
                try {
                    const result = await uploadWithFallback(f);
                    if(result && result.url) {
                        let type = 'file';
                        if(f.type.startsWith('image')) type = 'photo';
                        if(f.type.includes('pdf') || f.type.includes('text')) type = 'ebook';
                        
                        await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "warehouse"), cleanPayload({ name: f.name, data: result.url, type, uid: user.uid, createdAt: window.fb.fns.serverTimestamp() }));
                    }
                } catch (err) { alert("Upload Failed: " + err.message); }
                setLoading(false);
            };
            const deleteFile = async (id) => { if(confirm("Delete file?")) await window.fb.fns.deleteDoc(window.fb.fns.doc(window.fb.db, "warehouse", id)); };
            const filtered = view === 'all' ? files : files.filter(f => f.type === view);
            
            const handleDownload = (fileUrl, fileName) => {
                const link = document.createElement("a");
                link.href = fileUrl;
                link.download = fileName; 
                link.target = "_blank";   
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="h-full bg-[#0d0d0d] p-4 flex flex-col">
                    <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><button onClick={goBack} className="text-gray-400"><i className="fas fa-arrow-left"></i></button><h2 className="text-xl font-bold text-white brand-font">WARE<span className="text-[#9bf364]">HOUSE</span></h2></div><label className="hybrid-gradient-bg text-black px-3 py-1 rounded text-xs font-bold cursor-pointer">{loading ? '...' : '+ UPLOAD'}<input type="file" hidden onChange={handleUpload}/></label></div>
                    <div className="flex gap-2 mb-4 overflow-x-auto"><button onClick={()=>setView('all')} className={`px-3 py-1 rounded-full text-xs font-bold border ${view==='all'?'bg-[#9bf364] text-black border-transparent':'text-gray-400 border-gray-800'}`}>ALL</button><button onClick={()=>setView('photo')} className={`px-3 py-1 rounded-full text-xs font-bold border ${view==='photo'?'bg-[#9bf364] text-black border-transparent':'text-gray-400 border-gray-800'}`}>PHOTOS</button><button onClick={()=>setView('ebook')} className={`px-3 py-1 rounded-full text-xs font-bold border ${view==='ebook'?'bg-[#9bf364] text-black border-transparent':'text-gray-400 border-gray-800'}`}>EBOOKS</button></div>
                    <div className="grid grid-cols-2 gap-3 overflow-y-auto pb-20">
                        {filtered.map(f => (
                            <div key={f.id} className="glass p-2 rounded-xl relative group border border-[#0e6011]">
                                <button onClick={()=>deleteFile(f.id)} className="absolute top-1 right-1 bg-red-500/80 text-white w-5 h-5 rounded flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition z-10">x</button>
                                {f.type==='photo' ? <img src={f.data} className="w-full h-24 object-cover rounded mb-2"/> : <div className="w-full h-24 bg-[#1e251f] rounded mb-2 flex items-center justify-center text-2xl text-[#4ed5d2]"><i className={`fas fa-${f.type==='ebook'?'book':'file'}`}></i></div>}
                                <div className="text-white text-xs truncate font-bold mb-2">{f.name}</div>
                                <button onClick={()=>handleDownload(f.data, f.name)} className="w-full block text-center text-[#0d0d0d] bg-[#4ed5d2] text-[10px] rounded py-1 font-bold hover:bg-[#9bf364]">DOWNLOAD</button>
                            </div>
                        ))}
                        {filtered.length===0 && <div className="col-span-2 text-center text-gray-600 mt-10">Vault Empty</div>}
                    </div>
                </div>
            );
        };

        const OracleApp = ({ goBack }) => {
            const [msgs, setMsgs] = useState([{ sender: 'ai', text: 'Greetings. I am The Oracle. Ask me anything.' }]); const [input, setInput] = useState(''); const [loading, setLoading] = useState(false); const scrollRef = useRef();
            const send = async (e) => { e.preventDefault(); if (!input.trim() || loading) return; const userMsg = input; setMsgs(p => [...p, { sender: 'user', text: userMsg }]); setInput(''); setLoading(true); const reply = await callGemini(userMsg, "You are 'The Oracle', the AI core of Cryptinity. Cyberpunk style. Concise."); setMsgs(p => [...p, { sender: 'ai', text: reply }]); setLoading(false); };
            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [msgs]);
            return (<div className="h-full flex flex-col bg-[#0d0d0d] pb-24"><div className="p-4 border-b border-[#0e6011] flex items-center gap-3"><button onClick={goBack} className="text-[#9bf364]"><i className="fas fa-arrow-left"></i></button><h2 className="text-white font-bold brand-font text-sm">THE <span className="text-[#9bf364]">ORACLE</span></h2></div><div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>{msgs.map((m, i) => (<div key={i} className={`flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[80%] p-3 rounded-xl text-sm ${m.sender === 'user' ? 'hybrid-gradient-bg text-black' : 'glass text-white border border-[#9bf364]/30'}`}>{m.text}</div></div>))}{loading && <div className="text-center text-xs text-[#9bf364] animate-pulse">PROCESSING...</div>}</div><form onSubmit={send} className="p-3 border-t border-[#0e6011] flex gap-2"><input value={input} onChange={e => setInput(e.target.value)} className="flex-1 bg-[#1e251f] rounded-full px-4 text-white text-sm outline-none border border-transparent focus:border-[#9bf364]" placeholder="Query the Oracle..." /><button type="submit" className="text-[#9bf364] font-bold px-2"><i className="fas fa-paper-plane"></i></button></form></div>);
        };

        const Settings = ({ user }) => {
            const [userSettings, setUserSettings] = useState({ notifications: true, privacy: false, security: true });
            const [apiKey, setApiKey] = useState(localStorage.getItem('cryptinity_ai_key') || '');
            useEffect(() => { window.fb.fns.getDoc(window.fb.fns.doc(window.fb.db, "users", user.uid)).then(d => { if(d.exists() && d.data().settings) setUserSettings(d.data().settings); }); }, [user]);
            const saveKey = (e) => { const val = e.target.value; setApiKey(val); localStorage.setItem('cryptinity_ai_key', val); };
            const toggleSetting = async (key) => { const newVal = !userSettings[key]; const newSet = { ...userSettings, [key]: newVal }; setUserSettings(newSet); await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", user.uid), { settings: newSet }); };
            
            const nukeAdminPosts = async () => {
                if (!confirm("WARNING: This will manually delete ALL admin posts from the feed. Are you sure?")) return;
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "posts"));
                const snap = await window.fb.fns.getDocs(q);
                snap.forEach(async (d) => {
                    const data = d.data();
                    if (data.author === "Cryptinity_Admin" || data.uid === "ADMIN" || data.isSystem) {
                        await window.fb.fns.deleteDoc(d.ref);
                    }
                });
                alert("Cleanup Complete. Please refresh.");
            };

            return (<div className="h-full overflow-y-auto pb-24 bg-[#0d0d0d] p-4"><h2 className="text-2xl font-bold text-white brand-font mb-6">SYSTEM <span className="text-[#9bf364]">CONTROLS</span></h2><div className="glass p-4 rounded-xl mb-6 border border-[#4ed5d2]/30"><div className="flex items-center gap-2 mb-2"><i className="fas fa-brain text-[#4ed5d2]"></i><span className="text-white font-bold text-sm">Neural Link (API Key)</span></div><input value={apiKey} onChange={saveKey} placeholder="Enter Gemini API Key..." className="w-full bg-black/50 border border-gray-700 rounded p-2 text-xs text-white outline-none focus:border-[#4ed5d2]" /><div className="text-[9px] text-gray-500 mt-1">Required for AI Oracle & Magic Drafts. <a href="https://aistudio.google.com/" target="_blank" className="text-[#4ed5d2] underline">Get Free Key</a></div></div><div className="space-y-4"><div className="glass p-4 rounded-xl flex justify-between items-center"><span className="text-white font-bold">Push Notifications</span><button onClick={()=>toggleSetting('notifications')} className={`w-12 h-6 rounded-full relative transition ${userSettings.notifications?'bg-[#9bf364]':'bg-gray-700'}`}><div className={`absolute top-1 w-4 h-4 bg-black rounded-full transition-all ${userSettings.notifications?'left-7':'left-1'}`}></div></button></div><div className="glass p-4 rounded-xl flex justify-between items-center"><span className="text-white font-bold">Privacy</span><button onClick={()=>toggleSetting('privacy')} className={`w-12 h-6 rounded-full relative transition ${userSettings.privacy?'bg-[#9bf364]':'bg-gray-700'}`}><div className={`absolute top-1 w-4 h-4 bg-black rounded-full transition-all ${userSettings.privacy?'left-7':'left-1'}`}></div></button></div><button onClick={nukeAdminPosts} className="w-full py-3 border border-red-500 text-red-500 font-bold rounded-xl bg-red-900/10 hover:bg-red-900/30">WIPE ADMIN FEED</button><button onClick={()=>window.fb.fns.signOut(window.fb.auth)} className="w-full py-3 mt-4 border border-gray-700 text-gray-400 font-bold rounded-xl">TERMINATE SESSION</button></div></div>);
        };

        const DocsApp = ({ goBack }) => {
            const [section, setSection] = useState('whitepaper');
            return (
                <div className="h-full overflow-y-auto pb-24 bg-[#0d0d0d] p-4">
                    <div className="flex items-center gap-3 mb-6"><button onClick={goBack} className="text-[#9bf364]"><i className="fas fa-arrow-left"></i></button><h2 className="text-2xl font-bold text-white brand-font">ARCHIVE <span className="text-[#9bf364]">CORE</span></h2></div>
                    <div className="flex gap-2 overflow-x-auto mb-6 hide-scroll">{Object.keys(DOCS).map(k => (<button key={k} onClick={()=>setSection(k)} className={`px-4 py-2 rounded-full text-xs font-bold uppercase whitespace-nowrap border ${section===k?'hybrid-gradient-bg text-black border-transparent':'text-gray-400 border-gray-800'}`}>{k}</button>))}</div>
                    <div className="glass p-6 rounded-xl border border-[#0e6011] relative overflow-hidden">
                        <h3 className="text-xl font-bold text-[#9bf364] uppercase mb-4 brand-font">{section}</h3>
                        <p className="text-gray-300 text-sm whitespace-pre-wrap leading-relaxed font-mono">{DOCS[section]}</p>
                    </div>
                </div>
            );
        };

        const Profile = ({ currentUser, targetUid, startChat, callUser, player }) => {
            const [data, setData] = useState(null); const [tab, setTab] = useState('posts'); const [isEditingBio, setIsEditingBio] = useState(false); const [bioText, setBioText] = useState(""); const [myPosts, setMyPosts] = useState([]); const uid = targetUid || currentUser.uid; const isMe = uid === currentUser.uid;
            const [saved, setSaved] = useState([]);
            const [uploading, setUploading] = useState(false);

            useEffect(() => { const unsub = window.fb.fns.onSnapshot(window.fb.fns.doc(window.fb.db, "users", uid), d => { if(d.exists()) { const ud = d.data(); setData(ud); setBioText(ud.bio || ""); if(ud.anthem && player && player.song?.audio !== ud.anthem) { player.play({ name: `${ud.displayName}'s Anthem`, artist_name: "Web4 User", image: ud.avatar, audio: ud.anthem }); } if (!isMe) { const visitor = { uid: currentUser.uid, name: currentUser.displayName, avatar: currentUser.photoURL, time: Date.now() }; const currentVisitors = ud.visitors || []; if (!currentVisitors.some(v => v.uid === currentUser.uid && Date.now() - v.time < 3600000)) { const newVisitors = [visitor, ...currentVisitors].slice(0, 20); window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", uid), { visitors: newVisitors }); } } } }); return () => unsub(); }, [uid]);
            useEffect(() => { 
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "posts"), window.fb.fns.where("uid", "==", uid)); 
                const unsub = window.fb.fns.onSnapshot(q, snap => { 
                    const data = snap.docs.map(d => d.data());
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setMyPosts(data); 
                }); 
                return () => unsub(); 
            }, [uid]);
            
            useEffect(() => {
                if(tab === 'saved' && isMe && data?.savedPosts?.length) {
                   Promise.all(data.savedPosts.map(pid => window.fb.fns.getDoc(window.fb.fns.doc(window.fb.db, "posts", pid))))
                   .then(snaps => setSaved(snaps.filter(s=>s.exists()).map(s=>s.data())));
                }
            }, [tab, data]);

            // FIXED AND ENHANCED UPLOAD LOGIC
            const handleUpload = async (e, field) => { 
                const file = e.target.files[0]; if(!file || !isMe) return; 
                setUploading(true);
                try {
                    // Pass true for isProfile if uploading avatar to compress more aggressively
                    const result = await uploadWithFallback(file, field === 'avatar');
                    
                    if(result && result.url) {
                        await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", uid), { [field]: result.url }); 
                        if(field==='avatar') { 
                            window.fb.fns.updateProfile(window.fb.auth.currentUser, { photoURL: result.url }); 
                        } 
                        alert(`${field} updated successfully!`);
                    } else {
                        throw new Error("Invalid upload result");
                    }
                } catch(err) { 
                    alert("Upload Failed: " + err.message); 
                    console.error(err);
                }
                setUploading(false);
            };

            const saveBio = async () => { await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", uid), { bio: bioText }); setIsEditingBio(false); };
            const toggleFollow = async () => { if(isMe) return; const ref = window.fb.fns.doc(window.fb.db, "users", uid); const amFollowing = data.followers?.includes(currentUser.uid); if(amFollowing) { await window.fb.fns.updateDoc(ref, { followers: window.fb.fns.arrayRemove(currentUser.uid) }); await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", currentUser.uid), { following: window.fb.fns.arrayRemove(uid) }); } else { await window.fb.fns.updateDoc(ref, { followers: window.fb.fns.arrayUnion(currentUser.uid) }); await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", currentUser.uid), { following: window.fb.fns.arrayUnion(uid) }); } };
            const handleCall = async () => { if(isMe) return; await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "calls"), { from: currentUser.uid, to: uid, callerName: currentUser.displayName, callerAvatar: currentUser.photoURL, status: "ringing", createdAt: window.fb.fns.serverTimestamp() }); };
            if(!data) return <div className="p-10 text-center text-[#9bf364]">LOADING NODE...</div>;
            
            return (
                <div className="h-full overflow-y-auto pb-24 bg-[#0d0d0d]">
                    <div className="h-40 relative group" style={{backgroundColor: data.cover && !data.cover.startsWith('http') ? data.cover : '#1e251f'}}>
                        {data.cover?.startsWith('http') && <img src={data.cover} className="w-full h-full object-cover" onError={(e)=>{e.target.style.display='none'}} />}
                        {isMe && (
                            <div className="absolute top-2 right-2 flex gap-2">
                                <label className={`bg-[#0d0d0d]/80 text-[#9bf364] p-2 rounded cursor-pointer hover:bg-black transition border border-[#9bf364] ${uploading?'opacity-50 pointer-events-none':''}`}>
                                    <i className={`fas fa-${uploading ? 'spinner fa-spin' : 'camera'}`}></i> 
                                    <input type="file" hidden accept="image/*" onChange={(e)=>handleUpload(e,'cover')}/>
                                </label>
                            </div>
                        )}
                    </div>
                    <div className="px-5 -mt-12 relative">
                        <div className="w-24 h-24 rounded-full border-4 border-[#0d0d0d] bg-[#1e251f] relative overflow-hidden group shadow-[0_0_20px_rgba(155,243,100,0.3)]">
                            <img src={data.avatar} className="w-full h-full object-cover" onError={(e)=>{e.target.src='https://api.dicebear.com/9.x/bottts-neutral/svg?seed=fallback'}} />
                            {isMe && <label className="absolute inset-0 bg-black/50 flex items-center justify-center text-[#9bf364] opacity-0 group-hover:opacity-100 cursor-pointer transition"><i className="fas fa-camera"></i> <input type="file" hidden accept="image/*" onChange={(e)=>handleUpload(e,'avatar')}/></label>}
                        </div>
                        <div className="mt-3 flex justify-between items-start"><div><h1 className="text-2xl font-bold text-white brand-font">{data.displayName} <i className="fas fa-check-circle text-[#4ed5d2] text-xs"></i></h1><p className="text-gray-500 text-xs">UID: {uid.slice(0,8)}...</p></div>{!isMe && (<div className="flex gap-2"><button onClick={toggleFollow} className={`px-4 py-1 rounded-full text-xs font-bold border ${data.followers?.includes(currentUser.uid) ? 'border-gray-600 text-gray-400' : 'hybrid-gradient-bg text-black border-transparent'}`}>{data.followers?.includes(currentUser.uid) ? 'UNFOLLOW' : 'FOLLOW'}</button><button onClick={()=>startChat(uid)} className="bg-[#1e251f] text-white px-3 py-1 rounded-full text-xs font-bold border border-[#0e6011]"><i className="fas fa-envelope"></i></button><button onClick={handleCall} className="bg-[#1e251f] text-[#9bf364] px-3 py-1 rounded-full text-xs font-bold border border-[#0e6011]"><i className="fas fa-phone"></i></button></div>)}</div>
                        <div className="mt-4 glass p-3 rounded-xl flex items-center gap-3 border border-[#0e6011]"><div className="w-8 h-8 rounded-full bg-[#9bf364] flex items-center justify-center text-black animate-spin-slow"><i className="fas fa-compact-disc"></i></div><div className="flex-1"><div className="text-[9px] text-gray-500 uppercase">Profile Anthem</div><div className="text-white text-xs font-bold truncate">{data.anthem ? "Playing..." : "No Anthem Set."}</div></div>{isMe && <label className="text-[#9bf364] text-xs cursor-pointer hover:underline"><i className="fas fa-upload mr-1"></i> <input type="file" hidden accept="audio/*,video/*" onChange={(e)=>handleUpload(e,'anthem')}/></label>}</div>
                        <div className="flex gap-6 my-4 text-sm"><div className="text-white font-bold">{data.followers?.length || 0} <span className="text-gray-500 font-normal">Followers</span></div><div className="text-white font-bold">{data.following?.length || 0} <span className="text-gray-500 font-normal">Following</span></div></div>
                        <div className="flex border-b border-gray-800 mb-4">{['posts','about','bio', ...(isMe ? ['visitors', 'saved'] : [])].map(t => (<button key={t} onClick={()=>setTab(t)} className={`flex-1 py-3 text-xs font-bold uppercase ${tab===t?'text-[#9bf364] border-b-2 border-[#9bf364]':'text-gray-500'}`}>{t}</button>))}</div>
                        <div className="min-h-[200px] text-gray-400 text-sm">
                            {tab === 'posts' && (<div className="space-y-4">{myPosts.length === 0 && <div className="text-center py-10 text-gray-600">No activities recorded.</div>}{myPosts.map((p,i) => (<div key={i} className="glass p-3 rounded-xl"><div className="text-white text-sm mb-2">{p.text}</div>{p.image && <img src={p.image} className="rounded mb-2 max-h-40 object-cover" onError={(e)=>{e.target.src='https://img.icons8.com/ios-glyphs/90/9bf364/broken-image.png'}} />}<div className="text-[10px] text-gray-500">{formatTime(p.createdAt)}</div></div>))}</div>)}
                            {tab === 'about' && <div className="space-y-2"><p>Joined: {data.joined?.toDate().toDateString()}</p><p>Node: Active</p></div>}
                            {tab === 'bio' && (<div className="glass p-4 rounded-xl border border-[#0e6011] relative">{isMe && <button onClick={()=>setIsEditingBio(!isEditingBio)} className="absolute top-2 right-2 text-gray-500 hover:text-white"><i className="fas fa-pencil-alt"></i></button>}{isEditingBio ? (<div><textarea value={bioText} onChange={e=>setBioText(e.target.value)} className="w-full bg-black/50 text-white p-2 rounded mb-2 border border-gray-700 outline-none" rows="3"></textarea><button onClick={saveBio} className="bg-[#9bf364] text-black px-3 py-1 rounded text-xs font-bold">SAVE BIO</button></div>) : (<div className="italic">"{data.bio}"</div>)}</div>)}
                            {tab === 'visitors' && isMe && (
                                <div className="space-y-2">
                                    <div className="text-[#9bf364] text-xs font-bold mb-2 uppercase">Who Viewed Your Profile</div>
                                    {(data.visitors || []).length === 0 && <div className="text-center py-4">No recent visitors.</div>}
                                    {(data.visitors || []).map((v, i) => (
                                        <div key={i} className="flex items-center gap-3 p-3 glass rounded-xl border border-[#0e6011]">
                                            <img src={v.avatar} className="w-8 h-8 rounded-full" onError={(e)=>{e.target.src=`https://api.dicebear.com/9.x/bottts-neutral/svg?seed=${v.uid}`}}/>
                                            <div className="flex-1"><div className="text-white font-bold">{v.name}</div><div className="text-[10px] text-gray-500">{formatTime(v.time)}</div></div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {tab === 'saved' && isMe && (
                                <div className="space-y-2">
                                    {saved.length===0 && <div className="text-center py-4">No favorites saved.</div>}
                                    {saved.map((p, i) => (<div key={i} className="glass p-3 rounded-xl"><div className="text-white text-xs mb-1 font-bold">{p.author}</div><div className="text-gray-300 text-sm">{p.text}</div>{p.image && <img src={p.image} className="mt-2 h-20 rounded object-cover"/>}</div>))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };
        
        const MessengerList = ({ user, goToChat, goBack }) => {
            const [users, setUsers] = useState([]);
            useEffect(() => {
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "users"), window.fb.fns.limit(20));
                window.fb.fns.getDocs(q).then(snap => setUsers(snap.docs.map(d=>({uid:d.id, ...d.data()})).filter(u=>u.uid!==user.uid)));
            }, []);
            return (
                <div className="h-full bg-[#0d0d0d] flex flex-col">
                    <div className="p-4 border-b border-[#0e6011] flex items-center gap-3"><button onClick={goBack} className="text-[#9bf364]"><i className="fas fa-arrow-left"></i></button><h2 className="text-white font-bold brand-font text-sm">ENCRYPTED <span className="text-[#9bf364]">INBOX</span></h2></div>
                    <div className="overflow-y-auto p-4 space-y-3">
                        {users.map(u => (
                            <div key={u.uid} onClick={()=>goToChat(u.uid)} className="flex items-center gap-3 p-3 glass rounded-xl cursor-pointer hover:border-[#9bf364]">
                                <div className="relative"><img src={u.avatar} className="w-12 h-12 rounded-full object-cover"/><div className="absolute bottom-0 right-0 w-3 h-3 bg-[#9bf364] rounded-full border border-black"></div></div>
                                <div className="flex-1">
                                    <div className="text-white font-bold">{u.displayName}</div>
                                    <div className="text-xs text-gray-500">Tap to start secure channel</div>
                                </div>
                                <i className="fas fa-comment-alt text-gray-600"></i>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const PrivateChat = ({ user, targetUid, goBack }) => {
            const [msgs, setMsgs] = useState([]); const [txt, setTxt] = useState(""); const scrollRef = useRef(); const chatId = [user.uid, targetUid].sort().join("_");
            const [attach, setAttach] = useState(null); const [showEmoji, setShowEmoji] = useState(false);
            const [recording, setRecording] = useState(false);
            const mediaRecorderRef = useRef(null);

            const emojis = ["🔥","🚀","💎","💀","👽","🤖","👾","🧠","👁️","⚡","📀","💾"];
            const gifs = ["https://media.giphy.com/media/26tn33aiTi1jkl6H6/giphy.gif", "https://media.giphy.com/media/LMC8paGihNTuo/giphy.gif", "https://media.giphy.com/media/3o7TKsADS5Kq3Qp8J2/giphy.gif"];
            
            useEffect(() => { const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "messages", chatId, "chats"), window.fb.fns.orderBy("createdAt", "asc")); const unsub = window.fb.fns.onSnapshot(q, snap => { setMsgs(snap.docs.map(d => ({...d.data(), id:d.id}))); if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }); return () => unsub(); }, [chatId]);
            
            const handleFile = async (e) => { const f = e.target.files[0]; if(!f) return; if(f.size > 800000) return alert("Max 800KB"); const b64 = await fileToDataURL(f); setAttach({ url: b64, type: f.type.startsWith('video') ? 'video' : 'image' }); };
            
            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    const chunks = [];
                    mediaRecorderRef.current.ondataavailable = e => chunks.push(e.data);
                    mediaRecorderRef.current.onstop = async () => {
                        const blob = new Blob(chunks, { type: 'audio/webm' });
                        const file = new File([blob], "voice.webm", { type: 'audio/webm' });
                        const res = await uploadWithFallback(file);
                        await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "messages", chatId, "chats"), { text: "", attachment: res, from: user.uid, createdAt: window.fb.fns.serverTimestamp() });
                    };
                    mediaRecorderRef.current.start();
                    setRecording(true);
                } catch(e) { alert("Mic Access Denied"); }
            };

            const stopRecording = () => {
                if(mediaRecorderRef.current) { mediaRecorderRef.current.stop(); setRecording(false); }
            };

            const send = async (e) => { e.preventDefault(); if(!txt.trim() && !attach) return; await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "messages", chatId, "chats"), { text: txt, attachment: attach, from: user.uid, createdAt: window.fb.fns.serverTimestamp() }); setTxt(""); setAttach(null); };
            
            const deleteMsg = async (id) => {
                if(confirm("Recall transmission?")) {
                    await window.fb.fns.deleteDoc(window.fb.fns.doc(window.fb.db, "messages", chatId, "chats", id));
                }
            };

            return (<div className="h-full flex flex-col bg-[#0d0d0d] pb-24 relative"><div className="p-4 border-b border-[#0e6011] flex items-center gap-3"><button onClick={goBack} className="text-[#9bf364]"><i className="fas fa-arrow-left"></i></button><h2 className="text-white font-bold brand-font text-sm">ENCRYPTED <span className="text-[#9bf364]">CHANNEL</span></h2></div><div className="flex-1 overflow-y-auto p-4 space-y-3" ref={scrollRef}>{msgs.map((m,i) => (<div key={i} className={`flex ${m.from===user.uid?'justify-end':'justify-start'} group`}><div className={`max-w-[70%] p-3 rounded-xl text-sm ${m.from===user.uid?'hybrid-gradient-bg text-black':'glass text-white'}`}>{m.attachment && (m.attachment.type==='video' ? <video src={m.attachment.url} controls className="chat-media"/> : (m.attachment.type==='audio' ? <audio controls src={m.attachment.url} className="w-48"/> : <img src={m.attachment.url} className="chat-media"/>))}{m.text}</div>{m.from===user.uid && <button onClick={()=>deleteMsg(m.id)} className="text-red-500 ml-2 opacity-0 group-hover:opacity-100"><i className="fas fa-trash"></i></button>}<div className="text-[9px] text-gray-500 mt-1 px-1">{formatTime(m.createdAt)}</div></div>))}</div>{showEmoji && <div className="absolute bottom-16 left-4 bg-gray-900 border border-gray-700 p-2 rounded grid grid-cols-4 gap-2 z-50">{emojis.map(e => <button key={e} onClick={()=>{setTxt(prev=>prev+e); setShowEmoji(false)}} className="text-xl hover:bg-white/10 rounded">{e}</button>)}<button onClick={()=>{const g = gifs[Math.floor(Math.random()*gifs.length)]; setAttach({url:g, type:'image'}); setShowEmoji(false)}} className="col-span-4 text-xs bg-[#39ff14] text-black font-bold rounded py-1 mt-1">GIF</button></div>}<form onSubmit={send} className="p-3 border-t border-[#0e6011] flex gap-2 items-center"><button type="button" onClick={()=>setShowEmoji(!showEmoji)} className="text-gray-400 hover:text-white"><i className="far fa-smile"></i></button><label className="text-gray-400 hover:text-white cursor-pointer"><i className="fas fa-paperclip"></i><input type="file" hidden onChange={handleFile}/></label><div className="flex-1 relative">{attach && <div className="absolute -top-8 left-0 text-[10px] text-[#39ff14] bg-black/80 px-2 rounded">Attached <button onClick={()=>setAttach(null)} className="ml-1 text-red-500">x</button></div>}<input value={txt} onChange={e=>setTxt(e.target.value)} className="w-full bg-[#1e251f] rounded-full px-4 py-1.5 text-white text-sm outline-none" placeholder="Message..." /></div><button type="button" onClick={recording ? stopRecording : startRecording} className={`${recording?'text-red-500 animate-pulse':'text-gray-400'} px-2`}><i className={`fas fa-${recording?'stop':'microphone'}`}></i></button><button type="submit" className="text-[#9bf364] font-bold px-2"><i className="fas fa-paper-plane"></i></button></form></div>);
        };

        const AppsHub = ({ openApp }) => (
            <div className="h-full overflow-y-auto pb-24 p-4 bg-[#0d0d0d]">
                <h2 className="text-2xl font-bold text-white brand-font mb-6">WEB4 <span className="text-[#9bf364]">ECOSYSTEM</span></h2>
                <div className="grid grid-cols-2 gap-4">
                    <div onClick={()=>openApp('oracle')} className="aspect-[4/3] rounded-xl relative overflow-hidden glass border border-[#0e6011] flex items-center justify-center cursor-pointer hover:border-[#9bf364] transition shadow-[0_0_15px_rgba(155,243,100,0.2)] group"><div className="text-center"><i className="fas fa-brain text-4xl text-[#9bf364] mb-2 group-hover:scale-110 transition-transform"></i><div className="font-bold text-white brand-font">The Oracle</div><div className="text-[9px] text-[#9bf364] mt-1 font-bold">AI CORE</div></div></div>
                    <div onClick={()=>openApp('warehouse')} className="aspect-[4/3] rounded-xl relative overflow-hidden glass border border-[#0e6011] flex items-center justify-center cursor-pointer hover:border-[#9bf364] transition"><div className="text-center"><i className="fas fa-box-open text-3xl text-[#4ed5d2] mb-2"></i><div className="font-bold text-white brand-font">Warehouse</div><div className="text-[9px] text-gray-400 mt-1">Cloud Storage</div></div></div>
                    <div onClick={()=>openApp('groups')} className="aspect-[4/3] rounded-xl relative overflow-hidden glass border border-[#0e6011] flex items-center justify-center cursor-pointer hover:border-[#9bf364] transition"><div className="text-center"><i className="fas fa-users text-3xl text-white mb-2"></i><div className="font-bold text-white brand-font">Groups</div><div className="text-[9px] text-gray-400 mt-1">Encrypted Chat</div></div></div>
                    <div onClick={()=>openApp('docs')} className="aspect-[4/3] rounded-xl relative overflow-hidden glass border border-[#0e6011] flex items-center justify-center cursor-pointer hover:border-[#9bf364] transition"><div className="text-center"><i className="fas fa-file-alt text-3xl text-[#9bf364] mb-2"></i><div className="font-bold text-white brand-font">White Paper</div></div></div>
                    {[{n:"Wallet", i:"wallet"},{n:"Games", i:"gamepad"},{n:"Casino", i:"dice"},{n:"NFTs", i:"images"},{n:"Visa", i:"credit-card"},{n:"Metaverse", i:"vr-cardboard"}].map((a,i)=>(<div key={i} className="aspect-[4/3] rounded-xl relative overflow-hidden glass border border-[#0e6011] flex items-center justify-center opacity-70"><div className="text-center"><i className={`fas fa-${a.i} text-2xl text-gray-500 mb-2`}></i><div className="font-bold text-white brand-font mb-1">{a.n}</div><div className="text-[9px] bg-gray-700 text-white px-1 rounded inline-block font-bold">SOON</div></div></div>))}
                </div>
            </div>
        );

        const GroupsApp = ({ user, goBack }) => {
            const [view, setView] = useState('list'); const [groups, setGroups] = useState([]); const [newGroupName, setNewGroupName] = useState(""); const [activeGroup, setActiveGroup] = useState(null);
            const [msgs, setMsgs] = useState([]); const [txt, setTxt] = useState(""); const [inviteName, setInviteName] = useState(""); const scrollRef = useRef();
            const [attach, setAttach] = useState(null);
            useEffect(() => { const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "groups"), window.fb.fns.where("members", "array-contains", user.uid)); const unsub = window.fb.fns.onSnapshot(q, snap => { setGroups(snap.docs.map(d => ({...d.data(), id: d.id}))); }); return () => unsub(); }, [user]);
            useEffect(() => { if(!activeGroup) return; const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "groups", activeGroup.id, "messages"), window.fb.fns.orderBy("createdAt", "asc")); const unsub = window.fb.fns.onSnapshot(q, snap => { setMsgs(snap.docs.map(d => d.data())); if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }); return () => unsub(); }, [activeGroup]);
            const createGroup = async () => { if(!newGroupName.trim()) return; await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "groups"), { name: newGroupName, createdBy: user.uid, members: [user.uid], createdAt: window.fb.fns.serverTimestamp() }); setNewGroupName(""); setView('list'); };
            const handleFile = async (e) => { const f = e.target.files[0]; if(!f) return; const b64 = await fileToDataURL(f); setAttach({ url: b64, type: f.type.startsWith('video') ? 'video' : 'image' }); };
            const sendMsg = async (e) => { e.preventDefault(); if(!txt.trim() && !attach) return; await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "groups", activeGroup.id, "messages"), { text: txt, attachment: attach, senderName: user.displayName, senderUid: user.uid, createdAt: window.fb.fns.serverTimestamp() }); setTxt(""); setAttach(null); };
            const inviteUser = async () => { if(!inviteName.trim()) return; const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "users"), window.fb.fns.where("displayName", "==", inviteName), window.fb.fns.limit(1)); const unsub = window.fb.fns.onSnapshot(q, async (s) => { if(!s.empty) { const uidToAdd = s.docs[0].id; await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "groups", activeGroup.id), { members: window.fb.fns.arrayUnion(uidToAdd) }); alert(`Added ${inviteName}!`); setInviteName(""); } else { alert("User not found!"); } unsub(); }); };
            if(view === 'list') { return (<div className="h-full bg-[#0d0d0d] p-4 overflow-y-auto"><div className="flex items-center justify-between mb-6"><h2 className="text-xl font-bold text-white brand-font">MY <span className="text-[#9bf364]">GROUPS</span></h2><button onClick={goBack} className="text-gray-400"><i className="fas fa-times"></i></button></div><button onClick={()=>setView('create')} className="w-full py-3 mb-4 border border-dashed border-[#9bf364] text-[#9bf364] rounded-xl font-bold hover:bg-[#9bf364]/10">+ NEW GROUP</button><div className="space-y-2">{groups.map(g => (<div key={g.id} onClick={()=>{setActiveGroup(g); setView('chat')}} className="glass p-4 rounded-xl flex justify-between items-center cursor-pointer hover:border-[#9bf364]"><div className="font-bold text-white">{g.name}</div><i className="fas fa-chevron-right text-gray-500"></i></div>))}</div></div>); }
            if(view === 'create') { return (<div className="h-full bg-[#0d0d0d] p-4 flex flex-col justify-center"><h2 className="text-white text-lg font-bold mb-4 text-center">NAME YOUR SQUAD</h2><input value={newGroupName} onChange={e=>setNewGroupName(e.target.value)} className="bg-[#1e251f] border border-[#9bf364] p-3 rounded-xl text-white mb-4 outline-none text-center" placeholder="Group Name..." /><div className="flex gap-2"><button onClick={()=>setView('list')} className="flex-1 py-3 bg-gray-800 text-white rounded-xl">CANCEL</button><button onClick={createGroup} className="flex-1 py-3 bg-[#9bf364] text-black font-bold rounded-xl">CREATE</button></div></div>); }
            if(view === 'chat' && activeGroup) { return (<div className="h-full flex flex-col bg-[#0d0d0d] pb-24 relative"><div className="p-4 border-b border-[#0e6011] flex justify-between items-center bg-[#1e251f]/50"><div className="flex items-center gap-3"><button onClick={()=>setView('list')} className="text-gray-400"><i className="fas fa-arrow-left"></i></button><div><div className="text-white font-bold">{activeGroup.name}</div><div className="text-[10px] text-gray-500">{activeGroup.members.length} Members</div></div></div><div className="relative group"><i className="fas fa-user-plus text-[#9bf364] cursor-pointer"></i><div className="absolute right-0 top-6 w-48 bg-black border border-gray-700 p-2 rounded hidden group-hover:block z-50"><input value={inviteName} onChange={e=>setInviteName(e.target.value)} placeholder="Username..." className="w-full bg-gray-900 text-white text-xs p-1 mb-1" /><button onClick={inviteUser} className="w-full bg-[#9bf364] text-black text-xs py-1">INVITE</button></div></div></div><div className="flex-1 overflow-y-auto p-4 space-y-3" ref={scrollRef}>{msgs.map((m,i) => (<div key={i} className={`flex flex-col ${m.senderUid===user.uid?'items-end':'items-start'}`}><div className={`max-w-[75%] p-2 rounded-xl text-sm ${m.senderUid===user.uid?'hybrid-gradient-bg text-black':'glass text-white'}`}>{m.attachment && (m.attachment.type==='video' ? <video src={m.attachment.url} controls className="chat-media"/> : <img src={m.attachment.url} className="chat-media"/>)}{m.text}</div><span className="text-[9px] text-gray-500 mt-1">{m.senderName} • {formatTime(m.createdAt)}</span></div>))}</div><form onSubmit={sendMsg} className="p-3 border-t border-[#0e6011] flex gap-2 items-center"><label className="text-gray-400 hover:text-white cursor-pointer"><i className="fas fa-paperclip"></i><input type="file" hidden onChange={handleFile}/></label><div className="flex-1 relative">{attach && <div className="absolute -top-8 left-0 text-[10px] text-[#9bf364] bg-black/80 px-2 rounded">File Attached</div>}<input value={txt} onChange={e=>setTxt(e.target.value)} className="w-full bg-[#1e251f] rounded-full px-4 text-white text-sm outline-none" placeholder={`Message ${activeGroup.name}...`} /></div><button type="submit" className="text-[#9bf364] px-2"><i className="fas fa-paper-plane"></i></button></form></div>); }
        };

        const Music = ({ player }) => {
            const [tracks, setTracks] = useState([]); const [localTracks, setLocalTracks] = useState([]); const [tab, setTab] = useState('cloud');
            
            useEffect(() => { 
                fetch(`https://api.jamendo.com/v3.0/tracks/?client_id=ecbc9437&format=jsonpretty&limit=20&order=popularity_total&imagesize=200`)
                .then(r => r.json()).then(d => setTracks(d.results)).catch(()=>{}); 
                
                // Load Local
                const saved = JSON.parse(localStorage.getItem('my_uploads') || '[]');
                setLocalTracks(saved); 
            }, []);

            const handleUpload = (e) => { 
                const file = e.target.files[0]; 
                if(file) { 
                    const reader = new FileReader(); 
                    reader.onload = (evt) => { 
                        const newTrack = { 
                            name: file.name.replace(/\.[^/.]+$/, ""), 
                            artist_name: "My Upload", 
                            image: "https://img.icons8.com/fluency/96/music-record.png", 
                            audio: evt.target.result, 
                            id: Date.now() 
                        }; 
                        const updated = [newTrack, ...localTracks]; 
                        setLocalTracks(updated); 
                        localStorage.setItem('my_uploads', JSON.stringify(updated)); 
                    }; 
                    reader.readAsDataURL(file); 
                } 
            };

            return (
                <div className="h-full overflow-y-auto pb-24 p-4 bg-[#0d0d0d]">
                    <h2 className="text-2xl font-bold text-white brand-font mb-4">WEB4 <span className="text-[#9bf364]">AUDIO</span></h2>
                    <div className="flex gap-4 mb-4">
                        <button onClick={()=>setTab('cloud')} className={`text-xs font-bold uppercase ${tab==='cloud'?'text-[#9bf364]':'text-gray-500'}`}>Cloud Stream</button>
                        <button onClick={()=>setTab('local')} className={`text-xs font-bold uppercase ${tab==='local'?'text-[#9bf364]':'text-gray-500'}`}>My Uploads</button>
                    </div>
                    
                    {tab === 'local' && (
                        <div>
                            <label className="block glass border-dashed border border-[#0e6011] p-4 rounded-xl text-center cursor-pointer mb-4 hover:border-[#9bf364]">
                                <i className="fas fa-cloud-upload-alt text-2xl text-[#9bf364] mb-1"></i>
                                <div className="text-xs text-gray-400">Upload MP3</div>
                                <input type="file" hidden accept="audio/*" onChange={handleUpload}/>
                            </label>
                            {localTracks.length === 0 && <div className="text-gray-600 text-center text-xs">No local tracks uploaded.</div>}
                        </div>
                    )}

                    {(tab==='cloud'?tracks:localTracks).map((t,i) => (
                        <div key={i} onClick={()=>player.play(t)} className="flex items-center p-3 mb-2 glass rounded-xl cursor-pointer hover:border-[#9bf364]">
                            <img src={t.image} className="w-12 h-12 rounded mr-3"/>
                            <div className="flex-1 overflow-hidden">
                                <div className="text-sm font-bold text-white truncate">{t.name}</div>
                                <div className="text-xs text-gray-500 truncate">{t.artist_name}</div>
                            </div>
                            <button className="text-[#9bf364]"><i className="fas fa-play"></i></button>
                        </div>
                    ))}
                </div>
            );
        };
        
        const LiveMode = ({ user, close }) => (
            <div className="absolute inset-0 bg-black z-50 flex flex-col">
                 <div className="relative flex-1 bg-gray-900 overflow-hidden">
                     <video ref={v=>{if(v)navigator.mediaDevices.getUserMedia({video:true}).then(s=>v.srcObject=s)}} autoPlay muted className="w-full h-full object-cover opacity-80"></video>
                     <div className="absolute top-4 left-4 bg-red-600 px-3 py-1 rounded text-white font-bold text-xs animate-pulse">LIVE</div>
                     <div className="absolute top-4 right-4 bg-black/50 px-3 py-1 rounded text-white text-xs"><i className="fas fa-eye"></i> 0</div>
                     <button onClick={close} className="absolute top-4 right-20 text-white shadow"><i className="fas fa-times"></i></button>
                     <div className="absolute bottom-20 left-4">
                         <div className="text-white font-bold text-shadow">{user.displayName}</div>
                         <div className="text-xs text-[#9bf364]">Starting broadcast...</div>
                     </div>
                 </div>
                 <div className="h-16 bg-black flex items-center justify-center p-4">
                     <button onClick={close} className="bg-red-500 text-white px-8 py-2 rounded-full font-bold">END STREAM</button>
                 </div>
            </div>
        );

        const Social = ({ user, goToProfile, toggleReels, triggerLive }) => {
            const [posts, setPosts] = useState([]); const [newPost, setNewPost] = useState(""); const [media, setMedia] = useState(null); const [loading, setLoading] = useState(false); const [aiLoading, setAiLoading] = useState(false); const [commenting, setCommenting] = useState(null); const [commentText, setCommentText] = useState("");
            const [stories, setStories] = useState([]);
            const [viewingStory, setViewingStory] = useState(null);
            const [currentUserData, setCurrentUserData] = useState(null);

            useEffect(() => {
                const unsub = window.fb.fns.onSnapshot(window.fb.fns.doc(window.fb.db, "users", user.uid), (doc) => {
                    if (doc.exists()) setCurrentUserData(doc.data());
                });
                return () => unsub();
            }, [user]);

            useEffect(() => { const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "posts"), window.fb.fns.orderBy("createdAt", "desc"), window.fb.fns.limit(40)); const unsub = window.fb.fns.onSnapshot(q, (snap) => { setPosts(snap.docs.map(d => ({...d.data(), id: d.id}))); }); return () => unsub(); }, []);
            
            useEffect(() => {
                const yesterday = new Date(Date.now() - 86400000);
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "stories"), window.fb.fns.orderBy("createdAt", "desc"));
                const unsub = window.fb.fns.onSnapshot(q, snap => {
                    const active = snap.docs.map(d=>d.data()).filter(s => s.createdAt?.seconds * 1000 > yesterday.getTime());
                    setStories(active);
                });
                return () => unsub();
            }, []);

            const handleFile = async (e) => {
                const f = e.target.files[0]; if(!f) return;
                setLoading(true);
                try {
                    const result = await uploadWithFallback(f);
                    if(result && result.url) setMedia(result);
                } catch (err) {
                    alert("Upload Failed: " + err.message);
                    e.target.value = null;
                }
                setLoading(false);
            };
            
            const uploadStory = async (e) => {
                const f = e.target.files[0]; if(!f) return;
                setLoading(true);
                try {
                    const res = await uploadWithFallback(f);
                    await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "stories"), cleanPayload({
                        uid: user.uid, author: user.displayName, avatar: user.photoURL,
                        image: res.url, type: res.type,
                        createdAt: window.fb.fns.serverTimestamp()
                    }));
                    alert("Story Posted");
                } catch(e) { alert("Story Error: " + e.message); }
                setLoading(false);
            };

            const handleAIDraft = async () => { if (aiLoading) return; setAiLoading(true); const topic = newPost || "the future of web4"; const draft = await callGemini(`Topic: ${topic}`, "Write a short, cyberpunk social post. Use emojis."); setNewPost(draft); setAiLoading(false); };
            
            const handlePost = async (e) => { 
                e.preventDefault(); 
                if(!newPost.trim() && !media) return; 
                setLoading(true); 
                try {
                    const postData = cleanPayload({ 
                        author: user.displayName, 
                        avatar: currentUserData?.avatar || user.photoURL, 
                        uid: user.uid, 
                        text: newPost, 
                        image: media ? media.url : null, 
                        mediaType: media ? media.type : 'image', 
                        createdAt: window.fb.fns.serverTimestamp(), 
                        likes: [], 
                        comments: [] 
                    });
                    
                    await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "posts"), postData); 
                    setNewPost(""); 
                    setMedia(null); 
                    const fileInput = document.getElementById('fileUpload');
                    if(fileInput) fileInput.value = '';
                } catch(err) {
                    alert("Post Error: " + err.message);
                }
                setLoading(false); 
            };

            const handleLike = async (post, likes) => { 
                const ref = window.fb.fns.doc(window.fb.db, "posts", post.id); 
                const safeLikes = Array.isArray(likes) ? likes : []; 
                const hasLiked = safeLikes.includes(user.uid); 
                await window.fb.fns.updateDoc(ref, { likes: hasLiked ? safeLikes.filter(id=>id!==user.uid) : [...safeLikes, user.uid] }); 
            };
            
            const handleSave = async (post) => {
                const userRef = window.fb.fns.doc(window.fb.db, "users", user.uid);
                const currentSaved = currentUserData?.savedPosts || [];
                const isSaved = currentSaved.includes(post.id);
                await window.fb.fns.updateDoc(userRef, {
                    savedPosts: isSaved ? window.fb.fns.arrayRemove(post.id) : window.fb.fns.arrayUnion(post.id)
                });
            };

            const handleComment = async (e, post) => { 
                e.preventDefault(); if(!commentText.trim()) return; 
                await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "posts", post.id), { comments: window.fb.fns.arrayUnion({ text: commentText, author: user.displayName, uid: user.uid, time: Date.now() }) }); 
                setCommentText(""); 
            };
            const handleDeletePost = async (postId) => { if(confirm("Delete this broadcast?")) { try { await window.fb.fns.deleteDoc(window.fb.fns.doc(window.fb.db, "posts", postId)); } catch(e) { alert("Delete failed: " + e.message); } } };

            return (
                <div className="h-full overflow-y-auto pb-24 bg-[#0d0d0d]">
                    <div className="flex gap-2 p-4 overflow-x-auto hide-scroll border-b border-[#0e6011]">
                        <div className="flex flex-col items-center gap-1 shrink-0">
                            <label className="w-14 h-14 rounded-full border-2 border-dashed border-[#9bf364] flex items-center justify-center text-[#9bf364] cursor-pointer">
                                <i className="fas fa-plus"></i>
                                <input type="file" hidden accept="image/*,video/*" onChange={uploadStory}/>
                            </label>
                            <span className="text-[9px] text-gray-400">Add Story</span>
                        </div>
                        {stories.map((s,i) => (
                            <div key={i} onClick={()=>setViewingStory(s)} className="flex flex-col items-center gap-1 shrink-0 cursor-pointer">
                                <div className="w-14 h-14 rounded-full p-[2px] hybrid-gradient-bg">
                                    <img src={s.avatar} className="w-full h-full rounded-full border-2 border-black object-cover"/>
                                </div>
                                <span className="text-[9px] text-gray-400 truncate w-14 text-center">{s.author}</span>
                            </div>
                        ))}
                    </div>

                    {viewingStory && (
                        <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center" onClick={()=>setViewingStory(null)}>
                            <div className="absolute top-4 left-4 flex items-center gap-2">
                                <img src={viewingStory.avatar} className="w-8 h-8 rounded-full"/>
                                <span className="text-white font-bold">{viewingStory.author}</span>
                            </div>
                            {viewingStory.type==='video' ? <video src={viewingStory.image} autoPlay className="max-h-full max-w-full"/> : <img src={viewingStory.image} className="max-h-full max-w-full"/>}
                        </div>
                    )}

                    <div className="p-4 border-b border-[#0e6011] bg-[#1e251f]/50">
                        <div className="flex gap-3 mb-2">
                            <img src={currentUserData?.avatar || user.photoURL} className="w-10 h-10 rounded-full border border-[#9bf364] object-cover"/>
                            <textarea value={newPost} onChange={e=>setNewPost(e.target.value)} placeholder="Broadcast to Web4..." className="flex-1 bg-transparent text-white outline-none text-sm resize-none h-10 pt-2 placeholder-gray-500"></textarea>
                        </div>
                        {media && <div className="mb-2 relative w-20 h-20 bg-gray-800 rounded overflow-hidden"><img src={media.type === 'video' ? 'https://img.icons8.com/fluency/96/video.png' : media.url} className="w-full h-full object-cover" onError={(e)=>{e.target.src='https://img.icons8.com/ios-glyphs/90/9bf364/broken-image.png'}} /><button onClick={()=>setMedia(null)} className="absolute top-0 right-0 bg-red-500 w-5 h-5 flex items-center justify-center text-xs">×</button></div>}
                        <div className="flex justify-between items-center">
                            <div className="flex gap-2">
                                <label className="text-[#9bf364] text-xs cursor-pointer hover:bg-white/10 px-2 py-1 rounded flex items-center gap-1"><i className="fas fa-photo-video"></i> {loading ? 'Uploading...' : (media ? 'Ready' : 'Media')} <input id="fileUpload" type="file" hidden accept="image/*,video/*" onChange={handleFile}/></label>
                                <button onClick={handleAIDraft} disabled={aiLoading} className="text-[#4ed5d2] text-xs hover:bg-cyan-900/30 px-2 py-1 rounded border border-[#4ed5d2]/30"><i className={`fas fa-magic ${aiLoading ? 'fa-spin' : ''}`}></i> AI Draft</button>
                                <button onClick={triggerLive} className="text-red-500 text-xs hover:bg-red-900/30 px-2 py-1 rounded border border-red-500/30"><i className="fas fa-broadcast-tower"></i> Live</button>
                            </div>
                            <button onClick={handlePost} disabled={loading} className="text-[#0d0d0d] hybrid-gradient-bg px-4 py-1 rounded text-xs font-bold">{loading?'...':'POST'}</button>
                        </div>
                    </div>
                    <div className="pb-4">{posts.map(p => { const safeLikes = p.likes||[]; const safeComments = p.comments||[]; const isSaved = currentUserData?.savedPosts?.includes(p.id); return (
                        <div key={p.id} className={`mb-4 border-b border-[#1e251f] bg-[#0d0d0d] ${p.isSystem ? 'border border-[#9bf364]/30' : ''}`}>
                            <div className="flex items-center justify-between p-3">
                                <div className="flex items-center gap-3 cursor-pointer" onClick={()=>goToProfile(p.uid)}>
                                    <div className="relative"><img src={p.avatar} className="w-8 h-8 rounded-full border border-gray-700 object-cover" onError={(e)=>{e.target.src='https://api.dicebear.com/9.x/bottts-neutral/svg?seed=fallback'}}/>{p.isSystem && <i className="fas fa-shield-alt absolute -bottom-1 -right-1 text-[#9bf364] text-[10px]"></i>}</div>
                                    <div><div className={`text-sm ${p.isSystem ? 'text-[#9bf364] font-bold font-mono' : 'text-white font-bold'}`}>{p.author}</div><div className="text-[10px] text-gray-500">{formatTime(p.createdAt)}</div></div>
                                </div>
                                {p.uid === user.uid && <button onClick={()=>handleDeletePost(p.id)} className="text-gray-600 hover:text-red-500"><i className="fas fa-trash"></i></button>}
                            </div>
                            {p.image && (p.mediaType === 'video' ? <div className="w-full bg-[#1e251f] relative"><video controls src={p.image} className="w-full max-h-[400px] object-cover"/></div> : <div className="w-full bg-[#1e251f] relative"><img src={p.image} className="w-full max-h-[400px] object-cover" onError={(e)=>{e.target.style.display='none'; e.target.nextSibling.style.display='flex'}}/><div style={{display:'none'}} className="absolute inset-0 flex items-center justify-center bg-gray-900 text-[#9bf364] text-xs font-bold border border-red-500/30">DATA CORRUPTED</div></div>)}
                            <div className="p-3"><div className={`text-sm mb-2 ${p.isSystem?'text-[#9bf364] font-bold font-mono':'text-gray-300'}`}>{p.text}</div><div className="flex gap-6 text-gray-400 text-lg items-center"><button onClick={()=>handleLike(p, safeLikes)} className={`transition ${safeLikes.includes(user.uid)?'text-[#9bf364]':''}`}><i className={`${safeLikes.includes(user.uid)?'fas':'far'} fa-heart`}></i> <span className="text-xs font-sans">{safeLikes.length}</span></button><button onClick={()=>setCommenting(commenting===p.id?null:p.id)} className="hover:text-[#4ed5d2]"><i className="far fa-comment"></i> <span className="text-xs font-sans">{safeComments.length}</span></button><button onClick={()=>handleSave(p)} className={`ml-auto ${isSaved?'text-[#9bf364]':'text-gray-400'}`}><i className={`${isSaved?'fas':'far'} fa-bookmark`}></i></button></div>{commenting===p.id && (<div className="mt-3 bg-[#1e251f] p-2 rounded animate-fade-in"><div className="max-h-32 overflow-y-auto mb-2 space-y-2">{safeComments.map((c, i) => (<div key={i} className="text-xs text-gray-300 flex justify-between"><span><span className="font-bold text-[#9bf364] mr-2">{c.author}:</span>{c.text} <span className="text-[9px] text-gray-600 ml-1">{formatTime(c.time)}</span></span></div>))}</div><form onSubmit={(e)=>handleComment(e, p)} className="flex gap-2"><input autoFocus value={commentText} onChange={e=>setCommentText(e.target.value)} className="flex-1 bg-transparent border-b border-gray-700 text-xs text-white outline-none placeholder-gray-600" placeholder="Add a comment..." /><button type="submit" className="text-[#9bf364] text-xs font-bold">POST</button></form></div>)}</div>
                        </div>
                    );})}</div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null); const [view, setView] = useState('feed'); const [targetUid, setTargetUid] = useState(null); const [showSearch, setShowSearch] = useState(false); const [currentSong, setCurrentSong] = useState(null); const [isPlaying, setIsPlaying] = useState(false); const audioRef = useRef(new Audio());
            const [showReels, setShowReels] = useState(false);
            const [isLive, setIsLive] = useState(false);
            const [showNotifs, setShowNotifs] = useState(false);

            // Audio Logic with Background Play Support
            const player = { 
                play: (track) => { 
                    setCurrentSong(track); 
                    setIsPlaying(true); 
                    audioRef.current.src = track.audio; 
                    audioRef.current.play().catch(e=>console.log("Autoplay blocked")); 
                }, 
                toggle: () => { 
                    if(isPlaying){ audioRef.current.pause(); setIsPlaying(false); } 
                    else { audioRef.current.play(); setIsPlaying(true); } 
                }, 
                song: currentSong 
            };

            useEffect(() => { if(!window.fb) return; const unsub = window.fb.fns.onAuthStateChanged(window.fb.auth, u => setUser(u)); return () => unsub(); }, []);
            const goToProfile = (uid) => { setTargetUid(uid); setView('profile'); }; const startChat = (uid) => { setTargetUid(uid); setView('chat_private'); };
            if(!user) return <Auth setUser={setUser} />;
            return (
                <AppContext.Provider value={{ user, player }}>
                    <div className="w-full h-screen bg-[#0d0d0d] flex items-center justify-center">
                        <div className="w-full h-full md:max-w-md md:h-[90vh] md:rounded-[3rem] md:border-[8px] md:border-[#1e251f] bg-[#0d0d0d] flex flex-col relative shadow-2xl overflow-hidden">
                            <header className="h-14 flex items-center justify-between px-4 glass z-30 relative shrink-0 border-b border-[#0e6011]">
                                <div className="flex items-center gap-2"><div className="w-8 h-8"><HybridLogo size={40} /></div><h1 className="text-lg font-bold brand-font text-white tracking-widest hybrid-gradient-text">CRYPTINITY</h1></div>
                                <div className="flex gap-4"><button onClick={()=>setShowNotifs(true)}><i className="fas fa-bell text-gray-400 hover:text-white"></i></button><button onClick={()=>setShowSearch(true)}><i className="fas fa-search text-gray-400 hover:text-white"></i></button><button onClick={()=>setView('inbox')}><i className="fab fa-facebook-messenger text-gray-400 hover:text-white"></i></button><button onClick={()=>setView('settings')}><i className="fas fa-sliders-h text-gray-400 hover:text-white"></i></button></div>
                            </header>
                            
                            {showSearch && <Search close={()=>setShowSearch(false)} goToProfile={goToProfile} />}
                            {showReels && <ReelsView user={user} close={()=>setShowReels(false)} />}
                            {isLive && <LiveMode user={user} close={()=>setIsLive(false)} />}
                            {showNotifs && <NotificationPanel user={user} close={()=>setShowNotifs(false)} goToProfile={goToProfile}/>}
                            <CallManager user={user} />

                            <main className="flex-1 overflow-hidden relative">
                                {view === 'feed' && <Social user={user} goToProfile={goToProfile} toggleReels={()=>setShowReels(true)} triggerLive={()=>setIsLive(true)} />}
                                {view === 'mining' && <Mining user={user} />}
                                {view === 'apps' && <AppsHub openApp={setView} />}
                                {view === 'oracle' && <OracleApp goBack={()=>setView('apps')} />}
                                {view === 'groups' && <GroupsApp user={user} goBack={()=>setView('apps')} />}
                                {view === 'warehouse' && <WarehouseApp user={user} goBack={()=>setView('apps')} />}
                                {view === 'music' && <Music player={player} />}
                                {view === 'docs' && <DocsApp goBack={()=>setView('apps')} />}
                                {view === 'settings' && <Settings user={user} />}
                                {view === 'profile' && <Profile currentUser={user} targetUid={targetUid} startChat={startChat} player={player} />}
                                {view === 'chat_private' && <PrivateChat user={user} targetUid={targetUid} goBack={()=>setView(targetUid ? 'profile' : 'inbox')} />}
                                {view === 'inbox' && <MessengerList user={user} goToChat={startChat} goBack={()=>setView('feed')} />}
                            </main>

                            <div className={`absolute bottom-[60px] left-0 right-0 bg-[#1e251f] border-t border-[#0e6011] p-2 z-20 flex items-center gap-3 transition-transform ${currentSong?'translate-y-0':'translate-y-20'}`}>
                                <img src={currentSong?.image} className={`w-10 h-10 rounded ${isPlaying?'animate-spin':''}`} style={{animationDuration:'5s'}}/>
                                <div className="flex-1 min-w-0"><div className="text-white text-xs font-bold truncate">{currentSong?.name}</div></div>
                                <button onClick={player.toggle} className="text-[#9bf364] text-xl px-2"><i className={`fas fa-${isPlaying?'pause':'play'}`}></i></button>
                            </div>

                            <nav className="h-16 bg-[#0d0d0d] border-t border-[#0e6011] grid grid-cols-5 items-center z-30 pb-safe shrink-0">
                                {[{id:'feed',i:'home',l:'Home'},{id:'mining',i:'bolt',l:'Mine'},{id:'apps',i:'th',l:'Apps'},{id:'music',i:'music',l:'Music'},{id:'profile',i:'user',l:'Me'}].map(t => (
                                    <button key={t.id} onClick={()=>{ setTargetUid(null); setView(t.id); }} className={`flex flex-col items-center gap-1 ${view===t.id ? 'text-[#9bf364]' : 'text-gray-600'}`}>
                                        <div className={`text-xl ${view===t.id && t.id==='mining' ? 'animate-pulse' : ''}`}><i className={`fas fa-${t.i}`}></i></div>
                                        <span className="text-[9px] uppercase font-bold tracking-wider">{t.l}</span>
                                    </button>
                                ))}
                            </nav>
                        </div>
                    </div>
                </AppContext.Provider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>