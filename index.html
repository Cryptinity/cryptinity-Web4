<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CRYPTINITY | Web4 Hybrid OS</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;600;700&display=swap" rel="stylesheet">

    <!-- FIREBASE INIT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, getDoc, limit, where, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8FWRzYUnP8Q475Lb6KCqb-Ag9J4txgfM",
            authDomain: "cryptinity-web4-v01.firebaseapp.com",
            projectId: "cryptinity-web4-v01",
            storageBucket: "cryptinity-web4-v01.firebasestorage.app",
            messagingSenderId: "431735391458",
            appId: "1:431735391458:web:0b3280efb230ef36870abb",
            measurementId: "G-TWY5X0K9VP"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.fb = { 
                auth: getAuth(app), 
                db: getFirestore(app),
                fns: { 
                    signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, 
                    collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, getDoc, limit, where, arrayUnion, arrayRemove, deleteDoc
                } 
            };
            console.log("Web4 Node Initialized");
        } catch(e) { console.error("Firebase Error:", e); }
    </script>

    <style>
        :root { --neon: #39ff14; --dark: #020202; --panel: rgba(12, 12, 12, 0.95); }
        body { font-family: 'Rajdhani', sans-serif; background-color: var(--dark); color: #e0e0e0; overflow: hidden; overscroll-behavior: none; touch-action: manipulation; }
        .brand-font { font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        .glass { background: var(--panel); backdrop-filter: blur(12px); border: 1px solid rgba(57, 255, 20, 0.15); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .neon-border { border: 1px solid var(--neon); box-shadow: 0 0 10px rgba(57, 255, 20, 0.3); }
        .neon-text { text-shadow: 0 0 8px rgba(57, 255, 20, 0.6); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .spot-bg { position: absolute; inset: 0; overflow: hidden; pointer-events: none; z-index: 0; }
        .spot { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.15; animation: spotMove 20s infinite alternate; }
        @keyframes spotMove { 0% { transform: translate(0,0) scale(1); } 100% { transform: translate(30px, -30px) scale(1.2); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useContext, createContext } = React;
        const AppContext = createContext();

        const formatTime = (timestamp) => {
            if (!timestamp) return "Just now";
            const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
            const now = new Date();
            const diff = (now - date) / 1000; 
            if (diff < 60) return "Just now";
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        };

        // --- IMAGE COMPRESSOR (CRITICAL FIX) ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // Resize logic
                        const maxWidth = 800; 
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); // Compress to 60% quality
                    };
                };
            });
        };

        const fileToDataURL = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        };

        const callGemini = async (prompt, systemPrompt) => {
            const systemKey = "AIzaSyCollQIyk7t_oy82278mF3ChsyzYr0CNIA"; 
            const userKey = localStorage.getItem('cryptinity_ai_key'); 
            const apiKey = userKey || systemKey;
            if (!apiKey) return "⚠️ NEURAL OFFLINE.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "System Error";
            } catch (error) { return "Connection Fault"; }
        };

        const HybridLogo = ({ size = 200, active = true }) => {
            const mountRef = useRef(null);
            useEffect(() => {
                if(!mountRef.current || !window.THREE) return;
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
                camera.position.z = 8;
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(size, size);
                renderer.setPixelRatio(window.devicePixelRatio);
                mountRef.current.innerHTML = '';
                mountRef.current.appendChild(renderer.domElement);
                const geometry = new THREE.TorusKnotGeometry(1.5, 0.4, 150, 8, 2, 3);
                const coreMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
                const core = new THREE.Mesh(geometry, coreMat);
                core.material.polygonOffset = true; core.material.polygonOffsetFactor = 1;
                const wireMat = new THREE.MeshBasicMaterial({ color: 0x39ff14, wireframe: true, transparent: true, opacity: 1 });
                const wire = new THREE.Mesh(geometry, wireMat);
                const group = new THREE.Group(); group.add(core); group.add(wire); scene.add(group);
                const animate = () => {
                    if(!mountRef.current) return;
                    requestAnimationFrame(animate);
                    if(active) { group.rotation.y += 0.015; group.rotation.x += 0.005; }
                    renderer.render(scene, camera);
                };
                animate();
                return () => { renderer.dispose(); };
            }, [size, active]);
            return <div ref={mountRef} className="filter drop-shadow-[0_0_15px_rgba(57,255,20,0.6)]" />;
        };

        const Auth = ({ setUser }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [loading, setLoading] = useState(false);
            const [form, setForm] = useState({email:'', pass:'', name:''});
            const handleAuth = async (e) => {
                e.preventDefault(); if(!window.fb) return alert("System Initializing...");
                setLoading(true); const { auth, db, fns } = window.fb;
                try {
                    let userCred;
                    if(isLogin) { userCred = await fns.signInWithEmailAndPassword(auth, form.email, form.pass); } 
                    else {
                        userCred = await fns.createUserWithEmailAndPassword(auth, form.email, form.pass);
                        const robotAvatar = `https://api.dicebear.com/9.x/bottts-neutral/svg?seed=${userCred.user.uid}`;
                        await fns.updateProfile(userCred.user, { displayName: form.name, photoURL: robotAvatar });
                        await fns.setDoc(fns.doc(db, "users", userCred.user.uid), {
                            displayName: form.name, email: form.email, joined: fns.serverTimestamp(),
                            avatar: robotAvatar, cover: "#39ff14", bio: "Web4 Early Adopter",
                            anthem: null, followers: [], following: [], verified: false, balance: 0.00000000,
                            settings: { notifications: true, privacy: false, security: true }, visitors: []
                        });
                    }
                    setUser(userCred.user);
                } catch(err) { alert(err.message); }
                setLoading(false);
            };
            return (
                <div className="h-screen w-full bg-black flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('https://media.giphy.com/media/U3qYN8S0j3bpK/giphy.gif')] opacity-10 bg-cover pointer-events-none"></div>
                    <div className="z-10 w-full max-w-sm flex flex-col items-center">
                        <HybridLogo size={180} />
                        <h1 className="text-3xl font-bold text-white brand-font mt-4 tracking-widest neon-text">CRYPTINITY</h1>
                        <p className="text-[#39ff14] text-[10px] tracking-[0.4em] uppercase font-bold mb-8">Web4 Hybrid OS</p>
                        <div className="glass w-full p-6 rounded-2xl border-t border-[#39ff14]">
                            <form onSubmit={handleAuth} className="space-y-4">
                                {!isLogin && <input required placeholder="Display Name" className="w-full bg-black/60 border border-gray-800 rounded p-3 text-white outline-none focus:border-[#39ff14]" onChange={e=>setForm({...form, name:e.target.value})} />}
                                <input required type="email" placeholder="Email Access ID" className="w-full bg-black/60 border border-gray-800 rounded p-3 text-white outline-none focus:border-[#39ff14]" onChange={e=>setForm({...form, email:e.target.value})} />
                                <input required type="password" placeholder="Passkey" className="w-full bg-black/60 border border-gray-800 rounded p-3 text-white outline-none focus:border-[#39ff14]" onChange={e=>setForm({...form, pass:e.target.value})} />
                                <button type="submit" className="w-full py-3 bg-[#39ff14] text-black font-bold brand-font rounded hover:bg-white transition flex justify-center shadow-[0_0_15px_rgba(57,255,20,0.4)]">{loading ? 'INITIALIZING...' : (isLogin ? 'INITIALIZE' : 'CREATE WEB4 ID')}</button>
                            </form>
                            <button onClick={()=>setIsLogin(!isLogin)} className="w-full mt-4 text-xs text-gray-500 hover:text-[#39ff14] transition">{isLogin ? 'Request New Identity' : 'Access Existing Node'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const CallManager = ({ user }) => {
            const [incomingCall, setIncomingCall] = useState(null);
            const [activeCall, setActiveCall] = useState(null);
            const [callStatus, setCallStatus] = useState("Connecting...");
            useEffect(() => {
                if(!user) return;
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "calls"), window.fb.fns.where("to", "==", user.uid), window.fb.fns.where("status", "==", "ringing"));
                const unsub = window.fb.fns.onSnapshot(q, snap => {
                    if(!snap.empty) { const callData = snap.docs[0].data(); setIncomingCall({ id: snap.docs[0].id, ...callData }); } else { setIncomingCall(null); }
                });
                return () => unsub();
            }, [user]);
            const acceptCall = async () => { if(!incomingCall) return; await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "calls", incomingCall.id), { status: "connected" }); setActiveCall(incomingCall); setIncomingCall(null); setCallStatus("Connected via Secure Neural Link"); };
            const declineCall = async () => {
                if(incomingCall) { await window.fb.fns.deleteDoc(window.fb.fns.doc(window.fb.db, "calls", incomingCall.id)); setIncomingCall(null); }
                if(activeCall) { try { await window.fb.fns.deleteDoc(window.fb.fns.doc(window.fb.db, "calls", activeCall.id)); } catch(e){} setActiveCall(null); }
            };
            if(incomingCall) {
                return (
                    <div className="absolute inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center p-6 animate-fade-in">
                        <div className="w-32 h-32 rounded-full border-4 border-[#39ff14] overflow-hidden mb-4 animate-pulse"><img src={incomingCall.callerAvatar} className="w-full h-full object-cover"/></div>
                        <h2 className="text-2xl text-white font-bold mb-2">{incomingCall.callerName}</h2><p className="text-[#39ff14] animate-pulse mb-10">INCOMING ENCRYPTED CALL...</p>
                        <div className="flex gap-8"><button onClick={declineCall} className="w-16 h-16 rounded-full bg-red-500 text-white flex items-center justify-center text-2xl"><i className="fas fa-phone-slash"></i></button><button onClick={acceptCall} className="w-16 h-16 rounded-full bg-[#39ff14] text-black flex items-center justify-center text-2xl animate-bounce"><i className="fas fa-phone"></i></button></div>
                    </div>
                );
            }
            if(activeCall) {
                return (
                    <div className="absolute inset-0 z-[100] bg-gray-900 flex flex-col">
                        <div className="flex-1 relative"><img src={activeCall.callerAvatar} className="w-full h-full object-cover opacity-50"/><div className="absolute inset-0 flex items-center justify-center"><div className="text-[#39ff14] font-mono">{callStatus}</div></div><div className="absolute top-4 right-4 w-24 h-32 bg-black border border-[#39ff14] rounded overflow-hidden"><img src={user.photoURL} className="w-full h-full object-cover"/></div></div>
                        <div className="h-24 bg-black flex items-center justify-center gap-6"><button className="p-4 bg-gray-800 rounded-full text-white"><i className="fas fa-microphone-slash"></i></button><button onClick={declineCall} className="p-4 bg-red-500 rounded-full text-white text-xl"><i className="fas fa-phone-slash"></i></button><button className="p-4 bg-gray-800 rounded-full text-white"><i className="fas fa-video-slash"></i></button></div>
                    </div>
                );
            }
            return null;
        };

        const Search = ({ close, goToProfile }) => {
            const [queryStr, setQueryStr] = useState(""); const [results, setResults] = useState([]);
            useEffect(() => { if(queryStr.length < 3) { setResults([]); return; } const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "users"), window.fb.fns.where("displayName", ">=", queryStr), window.fb.fns.where("displayName", "<=", queryStr + '\uf8ff'), window.fb.fns.limit(5)); const unsub = window.fb.fns.onSnapshot(q, snap => { setResults(snap.docs.map(d => ({...d.data(), uid: d.id}))); }); return () => unsub(); }, [queryStr]);
            return (
                <div className="absolute inset-0 bg-black/95 z-50 p-4 animate-fade-in">
                    <div className="flex gap-3 mb-6"><input autoFocus value={queryStr} onChange={e=>setQueryStr(e.target.value)} placeholder="Search Nodes..." className="flex-1 bg-gray-900 border border-[#39ff14] rounded-full px-4 py-2 text-white outline-none" /><button onClick={close} className="text-gray-400">Cancel</button></div>
                    <div className="space-y-3">{results.map(r => (<div key={r.uid} onClick={()=>{ goToProfile(r.uid); close(); }} className="flex items-center gap-3 p-3 glass rounded-xl cursor-pointer hover:border-[#39ff14]"><img src={r.avatar} className="w-10 h-10 rounded-full object-cover" /><div><div className="text-white font-bold text-sm">{r.displayName}</div><div className="text-gray-500 text-xs">User Node</div></div></div>))}</div>
                </div>
            );
        };

        const Social = ({ user, goToProfile }) => {
            const [posts, setPosts] = useState([]); const [newPost, setNewPost] = useState(""); const [media, setMedia] = useState(null); const [loading, setLoading] = useState(false); const [aiLoading, setAiLoading] = useState(false); const [commenting, setCommenting] = useState(null); const [commentText, setCommentText] = useState("");
            useEffect(() => { const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "posts"), window.fb.fns.orderBy("createdAt", "desc"), window.fb.fns.limit(40)); const unsub = window.fb.fns.onSnapshot(q, (snap) => { setPosts(snap.docs.map(d => ({...d.data(), id: d.id}))); }); return () => unsub(); }, []);
            
            const handleFile = async (e) => {
                const f = e.target.files[0]; if(!f) return;
                // If it's an image, use compression
                if (f.type.startsWith('image')) {
                    const b64 = await compressImage(f);
                    setMedia({ url: b64, type: 'image' });
                } else if (f.type.startsWith('video')) {
                    if(f.size > 1000000) return alert("Video too large! Max 1MB.");
                    const b64 = await fileToDataURL(f);
                    setMedia({ url: b64, type: 'video' });
                }
            };

            const handleAIDraft = async () => { if (aiLoading) return; setAiLoading(true); const topic = newPost || "the future of web4"; const draft = await callGemini(`Topic: ${topic}`, "Write a short, cyberpunk social post. Use emojis."); setNewPost(draft); setAiLoading(false); };
            const handlePost = async (e) => { e.preventDefault(); if(!newPost.trim() && !media) return; setLoading(true); await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "posts"), { author: user.displayName, avatar: user.photoURL, uid: user.uid, text: newPost, image: media ? media.url : null, mediaType: media ? media.type : 'image', createdAt: window.fb.fns.serverTimestamp(), likes: [], comments: [] }); setNewPost(""); setMedia(null); setLoading(false); };
            const handleLike = async (postId, likes) => { const ref = window.fb.fns.doc(window.fb.db, "posts", postId); const safeLikes = Array.isArray(likes) ? likes : []; const hasLiked = safeLikes.includes(user.uid); await window.fb.fns.updateDoc(ref, { likes: hasLiked ? safeLikes.filter(id=>id!==user.uid) : [...safeLikes, user.uid] }); };
            const handleComment = async (e, postId) => { e.preventDefault(); if(!commentText.trim()) return; await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "posts", postId), { comments: window.fb.fns.arrayUnion({ text: commentText, author: user.displayName, uid: user.uid, time: Date.now() }) }); setCommentText(""); };
            const handleShare = async (post) => { if(confirm("Reshare to your feed?")) { await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "posts"), { author: user.displayName, avatar: user.photoURL, uid: user.uid, text: `Shared via Neural Link: "${post.text}"`, image: post.image, mediaType: post.mediaType, createdAt: window.fb.fns.serverTimestamp(), likes: [], comments: [] }); } };

            return (
                <div className="h-full overflow-y-auto pb-24 bg-black">
                    <div className="p-4 border-b border-gray-900 bg-gray-900/30">
                        <div className="flex gap-3 mb-2"><img src={user.photoURL} className="w-10 h-10 rounded-full border border-[#39ff14]"/><textarea value={newPost} onChange={e=>setNewPost(e.target.value)} placeholder="Broadcast to Web4..." className="flex-1 bg-transparent text-white outline-none text-sm resize-none h-10 pt-2"></textarea></div>
                        {media && <div className="mb-2 relative w-20 h-20 bg-gray-800 rounded overflow-hidden"><img src={media.url} className="w-full h-full object-cover"/><button onClick={()=>setMedia(null)} className="absolute top-0 right-0 bg-red-500 w-5 h-5 flex items-center justify-center text-xs">×</button></div>}
                        <div className="flex justify-between items-center"><div className="flex gap-2"><label className="text-[#39ff14] text-xs cursor-pointer hover:bg-white/10 px-2 py-1 rounded"><i className="fas fa-photo-video"></i> Media <input type="file" hidden accept="image/*,video/*" onChange={handleFile}/></label><button onClick={handleAIDraft} disabled={aiLoading} className="text-cyan-400 text-xs hover:bg-cyan-900/30 px-2 py-1 rounded border border-cyan-400/30"><i className={`fas fa-magic ${aiLoading ? 'fa-spin' : ''}`}></i> AI Draft</button></div><button onClick={handlePost} disabled={loading} className="text-black bg-[#39ff14] px-4 py-1 rounded text-xs font-bold">{loading?'...':'POST'}</button></div>
                    </div>
                    <div className="pb-4">{posts.map(p => { const safeLikes = p.likes||[]; const safeComments = p.comments||[]; return (
                        <div key={p.id} className={`mb-4 border-b border-gray-900 bg-black ${p.isSystem ? 'border border-[#39ff14]/30' : ''}`}>
                            <div className="flex items-center justify-between p-3"><div className="flex items-center gap-3 cursor-pointer" onClick={()=>goToProfile(p.uid)}><div className="relative"><img src={p.avatar} className="w-8 h-8 rounded-full border border-gray-700 object-cover"/>{p.isSystem && <i className="fas fa-shield-alt absolute -bottom-1 -right-1 text-[#39ff14] text-[10px]"></i>}</div><div><div className={`text-sm font-bold ${p.isSystem ? 'text-[#39ff14]' : 'text-white'}`}>{p.author}</div><div className="text-[10px] text-gray-500">{formatTime(p.createdAt)}</div></div></div></div>
                            {p.image && <div className="w-full bg-gray-900 relative">{p.mediaType==='video'?<video controls src={p.image} className="w-full max-h-[400px] object-cover"/>:<img src={p.image} className="w-full max-h-[400px] object-cover"/>}</div>}
                            <div className="p-3"><div className="text-sm text-gray-300 mb-2"><span className={`font-bold mr-2 ${p.isSystem ? 'text-[#39ff14]': 'text-white'}`}>{p.author}</span>{p.text}</div><div className="flex gap-6 text-gray-400 text-lg items-center"><button onClick={()=>handleLike(p.id, safeLikes)} className={`transition ${safeLikes.includes(user.uid)?'text-[#39ff14]':''}`}><i className={`${safeLikes.includes(user.uid)?'fas':'far'} fa-heart`}></i> <span className="text-xs font-sans">{safeLikes.length}</span></button><button onClick={()=>setCommenting(commenting===p.id?null:p.id)} className="hover:text-blue-400"><i className="far fa-comment"></i> <span className="text-xs font-sans">{safeComments.length}</span></button><button onClick={()=>handleShare(p)} className="hover:text-white"><i className="far fa-share-square"></i></button></div>{commenting===p.id && (<div className="mt-3 bg-gray-900/50 p-2 rounded animate-fade-in"><div className="max-h-32 overflow-y-auto mb-2 space-y-2">{safeComments.map((c, i) => (<div key={i} className="text-xs text-gray-300"><span className="font-bold text-[#39ff14] mr-2">{c.author}:</span>{c.text} <span className="text-[9px] text-gray-600 ml-1">{formatTime(c.time)}</span></div>))}</div><form onSubmit={(e)=>handleComment(e, p.id)} className="flex gap-2"><input autoFocus value={commentText} onChange={e=>setCommentText(e.target.value)} className="flex-1 bg-transparent border-b border-gray-700 text-xs text-white outline-none" placeholder="Add a comment..." /><button type="submit" className="text-[#39ff14] text-xs font-bold">POST</button></form></div>)}</div>
                        </div>
                    );})}</div>
                </div>
            );
        };

        // --- MINING FIX ---
        const Mining = ({ user }) => {
            const [active, setActive] = useState(false);
            const [balance, setBalance] = useState(0);
            const [loaded, setLoaded] = useState(false);
            const [countdown, setCountdown] = useState("");
            const balanceRef = useRef(0);

            // 1. Fetch Once and Set Ref
            useEffect(() => {
                if(!user) return;
                const unsub = window.fb.fns.onSnapshot(window.fb.fns.doc(window.fb.db, "users", user.uid), (doc) => {
                    if(doc.exists()) {
                        const val = parseFloat(doc.data().balance) || 0;
                        // Only set initial if not active to prevent overwrite loops
                        if(!active && !loaded) {
                            balanceRef.current = val;
                            setBalance(val);
                            setLoaded(true);
                        }
                    }
                });
                return () => unsub();
            }, [user, active, loaded]);

            // 2. Mining Logic (Only memory)
            useEffect(() => {
                let interval;
                if(active) {
                    interval = setInterval(() => {
                        balanceRef.current += 0.00000012;
                        setBalance(balanceRef.current);
                    }, 100);
                }
                return () => clearInterval(interval);
            }, [active]);

            // 3. Save Logic (Interval)
            useEffect(() => {
                const saveInt = setInterval(() => {
                    if(active && loaded) {
                        window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", user.uid), {
                            balance: balanceRef.current
                        });
                    }
                }, 3000); // Save every 3s
                return () => clearInterval(saveInt);
            }, [active, loaded, user]);

            useEffect(() => {
                // Fixed Date: Jan 25, 2026
                const targetDate = new Date("2026-01-25T00:00:00").getTime();
                const t = setInterval(() => { 
                    const now = Date.now(); const d = targetDate - now; if(d < 0) return; 
                    const days = Math.floor(d/(1000*60*60*24)); const hours = Math.floor((d%(1000*60*60*24))/(1000*60*60)); const mins = Math.floor((d%(1000*60*60))/(1000*60)); const secs = Math.floor((d%(1000*60))/1000); 
                    setCountdown(`${days}d ${hours}h ${mins}m ${secs}s`); 
                }, 1000);
                return () => clearInterval(t);
            }, []);

            return (
                <div className="h-full overflow-y-auto pb-24 relative flex flex-col items-center p-4">
                    <div className="spot-bg"><div className="spot w-80 h-80 top-0 left-0 bg-[#39ff14]"></div><div className="spot w-80 h-80 bottom-0 right-0 bg-blue-600"></div></div>
                    <h2 className="text-2xl font-bold brand-font text-white mb-2 z-10 mt-4 tracking-widest">CLOUD <span className="text-[#39ff14]">MINING</span></h2>
                    <div className="z-10 bg-black/50 border border-[#39ff14]/50 rounded-full px-4 py-1 mb-4"><span className="text-white text-xs font-mono">1 CTY = <span className="text-[#39ff14] font-bold">$0.0004</span></span></div>
                    <div className={`transition-all duration-700 z-10 mb-8 ${active ? 'scale-110 drop-shadow-[0_0_30px_#39ff14]' : 'opacity-80 grayscale'}`}><HybridLogo size={220} active={active} /></div>
                    <div className="glass w-full rounded-2xl p-6 border-t border-[#39ff14] z-10 relative mb-4">
                        <div className="flex justify-between items-center mb-6"><div><div className="text-[10px] uppercase text-gray-500">Mined (Locked)</div><div className="text-3xl font-mono text-white tracking-widest">{loaded ? balance.toFixed(8) : "SYNCING..."} <span className="text-[#39ff14] text-sm">CTY</span></div></div><div className="text-right"><div className="text-[10px] uppercase text-gray-500">Active Miners</div><div className="font-bold text-[#39ff14] animate-pulse">98,104,530</div></div></div>
                        <div className="text-center mb-6"><div className="text-[9px] text-[#39ff14] uppercase tracking-[0.3em] mb-1">Launch Countdown</div><div className="text-2xl font-mono text-white font-bold">{countdown}</div></div>
                        <button onClick={()=>setActive(!active)} className={`w-full py-4 rounded-xl font-bold brand-font text-sm tracking-widest transition ${active ? 'bg-red-900/40 text-red-500 border border-red-500' : 'bg-[#39ff14] text-black hover:bg-white'}`}>{active ? 'HALT MINING SEQUENCE' : 'ACTIVATE CLOUD NODE'}</button>
                    </div>
                    <div className="w-full glass p-4 rounded-xl z-10 border border-gray-800 space-y-4">
                         <div className="text-[#39ff14] text-xs font-bold uppercase"><i className="fas fa-wallet mr-2"></i> Withdrawal Configuration</div>
                         <div><label className="text-[10px] text-gray-500 uppercase">CTY Wallet Address</label><div className="flex bg-black border border-gray-700 rounded p-2 items-center"><input placeholder="Enter your CTY Address..." className="flex-1 bg-transparent text-xs text-white outline-none font-mono"/><i className="fas fa-qrcode text-gray-500"></i></div></div>
                         <div><label className="text-[10px] text-gray-500 uppercase">Network</label><select className="w-full bg-black border border-gray-700 rounded p-2 text-xs text-white outline-none"><option>Web4 Chain (Native) - 0 Fee</option><option>Binance Smart Chain (BEP20)</option><option>Ethereum (ERC20)</option><option>Tron (TRC20)</option></select></div>
                         <div className="flex gap-4"><div className="flex-1 bg-black/50 border border-gray-800 p-2 rounded"><div className="text-[9px] text-gray-500">Min Withdrawal</div><div className="text-white font-mono text-xs">500 CTY</div></div><div className="flex-1 bg-black/50 border border-gray-800 p-2 rounded"><div className="text-[9px] text-gray-500">Max Withdrawal</div><div className="text-white font-mono text-xs">50,000 CTY</div></div></div>
                         <button className="w-full bg-gray-800 text-gray-500 font-bold py-3 rounded text-xs uppercase cursor-not-allowed">Withdrawal Locked Until Launch</button>
                    </div>
                </div>
            );
        };

        const WarehouseApp = ({ user, goBack }) => {
            const [view, setView] = useState('all'); const [files, setFiles] = useState([]);
            useEffect(() => { 
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "warehouse"), window.fb.fns.where("uid", "==", user.uid)); 
                const unsub = window.fb.fns.onSnapshot(q, snap => {
                    const data = snap.docs.map(d => ({...d.data(), id: d.id}));
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setFiles(data);
                }); 
                return () => unsub(); 
            }, [user]);

            const handleUpload = async (e) => {
                const f = e.target.files[0]; if(!f) return;
                let b64 = null;
                if(f.type.startsWith('image')) {
                    b64 = await compressImage(f);
                } else {
                    if(f.size > 500000) return alert("File too large! Max 500KB for Docs/Files.");
                    b64 = await fileToDataURL(f);
                }
                let type = 'file';
                if(f.type.startsWith('image')) type = 'photo';
                if(f.type.includes('pdf') || f.type.includes('text')) type = 'ebook';
                await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "warehouse"), { name: f.name, data: b64, type, uid: user.uid, createdAt: window.fb.fns.serverTimestamp() });
            };
            const deleteFile = async (id) => { if(confirm("Delete file?")) await window.fb.fns.deleteDoc(window.fb.fns.doc(window.fb.db, "warehouse", id)); };
            const filtered = view === 'all' ? files : files.filter(f => f.type === view);
            return (
                <div className="h-full bg-black p-4 flex flex-col">
                    <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><button onClick={goBack} className="text-gray-400"><i className="fas fa-arrow-left"></i></button><h2 className="text-xl font-bold text-white brand-font">WARE<span className="text-[#39ff14]">HOUSE</span></h2></div><label className="bg-[#39ff14] text-black px-3 py-1 rounded text-xs font-bold cursor-pointer">+ UPLOAD<input type="file" hidden onChange={handleUpload}/></label></div>
                    <div className="flex gap-2 mb-4 overflow-x-auto"><button onClick={()=>setView('all')} className={`px-3 py-1 rounded-full text-xs font-bold border ${view==='all'?'bg-white text-black':'text-gray-400 border-gray-800'}`}>ALL</button><button onClick={()=>setView('photo')} className={`px-3 py-1 rounded-full text-xs font-bold border ${view==='photo'?'bg-white text-black':'text-gray-400 border-gray-800'}`}>PHOTOS</button><button onClick={()=>setView('ebook')} className={`px-3 py-1 rounded-full text-xs font-bold border ${view==='ebook'?'bg-white text-black':'text-gray-400 border-gray-800'}`}>EBOOKS</button></div>
                    <div className="grid grid-cols-2 gap-3 overflow-y-auto pb-20">
                        {filtered.map(f => (
                            <div key={f.id} className="glass p-2 rounded-xl relative group">
                                <button onClick={()=>deleteFile(f.id)} className="absolute top-1 right-1 bg-red-500/80 text-white w-5 h-5 rounded flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">x</button>
                                {f.type==='photo' ? <img src={f.data} className="w-full h-24 object-cover rounded mb-2"/> : <div className="w-full h-24 bg-gray-900 rounded mb-2 flex items-center justify-center text-2xl text-gray-600"><i className={`fas fa-${f.type==='ebook'?'book':'file'}`}></i></div>}
                                <div className="text-white text-xs truncate font-bold">{f.name}</div>
                                <a href={f.data} download={f.name} className="block text-center text-[#39ff14] text-[10px] mt-1 border border-[#39ff14]/30 rounded py-1 hover:bg-[#39ff14]/10">DOWNLOAD</a>
                            </div>
                        ))}
                        {filtered.length===0 && <div className="col-span-2 text-center text-gray-600 mt-10">Vault Empty</div>}
                    </div>
                </div>
            );
        };

        const OracleApp = ({ goBack }) => {
            const [msgs, setMsgs] = useState([{ sender: 'ai', text: 'Greetings. I am The Oracle. Ask me anything.' }]); const [input, setInput] = useState(''); const [loading, setLoading] = useState(false); const scrollRef = useRef();
            const send = async (e) => { e.preventDefault(); if (!input.trim() || loading) return; const userMsg = input; setMsgs(p => [...p, { sender: 'user', text: userMsg }]); setInput(''); setLoading(true); const reply = await callGemini(userMsg, "You are 'The Oracle', the AI core of Cryptinity. Cyberpunk style. Concise."); setMsgs(p => [...p, { sender: 'ai', text: reply }]); setLoading(false); };
            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [msgs]);
            return (<div className="h-full flex flex-col bg-black pb-24"><div className="p-4 border-b border-gray-800 flex items-center gap-3"><button onClick={goBack} className="text-[#39ff14]"><i className="fas fa-arrow-left"></i></button><h2 className="text-white font-bold brand-font text-sm">THE <span className="text-[#39ff14]">ORACLE</span></h2></div><div className="flex-1 overflow-y-auto p-4 space-y-4" ref={scrollRef}>{msgs.map((m, i) => (<div key={i} className={`flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[80%] p-3 rounded-xl text-sm ${m.sender === 'user' ? 'bg-[#39ff14] text-black' : 'glass text-white border border-[#39ff14]/30'}`}>{m.text}</div></div>))}{loading && <div className="text-center text-xs text-[#39ff14] animate-pulse">PROCESSING...</div>}</div><form onSubmit={send} className="p-3 border-t border-gray-800 flex gap-2"><input value={input} onChange={e => setInput(e.target.value)} className="flex-1 bg-gray-900 rounded-full px-4 text-white text-sm outline-none border border-transparent focus:border-[#39ff14]" placeholder="Query the Oracle..." /><button type="submit" className="text-[#39ff14] font-bold px-2"><i className="fas fa-paper-plane"></i></button></form></div>);
        };

        const Settings = ({ user }) => {
            const [userSettings, setUserSettings] = useState({ notifications: true, privacy: false, security: true });
            const [apiKey, setApiKey] = useState(localStorage.getItem('cryptinity_ai_key') || '');
            useEffect(() => { window.fb.fns.getDoc(window.fb.fns.doc(window.fb.db, "users", user.uid)).then(d => { if(d.exists() && d.data().settings) setUserSettings(d.data().settings); }); }, [user]);
            const saveKey = (e) => { const val = e.target.value; setApiKey(val); localStorage.setItem('cryptinity_ai_key', val); };
            const toggleSetting = async (key) => { const newVal = !userSettings[key]; const newSet = { ...userSettings, [key]: newVal }; setUserSettings(newSet); await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", user.uid), { settings: newSet }); };
            return (<div className="h-full overflow-y-auto pb-24 bg-black p-4"><h2 className="text-2xl font-bold text-white brand-font mb-6">SYSTEM <span className="text-[#39ff14]">CONTROLS</span></h2><div className="glass p-4 rounded-xl mb-6 border border-cyan-500/30"><div className="flex items-center gap-2 mb-2"><i className="fas fa-brain text-cyan-400"></i><span className="text-white font-bold text-sm">Neural Link (API Key)</span></div><input value={apiKey} onChange={saveKey} placeholder="Enter Gemini API Key..." className="w-full bg-black/50 border border-gray-700 rounded p-2 text-xs text-white outline-none focus:border-cyan-400" /><div className="text-[9px] text-gray-500 mt-1">Required for AI Oracle & Magic Drafts. <a href="https://aistudio.google.com/" target="_blank" className="text-cyan-400 underline">Get Free Key</a></div></div><div className="space-y-4"><div className="glass p-4 rounded-xl flex justify-between items-center"><span className="text-white font-bold">Push Notifications</span><button onClick={()=>toggleSetting('notifications')} className={`w-12 h-6 rounded-full relative transition ${userSettings.notifications?'bg-[#39ff14]':'bg-gray-700'}`}><div className={`absolute top-1 w-4 h-4 bg-black rounded-full transition-all ${userSettings.notifications?'left-7':'left-1'}`}></div></button></div><div className="glass p-4 rounded-xl flex justify-between items-center"><span className="text-white font-bold">Privacy</span><button onClick={()=>toggleSetting('privacy')} className={`w-12 h-6 rounded-full relative transition ${userSettings.privacy?'bg-[#39ff14]':'bg-gray-700'}`}><div className={`absolute top-1 w-4 h-4 bg-black rounded-full transition-all ${userSettings.privacy?'left-7':'left-1'}`}></div></button></div><button onClick={()=>window.fb.fns.signOut(window.fb.auth)} className="w-full py-3 mt-8 border border-red-500 text-red-500 font-bold rounded-xl">TERMINATE SESSION</button></div></div>);
        };

        const DocsApp = ({ goBack }) => {
            const [section, setSection] = useState('whitepaper');
            return (<div className="h-full overflow-y-auto pb-24 bg-black p-4"><div className="flex items-center gap-3 mb-6"><button onClick={goBack} className="text-[#39ff14]"><i className="fas fa-arrow-left"></i></button><h2 className="text-2xl font-bold text-white brand-font">ARCHIVE <span className="text-[#39ff14]">CORE</span></h2></div><div className="flex gap-2 overflow-x-auto mb-6 hide-scroll">{Object.keys(DOCS).map(k => (<button key={k} onClick={()=>setSection(k)} className={`px-4 py-2 rounded-full text-xs font-bold uppercase whitespace-nowrap border ${section===k?'bg-[#39ff14] text-black border-[#39ff14]':'text-gray-400 border-gray-800'}`}>{k}</button>))}</div><div className="glass p-6 rounded-xl border border-gray-800 relative overflow-hidden"><h3 className="text-xl font-bold text-[#39ff14] uppercase mb-4 brand-font">{section}</h3><p className="text-gray-300 text-sm whitespace-pre-wrap leading-relaxed font-mono">{DOCS[section]}</p></div></div>);
        };

        const Profile = ({ currentUser, targetUid, startChat, callUser, player }) => {
            const [data, setData] = useState(null); const [tab, setTab] = useState('posts'); const [isEditingBio, setIsEditingBio] = useState(false); const [bioText, setBioText] = useState(""); const [myPosts, setMyPosts] = useState([]); const uid = targetUid || currentUser.uid; const isMe = uid === currentUser.uid;
            useEffect(() => { const unsub = window.fb.fns.onSnapshot(window.fb.fns.doc(window.fb.db, "users", uid), d => { if(d.exists()) { const ud = d.data(); setData(ud); setBioText(ud.bio || ""); if(ud.anthem && player && player.song?.audio !== ud.anthem) { player.play({ name: `${ud.displayName}'s Anthem`, artist_name: "Web4 User", image: ud.avatar, audio: ud.anthem }); } if (!isMe) { const visitor = { uid: currentUser.uid, name: currentUser.displayName, avatar: currentUser.photoURL, time: Date.now() }; const currentVisitors = ud.visitors || []; if (!currentVisitors.some(v => v.uid === currentUser.uid && Date.now() - v.time < 3600000)) { const newVisitors = [visitor, ...currentVisitors].slice(0, 20); window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", uid), { visitors: newVisitors }); } } } }); return () => unsub(); }, [uid]);
            useEffect(() => { 
                const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "posts"), window.fb.fns.where("uid", "==", uid)); 
                const unsub = window.fb.fns.onSnapshot(q, snap => { 
                    const data = snap.docs.map(d => d.data());
                    data.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    setMyPosts(data); 
                }); 
                return () => unsub(); 
            }, [uid]);
            
            const handleUpload = async (e, field) => { 
                const file = e.target.files[0]; if(!file || !isMe) return; 
                let b64 = null;
                if (field === 'avatar' || field === 'cover') {
                    b64 = await compressImage(file);
                } else {
                    const limit = 2000000;
                    if(file.size > limit) return alert(`Max ${field==='anthem'?'2MB':'2MB'}.`); 
                    b64 = await fileToDataURL(file); 
                }
                
                await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", uid), { [field]: base64 }); 
                if(field==='avatar') { 
                    window.fb.fns.updateProfile(window.fb.auth.currentUser, { photoURL: base64 }); 
                    // Force refresh user object for immediate UI update in Social
                    // Note: Real update happens via onAuthStateChanged but might need manual trigger
                } 
            };
            const saveBio = async () => { await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", uid), { bio: bioText }); setIsEditingBio(false); };
            const toggleFollow = async () => { if(isMe) return; const ref = window.fb.fns.doc(window.fb.db, "users", uid); const amFollowing = data.followers?.includes(currentUser.uid); if(amFollowing) { await window.fb.fns.updateDoc(ref, { followers: window.fb.fns.arrayRemove(currentUser.uid) }); await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", currentUser.uid), { following: window.fb.fns.arrayRemove(uid) }); } else { await window.fb.fns.updateDoc(ref, { followers: window.fb.fns.arrayUnion(currentUser.uid) }); await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", currentUser.uid), { following: window.fb.fns.arrayUnion(uid) }); } };
            const handleCall = async () => { if(isMe) return; await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "calls"), { from: currentUser.uid, to: uid, callerName: currentUser.displayName, callerAvatar: currentUser.photoURL, status: "ringing", createdAt: window.fb.fns.serverTimestamp() }); };
            if(!data) return <div className="p-10 text-center text-[#39ff14]">LOADING NODE...</div>;
            return (
                <div className="h-full overflow-y-auto pb-24 bg-black">
                    <div className="h-40 relative group" style={{backgroundColor: data.cover || '#39ff14'}}>{data.cover?.startsWith('data') && <img src={data.cover} className="w-full h-full object-cover"/>}{isMe && <label className="absolute top-2 right-2 bg-black/60 text-[#39ff14] p-2 rounded cursor-pointer opacity-0 group-hover:opacity-100 transition"><i className="fas fa-camera"></i> <input type="file" hidden accept="image/*" onChange={(e)=>handleUpload(e,'cover')}/></label>}</div>
                    <div className="px-5 -mt-12 relative">
                        <div className="w-24 h-24 rounded-full border-4 border-black bg-white relative overflow-hidden group"><img src={data.avatar} className="w-full h-full object-cover"/>{isMe && <label className="absolute inset-0 bg-black/50 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 cursor-pointer transition"><i className="fas fa-camera"></i> <input type="file" hidden accept="image/*" onChange={(e)=>handleUpload(e,'avatar')}/></label>}</div>
                        <div className="mt-3 flex justify-between items-start"><div><h1 className="text-2xl font-bold text-white brand-font">{data.displayName} <i className="fas fa-check-circle text-[#39ff14] text-xs"></i></h1><p className="text-gray-500 text-xs">UID: {uid.slice(0,8)}...</p></div>{!isMe && (<div className="flex gap-2"><button onClick={toggleFollow} className={`px-4 py-1 rounded-full text-xs font-bold border ${data.followers?.includes(currentUser.uid) ? 'border-gray-600 text-gray-400' : 'bg-[#39ff14] text-black border-[#39ff14]'}`}>{data.followers?.includes(currentUser.uid) ? 'UNFOLLOW' : 'FOLLOW'}</button><button onClick={()=>startChat(uid)} className="bg-gray-800 text-white px-3 py-1 rounded-full text-xs font-bold"><i className="fas fa-envelope"></i></button><button onClick={handleCall} className="bg-gray-800 text-[#39ff14] px-3 py-1 rounded-full text-xs font-bold"><i className="fas fa-phone"></i></button></div>)}</div>
                        <div className="mt-4 glass p-3 rounded-xl flex items-center gap-3 border border-gray-800"><div className="w-8 h-8 rounded-full bg-[#39ff14] flex items-center justify-center text-black animate-spin-slow"><i className="fas fa-compact-disc"></i></div><div className="flex-1"><div className="text-[9px] text-gray-500 uppercase">Profile Anthem</div><div className="text-white text-xs font-bold truncate">{data.anthem ? "Playing..." : "No Anthem Set"}</div></div>{isMe && <label className="text-[#39ff14] text-xs cursor-pointer hover:underline"><i className="fas fa-upload mr-1"></i> Upload <input type="file" hidden accept="audio/*" onChange={(e)=>handleUpload(e,'anthem')}/></label>}</div>
                        <div className="flex gap-6 my-4 text-sm"><div className="text-white font-bold">{data.followers?.length || 0} <span className="text-gray-500 font-normal">Followers</span></div><div className="text-white font-bold">{data.following?.length || 0} <span className="text-gray-500 font-normal">Following</span></div></div>
                        <div className="flex border-b border-gray-800 mb-4">{['posts','about','bio', ...(isMe ? ['visitors'] : [])].map(t => (<button key={t} onClick={()=>setTab(t)} className={`flex-1 py-3 text-xs font-bold uppercase ${tab===t?'text-[#39ff14] border-b-2 border-[#39ff14]':'text-gray-500'}`}>{t}</button>))}</div>
                        <div className="min-h-[200px] text-gray-400 text-sm">
                            {tab === 'posts' && (<div className="space-y-4">{myPosts.length === 0 && <div className="text-center py-10 text-gray-600">No activities recorded.</div>}{myPosts.map((p,i) => (<div key={i} className="glass p-3 rounded-xl"><div className="text-white text-sm mb-2">{p.text}</div>{p.image && <img src={p.image} className="rounded mb-2 max-h-40"/>}<div className="text-[10px] text-gray-500">{formatTime(p.createdAt)}</div></div>))}</div>)}
                            {tab === 'about' && <div className="space-y-2"><p>Joined: {data.joined?.toDate().toDateString()}</p><p>Node: Active</p></div>}
                            {tab === 'bio' && (<div className="glass p-4 rounded-xl border border-gray-800 relative">{isMe && <button onClick={()=>setIsEditingBio(!isEditingBio)} className="absolute top-2 right-2 text-gray-500 hover:text-white"><i className="fas fa-pencil-alt"></i></button>}{isEditingBio ? (<div><textarea value={bioText} onChange={e=>setBioText(e.target.value)} className="w-full bg-black/50 text-white p-2 rounded mb-2 border border-gray-700 outline-none" rows="3"></textarea><button onClick={saveBio} className="bg-[#39ff14] text-black px-3 py-1 rounded text-xs font-bold">SAVE BIO</button></div>) : (<div className="italic">"{data.bio}"</div>)}</div>)}
                            {tab === 'visitors' && isMe && (
                                <div className="space-y-2">
                                    {(data.visitors || []).length === 0 && <div className="text-center py-4">No recent visitors.</div>}
                                    {(data.visitors || []).map((v, i) => (<div key={i} className="flex items-center gap-3 p-3 glass rounded-xl"><img src={v.avatar} className="w-8 h-8 rounded-full"/><div className="flex-1"><div className="text-white font-bold">{v.name}</div><div className="text-[10px] text-gray-500">{formatTime(v.time)}</div></div></div>))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const PrivateChat = ({ user, targetUid, goBack }) => {
            const [msgs, setMsgs] = useState([]); const [txt, setTxt] = useState(""); const scrollRef = useRef(); const chatId = [user.uid, targetUid].sort().join("_");
            const [attach, setAttach] = useState(null); const [showEmoji, setShowEmoji] = useState(false);
            const emojis = ["🔥","🚀","💎","💀","👽","🤖","👾","🧠","👁️","⚡","📀","💾"];
            const gifs = ["https://media.giphy.com/media/26tn33aiTi1jkl6H6/giphy.gif", "https://media.giphy.com/media/LMC8paGihNTuo/giphy.gif", "https://media.giphy.com/media/3o7TKsADS5Kq3Qp8J2/giphy.gif"];
            useEffect(() => { const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "messages", chatId, "chats"), window.fb.fns.orderBy("createdAt", "asc")); const unsub = window.fb.fns.onSnapshot(q, snap => { setMsgs(snap.docs.map(d => d.data())); if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }); return () => unsub(); }, [chatId]);
            const handleFile = async (e) => { const f = e.target.files[0]; if(!f) return; if(f.size > 800000) return alert("Max 800KB"); const b64 = await fileToDataURL(f); setAttach({ url: b64, type: f.type.startsWith('video') ? 'video' : 'image' }); };
            const send = async (e) => { e.preventDefault(); if(!txt.trim() && !attach) return; await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "messages", chatId, "chats"), { text: txt, attachment: attach, from: user.uid, createdAt: window.fb.fns.serverTimestamp() }); setTxt(""); setAttach(null); };
            return (<div className="h-full flex flex-col bg-black pb-24 relative"><div className="p-4 border-b border-gray-800 flex items-center gap-3"><button onClick={goBack} className="text-[#39ff14]"><i className="fas fa-arrow-left"></i></button><h2 className="text-white font-bold brand-font text-sm">ENCRYPTED <span className="text-[#39ff14]">CHANNEL</span></h2></div><div className="flex-1 overflow-y-auto p-4 space-y-3" ref={scrollRef}>{msgs.map((m,i) => (<div key={i} className={`flex ${m.from===user.uid?'justify-end':'justify-start'}`}><div className={`max-w-[70%] p-3 rounded-xl text-sm ${m.from===user.uid?'bg-[#39ff14] text-black':'glass text-white'}`}>{m.attachment && (m.attachment.type==='video' ? <video src={m.attachment.url} controls className="chat-media"/> : <img src={m.attachment.url} className="chat-media"/>)}{m.text}</div><div className="text-[9px] text-gray-500 mt-1 px-1">{formatTime(m.createdAt)}</div></div>))}</div>{showEmoji && <div className="absolute bottom-16 left-4 bg-gray-900 border border-gray-700 p-2 rounded grid grid-cols-4 gap-2 z-50">{emojis.map(e => <button key={e} onClick={()=>{setTxt(prev=>prev+e); setShowEmoji(false)}} className="text-xl hover:bg-white/10 rounded">{e}</button>)}<button onClick={()=>{const g = gifs[Math.floor(Math.random()*gifs.length)]; setAttach({url:g, type:'image'}); setShowEmoji(false)}} className="col-span-4 text-xs bg-[#39ff14] text-black font-bold rounded py-1 mt-1">GIF</button></div>}<form onSubmit={send} className="p-3 border-t border-gray-800 flex gap-2 items-center"><button type="button" onClick={()=>setShowEmoji(!showEmoji)} className="text-gray-400 hover:text-white"><i className="far fa-smile"></i></button><label className="text-gray-400 hover:text-white cursor-pointer"><i className="fas fa-paperclip"></i><input type="file" hidden onChange={handleFile}/></label><div className="flex-1 relative">{attach && <div className="absolute -top-8 left-0 text-[10px] text-[#39ff14] bg-black/80 px-2 rounded">Attached <button onClick={()=>setAttach(null)} className="ml-1 text-red-500">x</button></div>}<input value={txt} onChange={e=>setTxt(e.target.value)} className="w-full bg-gray-900 rounded-full px-4 py-1.5 text-white text-sm outline-none" placeholder="Message..." /></div><button type="submit" className="text-[#39ff14] font-bold px-2"><i className="fas fa-paper-plane"></i></button></form></div>);
        };

        const AppsHub = ({ openApp }) => (
            <div className="h-full overflow-y-auto pb-24 p-4 bg-black">
                <h2 className="text-2xl font-bold text-white brand-font mb-6">WEB4 <span className="text-[#39ff14]">ECOSYSTEM</span></h2>
                <div className="grid grid-cols-2 gap-4">
                    <div onClick={()=>openApp('oracle')} className="aspect-[4/3] rounded-xl relative overflow-hidden glass border border-gray-800 flex items-center justify-center cursor-pointer hover:border-[#39ff14] transition shadow-[0_0_15px_rgba(57,255,20,0.1)] group"><div className="text-center"><i className="fas fa-brain text-4xl text-[#39ff14] mb-2 group-hover:scale-110 transition-transform"></i><div className="font-bold text-white brand-font">The Oracle</div><div className="text-[9px] text-[#39ff14] mt-1 font-bold">AI CORE</div></div></div>
                    <div onClick={()=>openApp('warehouse')} className="aspect-[4/3] rounded-xl relative overflow-hidden glass border border-gray-800 flex items-center justify-center cursor-pointer hover:border-[#39ff14] transition"><div className="text-center"><i className="fas fa-box-open text-3xl text-orange-400 mb-2"></i><div className="font-bold text-white brand-font">Warehouse</div><div className="text-[9px] text-gray-400 mt-1">Cloud Storage</div></div></div>
                    <div onClick={()=>openApp('groups')} className="aspect-[4/3] rounded-xl relative overflow-hidden glass border border-gray-800 flex items-center justify-center cursor-pointer hover:border-[#39ff14] transition"><div className="text-center"><i className="fas fa-users text-3xl text-purple-400 mb-2"></i><div className="font-bold text-white brand-font">Groups</div><div className="text-[9px] text-gray-400 mt-1">Encrypted Chat</div></div></div>
                    <div onClick={()=>openApp('docs')} className="aspect-[4/3] rounded-xl relative overflow-hidden glass border border-gray-800 flex items-center justify-center cursor-pointer hover:border-[#39ff14] transition"><div className="text-center"><i className="fas fa-file-alt text-3xl text-cyan-400 mb-2"></i><div className="font-bold text-white brand-font">White Paper</div></div></div>
                    {[{n:"Wallet", i:"wallet"},{n:"Games", i:"gamepad"},{n:"Casino", i:"dice"},{n:"NFTs", i:"images"},{n:"Visa", i:"credit-card"},{n:"Metaverse", i:"vr-cardboard"}].map((a,i)=>(<div key={i} className="aspect-[4/3] rounded-xl relative overflow-hidden glass border border-gray-800 flex items-center justify-center opacity-70"><div className="text-center"><i className={`fas fa-${a.i} text-2xl text-gray-500 mb-2`}></i><div className="font-bold text-white brand-font mb-1">{a.n}</div><div className="text-[9px] bg-gray-700 text-white px-1 rounded inline-block font-bold">SOON</div></div></div>))}
                </div>
            </div>
        );

        const GroupsApp = ({ user, goBack }) => {
            const [view, setView] = useState('list'); const [groups, setGroups] = useState([]); const [newGroupName, setNewGroupName] = useState(""); const [activeGroup, setActiveGroup] = useState(null);
            const [msgs, setMsgs] = useState([]); const [txt, setTxt] = useState(""); const [inviteName, setInviteName] = useState(""); const scrollRef = useRef();
            const [attach, setAttach] = useState(null);
            useEffect(() => { const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "groups"), window.fb.fns.where("members", "array-contains", user.uid)); const unsub = window.fb.fns.onSnapshot(q, snap => { setGroups(snap.docs.map(d => ({...d.data(), id: d.id}))); }); return () => unsub(); }, [user]);
            useEffect(() => { if(!activeGroup) return; const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "groups", activeGroup.id, "messages"), window.fb.fns.orderBy("createdAt", "asc")); const unsub = window.fb.fns.onSnapshot(q, snap => { setMsgs(snap.docs.map(d => d.data())); if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }); return () => unsub(); }, [activeGroup]);
            const createGroup = async () => { if(!newGroupName.trim()) return; await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "groups"), { name: newGroupName, createdBy: user.uid, members: [user.uid], createdAt: window.fb.fns.serverTimestamp() }); setNewGroupName(""); setView('list'); };
            const handleFile = async (e) => { const f = e.target.files[0]; if(!f) return; const b64 = await fileToDataURL(f); setAttach({ url: b64, type: f.type.startsWith('video') ? 'video' : 'image' }); };
            const sendMsg = async (e) => { e.preventDefault(); if(!txt.trim() && !attach) return; await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "groups", activeGroup.id, "messages"), { text: txt, attachment: attach, senderName: user.displayName, senderUid: user.uid, createdAt: window.fb.fns.serverTimestamp() }); setTxt(""); setAttach(null); };
            const inviteUser = async () => { if(!inviteName.trim()) return; const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "users"), window.fb.fns.where("displayName", "==", inviteName), window.fb.fns.limit(1)); const unsub = window.fb.fns.onSnapshot(q, async (s) => { if(!s.empty) { const uidToAdd = s.docs[0].id; await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "groups", activeGroup.id), { members: window.fb.fns.arrayUnion(uidToAdd) }); alert(`Added ${inviteName}!`); setInviteName(""); } else { alert("User not found!"); } unsub(); }); };
            if(view === 'list') { return (<div className="h-full bg-black p-4 overflow-y-auto"><div className="flex items-center justify-between mb-6"><h2 className="text-xl font-bold text-white brand-font">MY <span className="text-[#39ff14]">GROUPS</span></h2><button onClick={goBack} className="text-gray-400"><i className="fas fa-times"></i></button></div><button onClick={()=>setView('create')} className="w-full py-3 mb-4 border border-dashed border-[#39ff14] text-[#39ff14] rounded-xl font-bold hover:bg-[#39ff14]/10">+ NEW GROUP</button><div className="space-y-2">{groups.map(g => (<div key={g.id} onClick={()=>{setActiveGroup(g); setView('chat')}} className="glass p-4 rounded-xl flex justify-between items-center cursor-pointer hover:border-[#39ff14]"><div className="font-bold text-white">{g.name}</div><i className="fas fa-chevron-right text-gray-500"></i></div>))}</div></div>); }
            if(view === 'create') { return (<div className="h-full bg-black p-4 flex flex-col justify-center"><h2 className="text-white text-lg font-bold mb-4 text-center">NAME YOUR SQUAD</h2><input value={newGroupName} onChange={e=>setNewGroupName(e.target.value)} className="bg-gray-900 border border-[#39ff14] p-3 rounded-xl text-white mb-4 outline-none text-center" placeholder="Group Name..." /><div className="flex gap-2"><button onClick={()=>setView('list')} className="flex-1 py-3 bg-gray-800 text-white rounded-xl">CANCEL</button><button onClick={createGroup} className="flex-1 py-3 bg-[#39ff14] text-black font-bold rounded-xl">CREATE</button></div></div>); }
            if(view === 'chat' && activeGroup) { return (<div className="h-full flex flex-col bg-black pb-24 relative"><div className="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900/50"><div className="flex items-center gap-3"><button onClick={()=>setView('list')} className="text-gray-400"><i className="fas fa-arrow-left"></i></button><div><div className="text-white font-bold">{activeGroup.name}</div><div className="text-[10px] text-gray-500">{activeGroup.members.length} Members</div></div></div><div className="relative group"><i className="fas fa-user-plus text-[#39ff14] cursor-pointer"></i><div className="absolute right-0 top-6 w-48 bg-black border border-gray-700 p-2 rounded hidden group-hover:block z-50"><input value={inviteName} onChange={e=>setInviteName(e.target.value)} placeholder="Username..." className="w-full bg-gray-900 text-white text-xs p-1 mb-1" /><button onClick={inviteUser} className="w-full bg-[#39ff14] text-black text-xs py-1">INVITE</button></div></div></div><div className="flex-1 overflow-y-auto p-4 space-y-3" ref={scrollRef}>{msgs.map((m,i) => (<div key={i} className={`flex flex-col ${m.senderUid===user.uid?'items-end':'items-start'}`}><div className={`max-w-[75%] p-2 rounded-xl text-sm ${m.senderUid===user.uid?'bg-[#39ff14] text-black':'glass text-white'}`}>{m.attachment && (m.attachment.type==='video' ? <video src={m.attachment.url} controls className="chat-media"/> : <img src={m.attachment.url} className="chat-media"/>)}{m.text}</div><span className="text-[9px] text-gray-500 mt-1">{m.senderName} • {formatTime(m.createdAt)}</span></div>))}</div><form onSubmit={sendMsg} className="p-3 border-t border-gray-800 flex gap-2 items-center"><label className="text-gray-400 hover:text-white cursor-pointer"><i className="fas fa-paperclip"></i><input type="file" hidden onChange={handleFile}/></label><div className="flex-1 relative">{attach && <div className="absolute -top-8 left-0 text-[10px] text-[#39ff14] bg-black/80 px-2 rounded">File Attached</div>}<input value={txt} onChange={e=>setTxt(e.target.value)} className="w-full bg-gray-900 rounded-full px-4 text-white text-sm outline-none" placeholder={`Message ${activeGroup.name}...`} /></div><button type="submit" className="text-[#39ff14] px-2"><i className="fas fa-paper-plane"></i></button></form></div>); }
        };

        const Music = ({ player }) => {
            const [tracks, setTracks] = useState([]); const [localTracks, setLocalTracks] = useState([]); const [tab, setTab] = useState('cloud');
            useEffect(() => { fetch(`https://api.jamendo.com/v3.0/tracks/?client_id=ecbc9437&format=jsonpretty&limit=20&order=popularity_total&imagesize=200`).then(r => r.json()).then(d => setTracks(d.results)).catch(()=>{}); setLocalTracks(JSON.parse(localStorage.getItem('my_uploads') || '[]')); }, []);
            const handleUpload = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (evt) => { const newTrack = { name: file.name.replace(/\.[^/.]+$/, ""), artist_name: "My Upload", image: "https://img.icons8.com/fluency/96/music-record.png", audio: evt.target.result, id: Date.now() }; const updated = [newTrack, ...localTracks]; setLocalTracks(updated); localStorage.setItem('my_uploads', JSON.stringify(updated)); }; reader.readAsDataURL(file); } };
            return (<div className="h-full overflow-y-auto pb-24 p-4 bg-black"><h2 className="text-2xl font-bold text-white brand-font mb-4">WEB4 <span className="text-[#39ff14]">AUDIO</span></h2><div className="flex gap-4 mb-4"><button onClick={()=>setTab('cloud')} className={`text-xs font-bold uppercase ${tab==='cloud'?'text-[#39ff14]':'text-gray-500'}`}>Cloud Stream</button><button onClick={()=>setTab('local')} className={`text-xs font-bold uppercase ${tab==='local'?'text-[#39ff14]':'text-gray-500'}`}>My Uploads</button></div>{tab === 'local' && (<label className="block glass border-dashed border border-gray-700 p-4 rounded-xl text-center cursor-pointer mb-4 hover:border-[#39ff14]"><i className="fas fa-cloud-upload-alt text-2xl text-[#39ff14] mb-1"></i><div className="text-xs text-gray-400">Upload MP3</div><input type="file" hidden accept="audio/*" onChange={handleUpload}/></label>)}{(tab==='cloud'?tracks:localTracks).map((t,i) => (<div key={i} onClick={()=>player.play(t)} className="flex items-center p-3 mb-2 glass rounded-xl cursor-pointer hover:border-[#39ff14]"><img src={t.image} className="w-12 h-12 rounded mr-3"/><div className="flex-1 overflow-hidden"><div className="text-sm font-bold text-white truncate">{t.name}</div><div className="text-xs text-gray-500 truncate">{t.artist_name}</div></div><button className="text-[#39ff14]"><i className="fas fa-play"></i></button></div>))}</div>);
        };

        const App = () => {
            const [user, setUser] = useState(null); const [view, setView] = useState('feed'); const [targetUid, setTargetUid] = useState(null); const [showSearch, setShowSearch] = useState(false); const [currentSong, setCurrentSong] = useState(null); const [isPlaying, setIsPlaying] = useState(false); const audioRef = useRef(new Audio());
            const player = { play: (track) => { setCurrentSong(track); setIsPlaying(true); audioRef.current.src = track.audio; audioRef.current.play().catch(e=>console.log("Autoplay blocked")); }, toggle: () => { if(isPlaying){ audioRef.current.pause(); setIsPlaying(false); } else { audioRef.current.play(); setIsPlaying(true); } }, song: currentSong };
            useEffect(() => { if(!window.fb) return; const unsub = window.fb.fns.onAuthStateChanged(window.fb.auth, u => setUser(u)); return () => unsub(); }, []);
            const goToProfile = (uid) => { setTargetUid(uid); setView('profile'); }; const startChat = (uid) => { setTargetUid(uid); setView('chat_private'); };
            if(!user) return <Auth setUser={setUser} />;
            return (
                <AppContext.Provider value={{ user, player }}>
                    <div className="w-full h-screen bg-[#111] flex items-center justify-center">
                        <div className="w-full h-full md:max-w-md md:h-[90vh] md:rounded-[3rem] md:border-[8px] md:border-gray-800 bg-black flex flex-col relative shadow-2xl overflow-hidden">
                            <header className="h-14 flex items-center justify-between px-4 glass z-30 relative shrink-0"><div className="flex items-center gap-2"><div className="w-8 h-8"><HybridLogo size={40} /></div><h1 className="text-lg font-bold brand-font text-white tracking-widest">CRYPTINITY</h1></div><div className="flex gap-4"><button onClick={()=>setShowSearch(true)}><i className="fas fa-search text-gray-400 hover:text-white"></i></button><button onClick={()=>setView('settings')}><i className="fas fa-sliders-h text-gray-400 hover:text-white"></i></button></div></header>
                            {showSearch && <Search close={()=>setShowSearch(false)} goToProfile={goToProfile} />}
                            <CallManager user={user} />
                            <main className="flex-1 overflow-hidden relative">
                                {view === 'feed' && <Social user={user} goToProfile={goToProfile} />}
                                {view === 'mining' && <Mining user={user} />}
                                {view === 'apps' && <AppsHub openApp={setView} />}
                                {view === 'oracle' && <OracleApp goBack={()=>setView('apps')} />}
                                {view === 'groups' && <GroupsApp user={user} goBack={()=>setView('apps')} />}
                                {view === 'warehouse' && <WarehouseApp user={user} goBack={()=>setView('apps')} />}
                                {view === 'music' && <Music player={player} />}
                                {view === 'docs' && <DocsApp goBack={()=>setView('apps')} />}
                                {view === 'settings' && <Settings user={user} />}
                                {view === 'profile' && <Profile currentUser={user} targetUid={targetUid} startChat={startChat} player={player} />}
                                {view === 'chat_private' && <PrivateChat user={user} targetUid={targetUid} goBack={()=>setView('feed')} />}
                            </main>
                            <div className={`absolute bottom-[60px] left-0 right-0 bg-[#111] border-t border-[#333] p-2 z-20 flex items-center gap-3 transition-transform ${currentSong?'translate-y-0':'translate-y-20'}`}><img src={currentSong?.image} className={`w-10 h-10 rounded ${isPlaying?'animate-spin':''}`} style={{animationDuration:'5s'}}/><div className="flex-1 min-w-0"><div className="text-white text-xs font-bold truncate">{currentSong?.name}</div></div><button onClick={player.toggle} className="text-[#39ff14] text-xl px-2"><i className={`fas fa-${isPlaying?'pause':'play'}`}></i></button></div>
                            <nav className="h-16 bg-black border-t border-gray-900 grid grid-cols-5 items-center z-30 pb-safe shrink-0">{[{id:'feed',i:'home',l:'Home'},{id:'mining',i:'bolt',l:'Mine'},{id:'apps',i:'th',l:'Apps'},{id:'music',i:'music',l:'Music'},{id:'profile',i:'user',l:'Me'}].map(t => (<button key={t.id} onClick={()=>{ setTargetUid(null); setView(t.id); }} className={`flex flex-col items-center gap-1 ${view===t.id ? 'text-[#39ff14]' : 'text-gray-600'}`}><div className={`text-xl ${view===t.id && t.id==='mining' ? 'animate-pulse' : ''}`}><i className={`fas fa-${t.i}`}></i></div><span className="text-[9px] uppercase font-bold tracking-wider">{t.l}</span></button>))}</nav>
                        </div>
                    </div>
                </AppContext.Provider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
