<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050a05">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>CRYPTINITY | Web4 Hybrid OS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neon: '#39ff14',       
                        volt: '#ccff00',       /* Wallet Main Accent */
                        teal: '#00f0ff',       /* Chart Accent */
                        dark: '#000000',       
                        panel: '#111c11',
                        card: '#161616',      
                        glass: 'rgba(20, 30, 20, 0.9)',
                    },
                    fontFamily: { sans: ['Poppins', 'sans-serif'], mono: ['Rajdhani', 'monospace'], brand: ['Orbitron', 'sans-serif'] },
                    animation: { 'marquee': 'marquee 20s linear infinite', 'pulse-glow': 'pulseGlow 2s infinite' },
                    keyframes: { 
                        marquee: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } },
                        pulseGlow: { '0%, 100%': { opacity: 1, filter: 'drop-shadow(0 0 5px #00f0ff)' }, '50%': { opacity: 0.7, filter: 'drop-shadow(0 0 15px #00f0ff)' } }
                    }
                }
            }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Rajdhani:wght@500;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, getDoc, getDocs, limit, where, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALkLkbBr2SCxLyon970oyoBr2hmfFu0kE",
            authDomain: "cryptinity--ultra--web4.firebaseapp.com",
            projectId: "cryptinity--ultra--web4",
            storageBucket: "cryptinity--ultra--web4.firebasestorage.app",
            messagingSenderId: "624069180316",
            appId: "1:624069180316:web:124ddb51d9194fe539a659"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.fb = { 
                auth: getAuth(app), db: getFirestore(app),
                fns: { signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, collection, addDoc, query, orderBy, onSnapshot, doc, setDoc, updateDoc, serverTimestamp, getDoc, getDocs, limit, where, arrayUnion, arrayRemove, deleteDoc } 
            };
        } catch(e) { 
            console.error("Firebase Initialization Failed (Using Mock Mode):", e);
            window.fb = {
                auth: { currentUser: { uid: 'mock', displayName: 'Guest User', photoURL: 'https://api.dicebear.com/9.x/avataaars/svg?seed=mock' } },
                db: {},
                fns: {
                    onAuthStateChanged: (a, cb) => cb({ uid: 'mock', displayName: 'Guest User', photoURL: 'https://api.dicebear.com/9.x/avataaars/svg?seed=mock' }),
                    signInWithEmailAndPassword: async () => ({ user: { uid: 'mock' } }),
                    createUserWithEmailAndPassword: async () => ({ user: { uid: 'mock' } }),
                    signOut: async () => window.location.reload(),
                    updateProfile: async () => {},
                    collection: () => ({}), doc: () => ({}), query: () => ({}), orderBy: () => ({}), limit: () => ({}), where: () => ({}),
                    onSnapshot: (q, cb) => { cb({ docs: [], exists: ()=>false, data: ()=>({}) }); return ()=>{}; },
                    getDoc: async () => ({ exists: ()=>true, data: ()=>({ balance: 12843 }) }),
                    getDocs: async () => ({ docs: [] }),
                    setDoc: async () => {}, updateDoc: async () => {}, addDoc: async () => {}, deleteDoc: async () => {},
                    serverTimestamp: () => new Date(), arrayUnion: () => {}, arrayRemove: () => {}
                }
            };
        }
    </script>

    <style>
        body { background-color: #050a05; color: #e0e0e0; overscroll-behavior: none; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .glass-panel { background: linear-gradient(160deg, rgba(20,30,20,0.95), rgba(10,15,10,0.98)); backdrop-filter: blur(20px); border: 1px solid rgba(57, 255, 20, 0.15); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .btn-primary { background: linear-gradient(90deg, #39ff14, #2abf0f); color: #000; font-weight: 700; box-shadow: 0 0 15px rgba(57, 255, 20, 0.3); }
        .input-box { background: rgba(0,0,0,0.6); border: 1px solid rgba(57, 255, 20, 0.3); color: white; transition: all 0.3s; }
        .input-box:focus { border-color: #39ff14; box-shadow: 0 0 10px rgba(57, 255, 20, 0.2); }
        .grid-bg { background-image: linear-gradient(rgba(57, 255, 20, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(57, 255, 20, 0.03) 1px, transparent 1px); background-size: 40px 40px; }
        .animate-fade { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: black; }
        .video-container video, .video-container img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        
        /* Wallet Specific Styles */
        .wallet-card { background: #161616; border-radius: 24px; border: 1px solid #222; }
        .wallet-btn-icon { background: #ccff00; color: black; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: transform 0.2s; }
        .wallet-btn-icon:active { transform: scale(0.95); }
        
        .nav-pill { background: #1f1f1f; color: #888; border-radius: 12px; padding: 6px 12px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .nav-pill.active { background: rgba(0, 240, 255, 0.15); color: #00f0ff; border: 1px solid rgba(0, 240, 255, 0.3); }
        
        /* Chart Styles - Teal Theme */
        .chart-container { background: linear-gradient(180deg, #0a1f20 0%, #000 100%); border-radius: 24px; border: 1px solid rgba(0, 240, 255, 0.1); position: relative; overflow: hidden; }
        .chart-gradient-area { fill: url(#tealGradient); }
        .chart-stroke { stroke: #00f0ff; stroke-width: 2; stroke-linecap: round; filter: drop-shadow(0 0 4px rgba(0, 240, 255, 0.5)); }
        
        .qr-frame { background: white; padding: 10px; border-radius: 10px; display: inline-block; }
    </style>
</head>
<body class="h-screen w-full grid-bg overflow-hidden text-gray-200 font-sans bg-black">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useContext, createContext } = React;
        
        // --- SERVICES ---
        const CLOUD_NAME = "dpiypv2r5"; 
        const UPLOAD_PRESET = "cryptinity"; 

        const uploadToCloudinary = async (file) => {
            const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', UPLOAD_PRESET);
            try { 
                const r = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, { method: 'POST', body: formData }); 
                const d = await r.json(); 
                if(d.error) throw new Error(d.error.message);
                return { url: d.secure_url, type: d.resource_type }; 
            } catch (e) { console.error(e); alert("Upload failed: " + e.message); return null; }
        };

        const callGemini = async (prompt, sys) => {
            const k = localStorage.getItem('cryptinity_ai_key'); 
            if (!k) return "Please set API Key in Settings";
            try { const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${k}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}], systemInstruction:{parts:[{text:sys}]}}) });
            const d = await r.json(); return d.candidates?.[0]?.content?.parts?.[0]?.text || "System Error"; } catch(e){return "Offline";}
        };
        
        const formatTime = (t) => { if(!t) return ""; const d = t.seconds ? new Date(t.seconds*1000) : new Date(t); const diff = (new Date()-d)/1000; if(diff<60) return "Just now"; if(diff<3600) return `${Math.floor(diff/60)}m ago`; if(diff<86400) return `${Math.floor(diff/3600)}h ago`; return `${Math.floor(diff/86400)}d ago`; };

        // --- COMPONENTS ---

        // The Original 3D Spinning Logo
        const HybridLogo = ({ size = 200, color = 0x39ff14 }) => {
            const mountRef = useRef(null);
            useEffect(() => {
                if(!mountRef.current || !window.THREE) return;
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100); camera.position.z = 8;
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(size, size); renderer.setPixelRatio(window.devicePixelRatio);
                mountRef.current.innerHTML = ''; mountRef.current.appendChild(renderer.domElement);
                const geometry = new THREE.TorusKnotGeometry(1.6, 0.45, 120, 16, 2, 3);
                const material = new THREE.MeshPhongMaterial({ color: color, emissive: 0x0a1f0a, shininess: 100, wireframe: false, transparent: true, opacity: 0.95 });
                const mesh = new THREE.Mesh(geometry, material); scene.add(mesh);
                const light = new THREE.PointLight(0xffffff, 1, 100); light.position.set(10, 10, 10); scene.add(light);
                const animate = () => { if(!mountRef.current) return; requestAnimationFrame(animate); mesh.rotation.y += 0.015; mesh.rotation.x += 0.005; renderer.render(scene, camera); }; animate();
            }, [size, color]);
            return <div ref={mountRef} className="filter drop-shadow-[0_0_15px_rgba(57,255,20,0.6)]" />;
        };

        const Auth = ({ setUser }) => {
            const [isLogin, setIsLogin] = useState(true); const [loading, setLoading] = useState(false); const [form, setForm] = useState({email:'', pass:'', name:''});
            const handleAuth = async (e) => { 
                e.preventDefault(); setLoading(true); const { auth, db, fns } = window.fb; 
                try { 
                    let u; 
                    if(isLogin) u = await fns.signInWithEmailAndPassword(auth, form.email, form.pass); 
                    else { 
                        u = await fns.createUserWithEmailAndPassword(auth, form.email, form.pass); 
                        await fns.updateProfile(u.user, { displayName: form.name, photoURL: `https://api.dicebear.com/9.x/avataaars/svg?seed=${u.user.uid}` }); 
                        await fns.setDoc(fns.doc(db, "users", u.user.uid), { displayName: form.name, email: form.email, joined: fns.serverTimestamp(), avatar: u.user.photoURL, balance: 12843.00, friends: [], friendRequests: [], bio: "Web4 Citizen", themeSong: "" }); 
                    } 
                    setUser(u.user); 
                } catch(e){alert(e.message);} 
                setLoading(false); 
            };
            return (
                <div className="h-full w-full flex flex-col items-center justify-center p-6 bg-black grid-bg relative">
                    <div className="z-10 w-full max-w-sm flex flex-col items-center animate-fade">
                        <HybridLogo size={200} />
                        <h1 className="text-3xl font-bold text-white mt-4 tracking-wider brand-font">CRYPTINITY</h1>
                        <div className="glass-panel w-full p-8 rounded-3xl mt-8">
                            <form onSubmit={handleAuth} className="space-y-4">
                                {!isLogin && <input required placeholder="Username" className="w-full input-box rounded-xl p-3 outline-none" onChange={e=>setForm({...form, name:e.target.value})} />}
                                <input required type="email" placeholder="Email" className="w-full input-box rounded-xl p-3 outline-none" onChange={e=>setForm({...form, email:e.target.value})} />
                                <input required type="password" placeholder="Password" className="w-full input-box rounded-xl p-3 outline-none" onChange={e=>setForm({...form, pass:e.target.value})} />
                                <button type="submit" className="w-full py-4 btn-primary rounded-xl transition hover:opacity-90">{loading ? 'SYNCING...' : (isLogin ? 'LOGIN' : 'REGISTER')}</button>
                            </form>
                            <button onClick={()=>setIsLogin(!isLogin)} className="w-full mt-4 text-xs text-gray-400 hover:text-neon transition">{isLogin ? 'Create Account' : 'Login'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- WALLET COMPONENTS ---

        const VoltChartSVG = ({ color, data, height = 50 }) => (
            <svg viewBox="0 0 100 40" className="w-full" style={{height: height}}>
                <path fill="none" stroke={color} strokeWidth="3" d={`M ${data}`} className="chart-line"/>
                <path fill={`url(#grad-${color.replace('#','')})`} d={`M ${data} V 40 H 0 Z`} opacity="0.1" />
                <defs>
                    <linearGradient id={`grad-${color.replace('#','')}`} x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor={color} stopOpacity="0.5" />
                        <stop offset="100%" stopColor={color} stopOpacity="0" />
                    </linearGradient>
                </defs>
            </svg>
        );

        const LiveChartSVG = ({ dataPoints }) => {
            const pts = "0,80 10,75 20,78 30,60 40,65 50,50 60,55 70,30 80,40 90,20 100,25";
            return (
                <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="w-full h-full overflow-visible">
                    <defs>
                        <linearGradient id="tealGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stopColor="#00f0ff" stopOpacity="0.4" />
                            <stop offset="100%" stopColor="#00f0ff" stopOpacity="0" />
                        </linearGradient>
                    </defs>
                    <path d={`M ${pts}`} fill="none" className="chart-stroke" />
                    <path d={`M ${pts} V 120 H 0 Z`} className="chart-gradient-area" />
                    <circle cx="100" cy="25" r="3" fill="#fff" className="animate-pulse-glow" />
                </svg>
            );
        }

        // Custom CTY Logo Component
        const CTYLogo = () => (
            <svg viewBox="0 0 100 100" className="w-full h-full">
                <defs>
                    <linearGradient id="ctyGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stopColor="#39ff14"/>
                        <stop offset="100%" stopColor="#0a2a0a"/>
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="45" fill="none" stroke="url(#ctyGrad)" strokeWidth="5"/>
                <path d="M50 20 L80 50 L50 80 L20 50 Z" fill="url(#ctyGrad)" opacity="0.8"/>
                <circle cx="50" cy="50" r="10" fill="#000"/>
            </svg>
        );

        const WalletApp = ({ user, goBack }) => {
            const [bal, setBal] = useState(12843); 
            const [tab, setTab] = useState('home'); 
            const [selectedCoin, setSelectedCoin] = useState(null);
            
            // --- LIVE DATA SIMULATION ---
            const [coins, setCoins] = useState([
                { id: 'btc', name: 'Bitcoin', symbol: 'BTC', price: 119904.40, change: '+1.40%', color: '#ccff00', data: '0,35 20,25 40,30 60,10 80,15 100,5', hold: 0.011, rank: '01', cap: '$2.52 Trillion', ath: '$124,457.11', atl: '$0.0486' },
                { id: 'eth', name: 'Ethereum', symbol: 'ETH', price: 4471.58, change: '+2.90%', color: '#ccff00', data: '0,30 20,35 40,20 60,25 80,10 100,15', hold: 0.85, rank: '02', cap: '$538 Billion', ath: '$4,891.70', atl: '$0.42' },
                { id: 'sol', name: 'Solana', symbol: 'SOL', price: 145.20, change: '+5.1%', color: '#ccff00', data: '0,25 20,30 40,25 60,15 80,10 100,5', hold: 12.5, rank: '05', cap: '$65 Billion', ath: '$260.06', atl: '$0.50' },
                { id: 'cty', name: 'Cryptinity', symbol: 'CTY', price: 0.00042, change: '+12.4%', color: '#39ff14', data: '0,38 20,36 40,30 60,20 80,15 100,5', hold: 15000, rank: '99', cap: '$420 Million', ath: '$0.0050', atl: '$0.0001' }
            ]);

            // Simulate Live Prices
            useEffect(() => {
                const interval = setInterval(() => {
                    setCoins(prevCoins => prevCoins.map(c => {
                        if (c.symbol === 'CTY') return c; // Stable CTY
                        const fluctuation = (Math.random() - 0.5) * (c.price * 0.002);
                        return { ...c, price: c.price + fluctuation };
                    }));
                }, 3000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => { 
                const unsub = window.fb.fns.onSnapshot(window.fb.fns.doc(window.fb.db, "users", user.uid), d=>{ 
                    if(d.exists()) { 
                        const b = d.data().balance;
                        if(b !== undefined) setBal(parseFloat(b));
                    } 
                });
                return () => unsub();
            }, []);

            const renderHome = () => (
                <div className="animate-fade pb-20">
                    <div className="flex justify-between items-center mb-8 pt-2">
                        <div className="flex items-center gap-2">
                            <img src={user.photoURL} className="w-8 h-8 rounded-full border border-gray-700" />
                            <span className="text-gray-400 text-sm">02x******m3</span>
                            <i className="fas fa-chevron-down text-gray-600 text-xs"></i>
                        </div>
                        <button className="w-10 h-10 rounded-full bg-[#161616] flex items-center justify-center border border-[#222]"><i className="fas fa-bell text-white"></i></button>
                    </div>

                    <div className="text-center mb-10">
                        <div className="flex items-center justify-center gap-2 text-gray-400 text-sm mb-2">Available Balance <i className="fas fa-eye text-gray-600"></i></div>
                        <h1 className="text-5xl font-bold text-white font-sans tracking-tight mb-2">${bal.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}<span className="text-gray-500 text-2xl ml-2 font-normal">USD</span></h1>
                        <div className="inline-block px-3 py-1 rounded-full bg-[#ccff00]/10"><span className="text-volt font-bold text-sm">↗ +12.4%</span></div>
                    </div>

                    <div className="flex justify-between px-4 mb-10">
                        <div className="flex flex-col items-center gap-3 cursor-pointer" onClick={()=>setTab('deposit')}>
                            <div className="wallet-btn-icon shadow-[0_0_15px_rgba(204,255,0,0.2)]"><i className="fas fa-arrow-down"></i></div><span className="text-xs font-bold text-white">Deposits</span>
                        </div>
                        <div className="flex flex-col items-center gap-3 cursor-pointer" onClick={()=>{alert('Withdrawals temporarily paused for security upgrade.')}}>
                            <div className="wallet-btn-icon shadow-[0_0_15px_rgba(204,255,0,0.2)]"><i className="fas fa-arrow-up"></i></div><span className="text-xs font-bold text-white">Withdraw</span>
                        </div>
                        <div className="flex flex-col items-center gap-3 cursor-pointer" onClick={()=>setTab('chart')}>
                            <div className="wallet-btn-icon shadow-[0_0_15px_rgba(204,255,0,0.2)]"><i className="fas fa-chart-line"></i></div><span className="text-xs font-bold text-white">Trade</span>
                        </div>
                        <div className="flex flex-col items-center gap-3 cursor-pointer" onClick={()=>{}}>
                            <div className="wallet-btn-icon shadow-[0_0_15px_rgba(204,255,0,0.2)]"><i className="fas fa-th-large"></i></div><span className="text-xs font-bold text-white">More</span>
                        </div>
                    </div>

                    <div className="mb-8">
                        <div className="flex justify-between items-end mb-4 px-2"><h3 className="text-white font-bold text-lg">Top Gainers</h3><span className="text-gray-500 text-xs cursor-pointer">See All</span></div>
                        <div className="flex gap-4 overflow-x-auto hide-scroll pb-2 px-2">
                            {coins.slice(0,3).map(c => (
                                <div key={c.id} onClick={()=>{setSelectedCoin(c); setTab('chart')}} className="wallet-card p-4 min-w-[160px] cursor-pointer hover:border-[#ccff00] transition group">
                                    <div className="flex items-start justify-between mb-4"><div className="w-10 h-10 rounded-full bg-[#222] flex items-center justify-center"><i className={`fab fa-${c.id==='btc'?'bitcoin':'ethereum'} text-${c.id==='btc'?'orange-500':'blue-400'} text-xl`}></i></div></div>
                                    <div className="text-gray-400 text-xs mb-1">{c.name}</div><div className="text-white font-bold text-lg mb-1">${c.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6})}</div><div className="text-volt text-xs font-bold mb-4">↗ {c.change}</div><VoltChartSVG color={c.color} data={c.data} height={40} />
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="px-2">
                        <div className="flex justify-between items-end mb-4"><h3 className="text-white font-bold text-lg">My Assets</h3><span className="text-gray-500 text-xs cursor-pointer">See All</span></div>
                        <div className="flex gap-2 mb-4 overflow-x-auto">{['Crypto', 'Feature', 'Spot', 'Earn', 'Funding'].map((t,i) => (<span key={i} className={`px-4 py-2 rounded-full text-xs font-bold ${i===0?'bg-volt text-black':'bg-[#1f1f1f] text-gray-400'}`}>{t}</span>))}</div>
                        <div className="space-y-3">
                            {coins.map(c => (
                                <div key={c.id} onClick={()=>{setSelectedCoin(c); setTab('chart')}} className="flex items-center justify-between py-2 border-b border-[#222] active:bg-[#1a1a1a]">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-[#1a1a1a] flex items-center justify-center">
                                            {c.symbol==='BTC'?<i className="fab fa-bitcoin text-orange-500"></i>:c.symbol==='ETH'?<i className="fab fa-ethereum text-blue-400"></i>:c.symbol==='SOL'?<i className="fas fa-cube text-purple-400"></i>:<div className="w-6 h-6"><CTYLogo/></div>}
                                        </div>
                                        <div><div className="text-white font-bold text-sm">{c.name}</div><div className="text-volt text-xs">{c.change}</div></div>
                                    </div>
                                    <div className="text-right"><div className="text-white font-bold text-sm">${(c.price * c.hold).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}</div><div className="text-gray-500 text-xs">{c.hold} {c.symbol}</div></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
            
            const renderChart = () => ( 
                <div className="animate-fade h-full flex flex-col relative pt-4 pb-safe bg-gradient-to-b from-[#0a1515] to-black">
                    <div className="flex items-center justify-between mb-6 px-4">
                        <button onClick={()=>setTab('home')} className="w-10 h-10 rounded-full border border-[#222] bg-[#111] flex items-center justify-center text-white"><i className="fas fa-arrow-left"></i></button>
                        <div className="text-white font-bold text-lg">{selectedCoin?.name || 'Bitcoin'}</div>
                        <div className="flex gap-2">
                             <button className="w-10 h-10 rounded-xl bg-[#1a2a2a] text-[#00f0ff]"><i className="fas fa-sliders-h"></i></button>
                             <button className="w-10 h-10 rounded-xl bg-[#1a2a2a] text-[#00f0ff]"><i className="fas fa-expand"></i></button>
                        </div>
                    </div>

                    <div className="px-4 mb-4">
                        <div className="text-gray-400 text-xs mb-1">Current Price</div>
                        <h1 className="text-4xl font-bold text-white mb-4 tracking-tight">${selectedCoin?.price?.toLocaleString(undefined, {minimumFractionDigits: selectedCoin.id === 'cty' ? 5 : 2}) || '38,154'} <span className="text-xs text-gray-500">USD</span></h1>
                        
                        <div className="flex gap-2 mb-6">
                            {['1s', '15m', '1h', '4h', '1d', '1w'].map(t => (
                                <button key={t} className={`nav-pill ${t==='1d'?'active':''}`}>{t}</button>
                            ))}
                        </div>

                        <div className="chart-container h-80 w-full mb-6 p-4">
                            <div className="absolute top-20 right-10 bg-[#0a1f20]/90 backdrop-blur border border-[#00f0ff]/30 p-2 rounded-lg z-10 shadow-[0_0_20px_rgba(0,240,255,0.2)]">
                                <div className="text-white font-bold text-sm">${selectedCoin?.price?.toLocaleString() || '38,154'} USD</div>
                                <div className="text-xs text-gray-400">Live</div>
                            </div>
                            <div className="w-full h-full relative">
                                <div className="absolute inset-0 grid grid-cols-4 grid-rows-4 opacity-10 pointer-events-none">
                                    <div className="border-r border-white/20"></div><div className="border-r border-white/20"></div><div className="border-r border-white/20"></div>
                                </div>
                                <LiveChartSVG />
                            </div>
                            <div className="flex justify-between text-[10px] text-gray-500 mt-2 font-mono">
                                <span>8:00AM</span><span>10:00AM</span><span>12:00AM</span><span>02:00PM</span>
                            </div>
                        </div>
                    </div>

                    <div className="px-4 mt-auto">
                        <div className="glass-panel p-4 rounded-t-3xl border-t border-[#00f0ff]/20">
                             <div className="flex justify-between items-center mb-4">
                                 <div className="flex items-center gap-2 text-white font-bold"><i className="fas fa-wallet text-[#00f0ff]"></i> Account balance</div>
                                 <div className="flex gap-2">
                                     <button className="nav-pill active"><i className="fas fa-sync-alt"></i></button>
                                     <button className="nav-pill">7 Days <i className="fas fa-chevron-down"></i></button>
                                 </div>
                             </div>
                             <div className="flex justify-between items-center">
                                 <div>
                                     <div className="text-3xl font-bold text-white">${bal.toLocaleString()} <span className="text-xs text-gray-500">USD</span></div>
                                     <div className="text-[#00f0ff] text-xs">+ $1,240.50 (3.4%)</div>
                                 </div>
                                 <button className="bg-[#00f0ff] text-black font-bold px-6 py-3 rounded-xl shadow-[0_0_15px_#00f0ff]">Trade</button>
                             </div>
                        </div>
                    </div>
                </div> 
            );

            const renderDeposit = () => (
                <div className="animate-fade h-full flex flex-col pt-4 pb-safe bg-black">
                     <div className="flex items-center justify-between mb-8 px-6">
                        <button onClick={()=>setTab('home')} className="w-10 h-10 rounded-full border border-[#222] bg-[#111] flex items-center justify-center text-white"><i className="fas fa-arrow-left"></i></button>
                        <div className="text-white font-bold text-lg">Deposit USDT</div>
                        <div className="w-10"></div>
                    </div>

                    <div className="flex-1 flex flex-col items-center px-6">
                        <div className="w-full bg-[#161616] rounded-3xl p-6 border border-[#222] flex flex-col items-center mb-6">
                            <div className="text-gray-400 text-sm mb-4">Scan QR to Deposit</div>
                            <div className="qr-frame mb-6">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=0x399C317773237D4ee5faa9E181523b82BAa27197" alt="Wallet QR" className="w-48 h-48" />
                            </div>
                            <div className="w-full bg-black rounded-xl p-3 flex items-center justify-between border border-[#333] mb-4">
                                <div className="truncate text-xs text-gray-400 font-mono w-48">0x399C317773237D4ee5faa9E181523b82BAa27197</div>
                                <button className="text-volt" onClick={()=>{navigator.clipboard.writeText('0x399C317773237D4ee5faa9E181523b82BAa27197'); alert('Copied!');}}><i className="fas fa-copy"></i></button>
                            </div>
                            <div className="flex items-center gap-2 text-yellow-500 bg-yellow-900/20 px-4 py-2 rounded-lg border border-yellow-700/30">
                                <i className="fas fa-exclamation-triangle"></i>
                                <span className="text-xs font-bold">Minimum Deposit: $10 USD</span>
                            </div>
                        </div>

                        <div className="w-full">
                            <div className="text-gray-500 text-xs mb-2 px-2">Network</div>
                            <div className="bg-[#161616] p-4 rounded-xl border border-[#222] text-white flex justify-between items-center mb-4">
                                <div className="flex items-center gap-2"><i className="fas fa-network-wired text-volt"></i> BEP-20 (BSC)</div>
                                <i className="fas fa-chevron-down text-gray-600"></i>
                            </div>
                            <div className="text-gray-500 text-xs mb-2 px-2">Tips</div>
                            <div className="text-[10px] text-gray-600 px-2">
                                • Send only USDT (BEP20) to this address.<br/>
                                • Deposits below $10 will not be credited.<br/>
                                • Arrival time: ~1-3 minutes.
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="h-full bg-black p-0 overflow-y-auto pb-safe">
                    {tab === 'home' && renderHome()}
                    {tab === 'chart' && renderChart()}
                    {tab === 'deposit' && renderDeposit()}
                </div>
            );
        };

        const UserSearch = ({ goToProfile }) => {
            const [q, setQ] = useState(""); const [res, setRes] = useState([]);
            useEffect(() => { if(q.length < 3) { setRes([]); return; } const f = window.fb.fns; f.getDocs(f.query(f.collection(window.fb.db, "users"), f.where("displayName", ">=", q), f.where("displayName", "<=", q+'\uf8ff'))).then(s => setRes(s.docs.map(d=>({id:d.id, ...d.data()})))); }, [q]);
            return ( <div className="relative w-full max-w-md mx-auto mb-4 z-50"><input value={q} onChange={e=>setQ(e.target.value)} placeholder="Search Friends..." className="w-full glass-panel rounded-full px-4 py-2 text-white outline-none focus:border-neon" />{res.length > 0 && <div className="absolute top-12 left-0 right-0 glass-panel rounded-xl max-h-60 overflow-y-auto">{res.map(u => <div key={u.id} onClick={()=>{goToProfile(u.id); setQ(""); setRes([]);}} className="p-3 hover:bg-white/10 flex items-center gap-3 cursor-pointer"><img src={u.avatar} className="w-8 h-8 rounded-full"/><span className="text-white">{u.displayName}</span></div>)}</div>}</div> );
        };

        const NeuralWidget = () => {
            const [q, setQ] = useState(""); const [a, setA] = useState("System Ready."); const [loading, setLoading] = useState(false);
            const ask = async () => { if(!q) return; setLoading(true); const res = await callGemini(q, "You are the OS AI."); setA(res); setQ(""); setLoading(false); };
            return ( <div className="h-full flex flex-col p-4 border-l border-neon/20 glass-panel"><div className="text-neon font-bold mb-4 flex items-center gap-2"><i className="fas fa-brain"></i> NEURAL CORE</div><div className="flex-1 overflow-y-auto text-sm text-gray-300 font-mono mb-4">{a}</div><div className="flex gap-2"><input value={q} onChange={e=>setQ(e.target.value)} onKeyDown={e=>e.key==='Enter'&&ask()} className="flex-1 bg-black/50 border border-neon/30 rounded px-2 text-white outline-none" placeholder="Query..." /><button onClick={ask} className="text-neon"><i className={`fas fa-${loading?'circle-notch fa-spin':'arrow-right'}`}></i></button></div></div> );
        };

        // --- RESTORED MINING APP ---
        const MiningApp = ({ user }) => {
            const [bal, setBal] = useState(0); const [active, setActive] = useState(false); const ref = useRef(0); const [countdown, setCountdown] = useState("Loading...");
            useEffect(() => { window.fb.fns.getDoc(window.fb.fns.doc(window.fb.db, "users", user.uid)).then(d=>{ if(d.exists()) { const val = parseFloat(d.data().balance) || 0; setBal(val); ref.current = val; } }); }, []);
            useEffect(() => { let i; if(active) { i = setInterval(()=>{ ref.current += 0.00000125; setBal(ref.current); }, 100); } return () => clearInterval(i); }, [active]);
            useEffect(() => { const i = setInterval(()=>{ if(active) window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db, "users", user.uid), {balance:ref.current}); }, 5000); return () => clearInterval(i); }, [active]);
            
            // 60 Day Countdown
            useEffect(() => { const target = new Date(); target.setDate(target.getDate() + 60); const i = setInterval(() => { const now = new Date().getTime(); const d = target - now; if(d > 0) { const days = Math.floor(d / (1000 * 60 * 60 * 24)); const hours = Math.floor((d % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)); const mins = Math.floor((d % (1000 * 60 * 60)) / (1000 * 60)); const secs = Math.floor((d % (1000 * 60)) / 1000); setCountdown(`${days}d ${hours}h ${mins}m ${secs}s`); } }, 1000); return () => clearInterval(i); }, []);
            
            return ( 
                <div className="h-full p-6 flex flex-col items-center overflow-y-auto pt-10">
                    <h2 className="text-2xl font-bold text-white mb-2 tracking-widest brand-font">CLOUD <span className="text-neon">MINING</span></h2>
                    <div className="glass-panel px-4 py-1 rounded-full mb-6 border-neon/30 text-xs text-neon font-mono">1 CTY = $0.00042 USD</div>
                    
                    {/* The Original 3D Logo */}
                    <div className={`transition-all duration-700 mb-8 ${active ? 'scale-110 drop-shadow-[0_0_40px_rgba(57,255,20,0.4)]' : 'grayscale opacity-60'}`}>
                        <HybridLogo size={240} active={active} />
                    </div>
                    
                    <div className="glass-panel w-full p-6 rounded-3xl border border-neon/20 mb-4 relative overflow-hidden text-center bg-black/40">
                        <div className="text-[10px] text-neon uppercase tracking-[0.3em] mb-1">Launch Countdown</div>
                        <div className="text-2xl font-mono text-white font-bold mb-4">{countdown}</div>
                        <div className="flex justify-between items-end">
                            <div>
                                <div className="text-xs text-gray-400 uppercase">Mined Balance</div>
                                <div className="text-4xl font-mono text-white font-bold">{bal.toFixed(8)}</div>
                            </div>
                            <div className="text-neon animate-pulse text-sm"><i className="fas fa-bolt"></i> {active?'340 MH/s':'IDLE'}</div>
                        </div>
                    </div>
                    
                    <button onClick={()=>setActive(!active)} className={`w-full py-4 rounded-2xl font-bold tracking-widest transition ${active ? 'bg-red-900/50 text-red-500 border border-red-500' : 'btn-primary'}`}>{active ? 'STOP MINING' : 'ACTIVATE NODE'}</button>
                    
                    <div className="w-full glass-panel p-4 rounded-xl mt-4 space-y-4">
                        <div className="text-neon text-xs font-bold uppercase"><i className="fas fa-wallet mr-2"></i> Withdrawal Configuration</div>
                        <div><label className="text-[10px] text-gray-500 uppercase">CTY Wallet Address</label><div className="flex bg-[#0d0d0d] border border-gray-700 rounded p-2 items-center"><input placeholder="Enter your CTY Address..." className="flex-1 bg-transparent text-xs text-white outline-none font-mono"/><i className="fas fa-qrcode text-gray-500"></i></div></div>
                        <div className="flex gap-4"><div className="flex-1 bg-black/50 border border-gray-800 p-2 rounded"><div className="text-[9px] text-gray-500">Min Withdrawal</div><div className="text-white font-mono text-xs">500 CTY</div></div><div className="flex-1 bg-black/50 border border-gray-800 p-2 rounded"><div className="text-[9px] text-gray-500">Max Withdrawal</div><div className="text-white font-mono text-xs">50,000 CTY</div></div></div>
                        <button className="w-full bg-gray-800 text-gray-500 font-bold py-3 rounded text-xs uppercase cursor-not-allowed">Withdrawal Locked Until Launch</button>
                    </div>
                </div> 
            );
        };

        const Warehouse = ({ user, goBack }) => {
            const [files, setFiles] = useState([]); const [loading, setLoading] = useState(false);
            useEffect(() => { const u = window.fb.fns.onSnapshot(window.fb.fns.query(window.fb.fns.collection(window.fb.db, "warehouse"), window.fb.fns.where("uid", "==", user.uid)), s => setFiles(s.docs.map(d=>d.data()))); return () => u(); }, []);
            const upload = async (e) => { const f = e.target.files[0]; if(!f) return; setLoading(true); const r = await uploadToCloudinary(f); if(r) await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "warehouse"), { uid: user.uid, url: r.url, name: f.name, type: r.type, createdAt: window.fb.fns.serverTimestamp() }); setLoading(false); };
            return ( <div className="h-full bg-dark p-4 flex flex-col pt-10"><div className="flex justify-between items-center mb-6"><button onClick={goBack}><i className="fas fa-arrow-left text-neon"></i></button><h2 className="text-xl font-bold text-white">WARE<span className="text-neon">HOUSE</span></h2><label className="btn-primary px-3 py-1 rounded text-xs cursor-pointer">{loading?'...':'UPLOAD'}<input type="file" hidden onChange={upload}/></label></div><div className="grid grid-cols-2 gap-3 overflow-y-auto pb-20">{files.map((f,i)=>(<div key={i} className="glass-panel p-2 rounded-xl"><div className="aspect-square bg-black/50 rounded mb-2 overflow-hidden flex items-center justify-center">{f.type==='video'?<video src={f.url} className="w-full h-full object-cover"/>:<img src={f.url} className="w-full h-full object-cover"/>}</div><div className="text-xs text-white truncate">{f.name}</div><a href={f.url} download className="block text-center bg-neon/20 text-neon text-[10px] mt-2 rounded py-1">DOWNLOAD</a></div>))}</div></div> );
        };

        const Groups = ({ user, goBack }) => {
            const [view, setView] = useState('list'); const [groups, setGroups] = useState([]); const [active, setActive] = useState(null); const [msgs, setMsgs] = useState([]); const [txt, setTxt] = useState(""); const [newName, setNewName] = useState("");
            const [searchQ, setSearchQ] = useState(""); const [foundUsers, setFoundUsers] = useState([]); const [showAddModal, setShowAddModal] = useState(false);
            const scrollRef = useRef();

            useEffect(() => { const u = window.fb.fns.onSnapshot(window.fb.fns.query(window.fb.fns.collection(window.fb.db, "groups"), window.fb.fns.where("members", "array-contains", user.uid)), s => setGroups(s.docs.map(d=>({id:d.id, ...d.data()})))); return () => u(); }, [user]);
            useEffect(() => { if(active) { const u = window.fb.fns.onSnapshot(window.fb.fns.query(window.fb.fns.collection(window.fb.db, "groups", active.id, "messages"), window.fb.fns.orderBy("createdAt")), s => { setMsgs(s.docs.map(d=>d.data())); setTimeout(()=>scrollRef.current?.scrollTo({top:scrollRef.current.scrollHeight, behavior:'smooth'}), 100); }); return () => u(); } }, [active]);
            useEffect(() => { if(searchQ.length < 3) { setFoundUsers([]); return; } const f = window.fb.fns; f.getDocs(f.query(f.collection(window.fb.db, "users"), f.where("displayName", ">=", searchQ), f.where("displayName", "<=", searchQ+'\uf8ff'))).then(s => setFoundUsers(s.docs.map(d=>({id:d.id, ...d.data()})))); }, [searchQ]);

            const create = async () => { if(newName) await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "groups"), { name: newName, members: [user.uid], icon: '' }); setView('list'); };
            const send = async (e) => { e.preventDefault(); if(txt) await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "groups", active.id, "messages"), { text: txt, sender: user.displayName, uid: user.uid, createdAt: window.fb.fns.serverTimestamp() }); setTxt(""); };
            const changeIcon = async (e) => { const f=e.target.files[0]; if(f){ const r=await uploadToCloudinary(f); if(r) await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db,"groups",active.id),{icon:r.url}); } };
            const changeBg = async (e) => { const f=e.target.files[0]; if(f){ const r=await uploadToCloudinary(f); if(r) await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db,"groups",active.id),{bg:r.url}); } };
            const addMember = async (uid) => { await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db,"groups",active.id), {members:window.fb.fns.arrayUnion(uid)}); alert("Member Added"); setSearchQ(""); setFoundUsers([]); setShowAddModal(false); };
            const cycleBg = () => { const bgs=['black','linear-gradient(45deg, #111, #222)','radial-gradient(circle, #222, #000)']; const curr=active.bg||'black'; const next=bgs[(bgs.indexOf(curr)+1)%bgs.length] || bgs[0]; window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db,"groups",active.id),{bg:next}); };

            if(view==='list') return <div className="h-full p-4 pt-10"><div className="flex justify-between mb-4"><h2 className="text-xl font-bold text-white">GROUPS</h2><button onClick={goBack} className="text-gray-400">Exit</button></div><button onClick={()=>setView('new')} className="w-full glass-panel p-3 text-neon mb-4 border-dashed border border-neon">+ Create Squad</button><div className="space-y-2">{groups.map(g=><div key={g.id} onClick={()=>{setActive(g); setView('chat')}} className="glass-panel p-4 rounded-xl flex items-center gap-3 cursor-pointer hover:border-neon"><img src={g.icon||'https://via.placeholder.com/50'} className="w-10 h-10 rounded-full bg-gray-800"/><span className="font-bold text-white flex-1">{g.name}</span><i className="fas fa-chevron-right text-gray-500"></i></div>)}</div></div>;
            if(view==='new') return <div className="h-full p-4 pt-10 flex flex-col justify-center"><input value={newName} onChange={e=>setNewName(e.target.value)} placeholder="Squad Name" className="input-box p-4 rounded-xl mb-4" /><button onClick={create} className="btn-primary py-3 rounded-xl">CREATE</button><button onClick={()=>setView('list')} className="mt-4 text-gray-400">Cancel</button></div>;
            
            return (
                <div className="h-full flex flex-col pt-10 relative" style={{backgroundImage: `url(${active.bg})`, backgroundSize:'cover', backgroundPosition:'center', backgroundColor: active.bg && !active.bg.includes('http') ? active.bg : '#000'}}>
                    <div className="p-4 border-b border-neon/20 flex items-center justify-between glass-panel z-10 bg-black/80 backdrop-blur-md">
                        <div className="flex items-center gap-3">
                            <button onClick={()=>setView('list')}><i className="fas fa-arrow-left text-white"></i></button>
                            <label className="relative cursor-pointer group">
                                <img src={active.icon||'https://via.placeholder.com/50'} className="w-10 h-10 rounded-full border border-neon"/>
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 rounded-full"><i className="fas fa-camera text-white text-xs"></i></div>
                                <input type="file" hidden onChange={changeIcon}/>
                            </label>
                            <span className="text-white font-bold">{active.name}</span>
                        </div>
                        <div className="flex gap-4 text-neon">
                            <button onClick={()=>setShowAddModal(true)}><i className="fas fa-user-plus"></i></button>
                            <button onClick={cycleBg}><i className="fas fa-magic"></i></button>
                            <label className="cursor-pointer"><i className="fas fa-image"></i><input type="file" hidden onChange={changeBg}/></label>
                        </div>
                    </div>
                    {showAddModal && <div className="absolute inset-0 bg-black/95 z-50 p-4 pt-20"><div className="flex justify-between mb-4"><h3 className="text-white font-bold">Add Member</h3><button onClick={()=>setShowAddModal(false)} className="text-gray-400">Close</button></div><input value={searchQ} onChange={e=>setSearchQ(e.target.value)} className="w-full input-box rounded-full px-4 py-2 mb-4" placeholder="Search..." /><div className="space-y-2">{foundUsers.map(u => <div key={u.id} className="glass-panel p-3 rounded flex justify-between items-center"><span className="text-white">{u.displayName}</span><button onClick={()=>addMember(u.id)} className="text-neon font-bold text-xs">ADD</button></div>)}</div></div>}
                    <div className="flex-1 overflow-y-auto p-4 space-y-2 z-0" ref={scrollRef}>{msgs.map((m,i)=><div key={i} className={`flex flex-col ${m.uid===user.uid?'items-end':'items-start'}`}><div className={`px-3 py-2 rounded-xl text-sm ${m.uid===user.uid?'btn-primary':'glass-panel text-white'}`}>{m.text}</div><span className="text-[9px] text-gray-500 bg-black/50 px-1 rounded">{m.sender}</span></div>)}</div>
                    <form onSubmit={send} className="p-3 glass-panel flex gap-2 z-10"><input value={txt} onChange={e=>setTxt(e.target.value)} className="flex-1 input-box rounded-full px-4" /><button className="text-neon"><i className="fas fa-paper-plane"></i></button></form>
                </div>
            );
        };

        const Settings = ({ user, signOut }) => {
            const [apiKey, setApiKey] = useState(localStorage.getItem('cryptinity_ai_key') || '');
            const [reqs, setReqs] = useState([]);
            useEffect(() => { window.fb.fns.getDoc(window.fb.fns.doc(window.fb.db, "users", user.uid)).then(async d => { if(d.exists() && d.data().friendRequests && d.data().friendRequests.length > 0) { const rIds = d.data().friendRequests; const snaps = await Promise.all(rIds.map(id => window.fb.fns.getDoc(window.fb.fns.doc(window.fb.db, "users", id)))); setReqs(snaps.map(s => ({ id: s.id, ...s.data() }))); } }); }, []);
            const acceptFriend = async (fid) => { const b = window.fb.db; const f = window.fb.fns; await f.updateDoc(f.doc(b, "users", user.uid), { friends: f.arrayUnion(fid), friendRequests: f.arrayRemove(fid) }); await f.updateDoc(f.doc(b, "users", fid), { friends: f.arrayUnion(user.uid) }); setReqs(reqs.filter(r => r.id !== fid)); alert("Friend Added!"); };
            const saveKey = () => { localStorage.setItem('cryptinity_ai_key', apiKey); alert('API Key Saved'); };
            return ( <div className="h-full p-6 pt-10 overflow-y-auto pt-16"><h2 className="text-2xl font-bold text-white mb-6">SYSTEM</h2>{reqs.length > 0 && <div className="mb-6"><h3 className="text-neon font-bold mb-2">Friend Requests</h3>{reqs.map(r => (<div key={r.id} className="glass-panel p-3 rounded-xl flex justify-between items-center mb-2"><span className="text-white">{r.displayName}</span><button onClick={()=>acceptFriend(r.id)} className="btn-primary text-xs px-3 py-1 rounded">Accept</button></div>))}</div>}<div className="glass-panel p-4 rounded-xl mb-4"><div className="text-white mb-2 text-sm font-bold">Gemini API Key</div><div className="flex gap-2"><input value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="Paste Key..." className="flex-1 input-box rounded px-2 text-xs" /><button onClick={saveKey} className="text-neon text-xs font-bold border border-neon px-3 rounded">SAVE</button></div></div><div className="space-y-3"><div className="glass-panel p-4 rounded-xl flex justify-between items-center text-white"><span>Notifications</span><div className="w-10 h-5 bg-neon rounded-full relative"><div className="absolute right-1 top-1 w-3 h-3 bg-black rounded-full"></div></div></div><button onClick={signOut} className="w-full glass-panel p-4 rounded-xl text-red-500 font-bold border border-red-900/50 hover:bg-red-900/20">LOGOUT</button></div></div> );
        };

        const Profile = ({ user, targetUid, goBack, startChat }) => {
            const [data, setData] = useState(null); const [edit, setEdit] = useState(false); const [bio, setBio] = useState("");
            const [tab, setTab] = useState('Posts'); const [posts, setPosts] = useState([]); const [gallery, setGallery] = useState([]); const [txt, setTxt] = useState("");
            const [muted, setMuted] = useState(false);
            
            const uid = targetUid || user.uid; const isMe = uid === user.uid;
            const audioRef = useRef(null);
            const [playing, setPlaying] = useState(false);

            useEffect(() => { const unsub = window.fb.fns.onSnapshot(window.fb.fns.doc(window.fb.db, "users", uid), d => { if(d.exists()){ setData(d.data()); setBio(d.data().bio||""); } }); return () => unsub(); }, [uid]);
            useEffect(() => { const q = window.fb.fns.query(window.fb.fns.collection(window.fb.db, "posts"), window.fb.fns.where("uid", "==", uid)); window.fb.fns.getDocs(q).then(s => { let p = s.docs.map(d => ({id:d.id, ...d.data()})); p.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)); setPosts(p); setGallery(p.filter(x => x.image)); }); }, [uid]);
            
            useEffect(() => {
                if(data?.themeSong) {
                    if(audioRef.current) audioRef.current.pause();
                    audioRef.current = new Audio(data.themeSong);
                    audioRef.current.volume = 0.5;
                    audioRef.current.loop = true;
                    const p = audioRef.current.play();
                    if(p !== undefined) p.then(() => setPlaying(true)).catch(() => setPlaying(false));
                }
                return () => { if(audioRef.current) audioRef.current.pause(); }
            }, [data?.themeSong]);

            const toggleAudio = () => { if(audioRef.current) { if(playing) { audioRef.current.pause(); setPlaying(false); } else { audioRef.current.play(); setPlaying(true); } } };
            const handleUpload = async (e, field) => { const f=e.target.files[0]; if(!f) return; const r=await uploadToCloudinary(f); if(r) { await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db,"users",uid), {[field]:r.url}); if(field==='avatar') window.fb.fns.updateProfile(user, {photoURL:r.url}); } };
            const saveBio = async () => { await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db,"users",uid), {bio}); setEdit(false); };
            const addFriend = async () => { await window.fb.fns.updateDoc(window.fb.fns.doc(window.fb.db,"users",uid), {friendRequests: window.fb.fns.arrayUnion(user.uid)}); alert("Request Sent"); };
            const postToTimeline = async () => { if(!txt)return; await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db,"posts"), {author:user.displayName, avatar:user.photoURL, uid:user.uid, text:txt, createdAt:window.fb.fns.serverTimestamp(), likes:[]}); setTxt(""); alert("Posted!"); };
            const deletePost = async (pid) => { if(confirm("Delete post?")) await window.fb.fns.deleteDoc(window.fb.fns.doc(window.fb.db,"posts",pid)); };

            if(!data) return <div className="p-10 text-neon pt-16">Loading...</div>;
            const friendCount = data.displayName === 'Admin' ? '56K' : (data.friends?.length || 0);

            return (
                <div className="h-full overflow-y-auto bg-dark pb-20 pt-10">
                    <div className="h-48 relative bg-gray-800">
                        {data.cover ? <img src={data.cover} className="w-full h-full object-cover"/> : <div className="w-full h-full bg-gradient-to-r from-gray-900 to-black"></div>}
                        {isMe && <label className="absolute bottom-2 right-2 bg-black/60 p-2 rounded-full cursor-pointer text-white hover:text-neon z-20"><i className="fas fa-camera"></i><input type="file" hidden onChange={e=>handleUpload(e,'cover')}/></label>}
                        {targetUid && <button onClick={goBack} className="absolute top-4 left-4 glass-panel p-2 rounded-full text-white z-20"><i className="fas fa-arrow-left"></i></button>}
                        {data.themeSong && <button onClick={toggleAudio} className="absolute top-4 right-4 bg-black/50 p-2 rounded-full text-neon z-20 animate-pulse"><i className={`fas fa-volume-${playing?'up':'mute'}`}></i></button>}
                    </div>
                    <div className="px-6 -mt-16 relative z-10">
                        <div className="flex justify-between items-end">
                            <div className="relative group">
                                <img src={data.avatar} className="w-32 h-32 rounded-full border-4 border-dark object-cover bg-black"/>
                                {isMe && <label className="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer text-neon z-20"><i className="fas fa-camera"></i><input type="file" hidden onChange={e=>handleUpload(e,'avatar')}/></label>}
                            </div>
                            <div className="flex gap-2 mb-4">
                                {!isMe && !data.friends?.includes(user.uid) && <button onClick={addFriend} className="btn-primary px-4 py-1 rounded-full text-sm">Add Friend</button>}
                                {!isMe && <button onClick={()=>startChat(uid)} className="bg-gray-700 text-white px-4 py-1 rounded-full text-sm">Message</button>}
                            </div>
                        </div>
                        <h1 className="text-2xl font-bold text-white mt-2">{data.displayName} <i className="fas fa-check-circle text-neon text-sm"></i></h1>
                        <p className="text-gray-400 text-sm mb-4">Web4 Citizen • {friendCount} Friends</p>
                        <div className="flex border-b border-gray-800 mb-4">{['Posts', 'About', 'Gallery'].map(t => (<button key={t} onClick={()=>setTab(t)} className={`flex-1 py-3 text-sm font-bold ${tab===t?'text-neon border-b-2 border-neon':'text-gray-500'}`}>{t}</button>))}</div>
                        {tab === 'About' && <div className="glass-panel p-4 rounded-xl mb-4 relative"><div className="flex justify-between mb-2"><h3 className="text-neon font-bold">Bio</h3>{isMe && <button onClick={()=>setEdit(!edit)} className="text-gray-400"><i className={`fas fa-${edit?'times':'pen'}`}></i></button>}</div>{edit ? <div><textarea value={bio} onChange={e=>setBio(e.target.value)} className="w-full bg-black/50 text-white border border-gray-700 rounded p-2 text-sm outline-none mb-2"/><button onClick={saveBio} className="text-neon text-xs font-bold">SAVE</button></div> : <p className="text-gray-300 text-sm italic">"{data.bio || "No bio yet."}"</p>}<div className="mt-4 pt-4 border-t border-gray-700"><h3 className="text-white font-bold text-xs mb-2">THEME SONG</h3>{data.themeSong ? <div className="text-neon text-xs flex items-center gap-2"><i className="fas fa-music"></i> Audio Loaded</div> : <div className="text-gray-500 text-xs">No anthem set.</div>}{isMe && <label className="block text-center mt-2 text-xs text-gray-500 cursor-pointer hover:text-neon underline">Change Anthem <input type="file" hidden accept="audio/*" onChange={e=>handleUpload(e,'themeSong')}/></label>}</div></div>}
                        {tab === 'Gallery' && <div className="grid grid-cols-3 gap-2">{gallery.map((p, i) => <div key={i} className="aspect-square bg-gray-800 rounded overflow-hidden relative">{p.mediaType==='video'?<video src={p.image} className="w-full h-full object-cover"/>:<img src={p.image} className="w-full h-full object-cover"/>}</div>)}{gallery.length===0 && <div className="text-gray-500 col-span-3 text-center py-4 text-sm">No media yet.</div>}</div>}
                        {tab === 'Posts' && <div className="space-y-4">{isMe && <div className="glass-panel p-3 rounded-xl flex gap-2"><input value={txt} onChange={e=>setTxt(e.target.value)} className="flex-1 bg-transparent text-white outline-none text-sm" placeholder="Write on your timeline..." /><button onClick={postToTimeline} className="text-neon font-bold text-sm">POST</button></div>}{posts.map((p,i) => (<div key={i} className="glass-panel rounded-xl overflow-hidden p-3 relative group">{isMe && <button onClick={()=>deletePost(p.id)} className="absolute top-3 right-3 text-red-500 opacity-50 hover:opacity-100 z-10"><i className="fas fa-trash"></i></button>}<div className="text-xs text-gray-400 mb-2">{formatTime(p.createdAt)}</div><div className="text-white text-sm mb-2">{p.text}</div>{p.image && (p.mediaType==='video' ? <video src={p.image} controls className="w-full rounded max-h-60 object-cover"/> : <img src={p.image} className="w-full rounded max-h-60 object-cover"/>)}</div>))}{posts.length===0 && <div className="text-gray-500 text-center py-4 text-sm">No posts yet.</div>}</div>}
                    </div>
                </div>
            );
        };

        const SocialFeed = ({ user, goToProfile }) => {
            const [posts, setPosts] = useState([]); const [stories, setStories] = useState([]); const [txt, setTxt] = useState(""); const [media, setMedia] = useState(null); const [loading, setLoading] = useState(false); const [view, setView] = useState('feed');
            const [commentInputs, setCommentInputs] = useState({});

            useEffect(() => { const u = window.fb.fns.onSnapshot(window.fb.fns.query(window.fb.fns.collection(window.fb.db, "posts"), window.fb.fns.limit(30)), s => { let d = s.docs.map(x=>({id:x.id,...x.data()})); d.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)); setPosts(d); }); return () => u(); }, []);
            useEffect(() => { const u = window.fb.fns.onSnapshot(window.fb.fns.query(window.fb.fns.collection(window.fb.db, "stories"), window.fb.fns.limit(10)), s => setStories(s.docs.map(d=>d.data()))); return () => u(); }, []);
            const handleFile = async (e) => { const f = e.target.files[0]; if(!f) return; setLoading(true); const r = await uploadToCloudinary(f); if(r) setMedia(r); setLoading(false); };
            const post = async () => { if(!txt && !media) return; setLoading(true); await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "posts"), { author: user.displayName, avatar: user.photoURL, uid: user.uid, text: txt, image: media?.url||null, mediaType: media?.type||'image', createdAt: window.fb.fns.serverTimestamp(), likes: [] }); setTxt(""); setMedia(null); setLoading(false); };
            const addStory = async (e) => { const f = e.target.files[0]; if(!f) return; const r = await uploadToCloudinary(f); if(r) await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "stories"), { user: user.displayName, avatar: user.photoURL, url: r.url, type: r.type, createdAt: window.fb.fns.serverTimestamp() }); };
            
            const handleLike = async (pid, likes) => { const hasLiked = likes?.includes(user.uid); const f = window.fb.fns; await f.updateDoc(f.doc(window.fb.db, "posts", pid), { likes: hasLiked ? f.arrayRemove(user.uid) : f.arrayUnion(user.uid) }); };
            const submitComment = async (pid) => { const text = commentInputs[pid]; if(!text) return; const f = window.fb.fns; await f.updateDoc(f.doc(window.fb.db, "posts", pid), { comments: f.arrayUnion({ user: user.displayName, text: text, time: Date.now() }) }); setCommentInputs({...commentInputs, [pid]: ''}); };
            const handleCommentMedia = async (pid) => { const input = document.createElement('input'); input.type='file'; input.onchange = async e => { const f = e.target.files[0]; if(f) { const r = await uploadToCloudinary(f); if(r) { const fns = window.fb.fns; await fns.updateDoc(fns.doc(window.fb.db, "posts", pid), { comments: fns.arrayUnion({ user: user.displayName, text: "", image: r.url, time: Date.now() }) }); } } }; input.click(); };

            const filteredPosts = view === 'reels' ? posts.filter(p => p.mediaType === 'video') : posts;

            return (
                <div className="h-full overflow-y-auto pb-24 pt-8">
                    <div className="flex gap-2 p-4 overflow-x-auto hide-scroll border-b border-gray-800 bg-black/20">
                         <div className="flex flex-col items-center gap-1 shrink-0"><label className="w-14 h-14 rounded-full border-2 border-dashed border-neon flex items-center justify-center text-neon cursor-pointer"><i className="fas fa-plus"></i><input type="file" hidden onChange={addStory}/></label><span className="text-[10px] text-gray-400">Add Story</span></div>
                         {stories.map((s,i) => <div key={i} className="flex flex-col items-center gap-1 shrink-0"><div className="w-14 h-14 rounded-full p-[2px] bg-gradient-to-tr from-neon to-blue-500"><img src={s.avatar} className="w-full h-full rounded-full border-2 border-black object-cover"/></div><span className="text-[10px] text-gray-400 truncate w-14 text-center">{s.user}</span></div>)}
                    </div>
                    <div className="flex p-4 gap-4 sticky top-0 bg-black/95 z-20 backdrop-blur">
                        <button onClick={()=>setView('feed')} className={`font-bold ${view==='feed'?'text-neon border-b-2 border-neon':'text-gray-500'}`}>Feed</button>
                        <button onClick={()=>setView('reels')} className={`font-bold ${view==='reels'?'text-neon border-b-2 border-neon':'text-gray-500'}`}>Reels</button>
                    </div>
                    {view === 'feed' && <div className="p-4 glass-panel m-4 rounded-2xl border-neon/30">
                        <div className="flex gap-3 mb-2"><img src={user.photoURL} className="w-10 h-10 rounded-full border border-neon"/><textarea value={txt} onChange={e=>setTxt(e.target.value)} placeholder="What's happening?" className="flex-1 bg-transparent text-white outline-none resize-none h-12 text-sm placeholder-gray-500"></textarea></div>
                        {media && <div className="h-20 w-20 bg-gray-800 rounded mb-2 overflow-hidden relative"><img src={media.type==='video'?'https://img.icons8.com/fluency/48/video.png':media.url} className="w-full h-full object-cover"/><button onClick={()=>setMedia(null)} className="absolute top-0 right-0 bg-red-500 w-5 h-5 text-xs text-white">x</button></div>}
                        <div className="flex justify-between items-center"><div className="flex gap-4 text-neon"><label className="cursor-pointer hover:text-white"><i className="fas fa-image"></i><input type="file" hidden accept="image/*" onChange={handleFile}/></label><label className="cursor-pointer hover:text-white"><i className="fas fa-video"></i><input type="file" hidden accept="video/*" onChange={handleFile}/></label></div><button onClick={post} disabled={loading} className="btn-primary px-5 py-1 rounded-full text-xs">{loading?'...':'POST'}</button></div>
                    </div>}
                    <div className="space-y-4 px-4">
                        {filteredPosts.map((p,i) => (
                            <div key={i} className="glass-panel rounded-2xl overflow-hidden relative">
                                <div className="flex items-center gap-3 p-3 cursor-pointer" onClick={()=>goToProfile(p.uid)}><img src={p.avatar} className="w-8 h-8 rounded-full border border-gray-600"/><div><div className="text-white font-bold text-sm">{p.author}</div><div className="text-[10px] text-gray-500">{formatTime(p.createdAt)}</div></div></div>
                                {p.image && <div className="video-container">{p.mediaType==='video' ? <video src={p.image} controls/> : <img src={p.image}/>}</div>}
                                <div className="p-3"><p className="text-gray-200 text-sm mb-3">{p.text}</p>
                                <div className="flex justify-between text-gray-400 text-sm border-t border-gray-700 pt-2"><button onClick={()=>handleLike(p.id, p.likes)} className={`flex gap-1 items-center hover:text-neon ${p.likes?.includes(user.uid)?'text-neon':''}`}><i className="fas fa-heart"></i> {p.likes?.length||0}</button><button className="flex gap-1 items-center hover:text-white"><i className="fas fa-share"></i> Share</button></div>
                                <div className="mt-3 bg-black/20 p-2 rounded">
                                    {p.comments && p.comments.map((c, idx) => <div key={idx} className="text-xs mb-1"><span className="text-neon font-bold">{c.user}:</span> <span className="text-gray-300">{c.text}</span>{c.image && <img src={c.image} className="h-10 mt-1 rounded block"/>}</div>)}
                                    <div className="flex gap-2 mt-2"><input value={commentInputs[p.id]||''} onChange={e=>setCommentInputs({...commentInputs, [p.id]:e.target.value})} className="flex-1 bg-black/50 rounded px-2 py-1 text-xs text-white border border-gray-700 outline-none" placeholder="Write a comment..." /><button onClick={()=>handleCommentMedia(p.id)} className="text-gray-400 hover:text-white"><i className="fas fa-paperclip"></i></button><button onClick={()=>submitComment(p.id)} className="text-neon text-xs"><i className="fas fa-paper-plane"></i></button></div>
                                </div></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Messenger = ({ user, targetUid, setTargetUid }) => {
            const [view, setView] = useState(targetUid ? 'chat' : 'list');
            const [chatUser, setChatUser] = useState(null);
            const [msgs, setMsgs] = useState([]);
            const [txt, setTxt] = useState("");
            const [friends, setFriends] = useState([]);
            const [calling, setCalling] = useState(false);
            const [videoCall, setVideoCall] = useState(false);
            const scrollRef = useRef();

            useEffect(() => {
                if(targetUid) {
                    window.fb.fns.getDoc(window.fb.fns.doc(window.fb.db, "users", targetUid)).then(d => {
                        if(d.exists()) { setChatUser({ id: d.id, ...d.data() }); setView('chat'); }
                    });
                }
            }, [targetUid]);

            useEffect(() => { window.fb.fns.getDoc(window.fb.fns.doc(window.fb.db, "users", user.uid)).then(d => { if(d.exists() && d.data().friends) { Promise.all(d.data().friends.map(fid => window.fb.fns.getDoc(window.fb.fns.doc(window.fb.db, "users", fid)))).then(snaps => setFriends(snaps.map(s=>({id:s.id, ...s.data()})))); } }); }, []);

            useEffect(() => { if(!chatUser) return; const cid = [user.uid, chatUser.id].sort().join("_"); const u = window.fb.fns.onSnapshot(window.fb.fns.query(window.fb.fns.collection(window.fb.db, "messages", cid, "chats"), window.fb.fns.orderBy("createdAt")), s => { setMsgs(s.docs.map(d=>d.data())); setTimeout(()=>scrollRef.current?.scrollTo({top:scrollRef.current.scrollHeight, behavior:'smooth'}), 100); }); return () => u(); }, [chatUser]);
            const send = async (e) => { e.preventDefault(); if(txt) { const cid = [user.uid, chatUser.id].sort().join("_"); await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "messages", cid, "chats"), { text: txt, from: user.uid, createdAt: window.fb.fns.serverTimestamp() }); setTxt(""); } };
            const handleMedia = async (e) => { const f = e.target.files[0]; if(!f) return; const r = await uploadToCloudinary(f); if(r) { const cid = [user.uid, chatUser.id].sort().join("_"); await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "messages", cid, "chats"), { text: "", image: r.url, type: r.type, from: user.uid, createdAt: window.fb.fns.serverTimestamp() }); } };
            const goBack = () => { setView('list'); setChatUser(null); setTargetUid(null); };

            if(calling) return ( <div className="h-full bg-black flex flex-col items-center justify-center relative"><video ref={v=>{if(v)navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s=>v.srcObject=s)}} autoPlay muted className="absolute inset-0 w-full h-full object-cover opacity-50"/><div className="z-10 flex flex-col items-center"><img src={chatUser.avatar} className="w-24 h-24 rounded-full border-4 border-neon mb-4"/><h2 className="text-2xl text-white font-bold mb-8">{videoCall ? 'Video Call' : 'Audio Call'}...</h2><button onClick={()=>setCalling(false)} className="w-16 h-16 rounded-full bg-red-600 flex items-center justify-center text-white text-2xl"><i className="fas fa-phone-slash"></i></button></div></div> );
            if(view === 'list') return ( <div className="h-full p-4 overflow-y-auto pt-16"><h2 className="text-xl font-bold text-white mb-4">MESSENGER</h2>{friends.length === 0 && <div className="text-gray-500">Add friends to start chatting.</div>}{friends.map(f => <div key={f.id} onClick={()=>{setChatUser(f); setView('chat');}} className="glass-panel p-3 mb-2 rounded-xl flex items-center gap-3 cursor-pointer hover:border-neon"><img src={f.avatar} className="w-10 h-10 rounded-full"/><div className="text-white font-bold">{f.displayName}</div></div>)}</div> );
            
            return ( <div className="h-full flex flex-col bg-dark pt-10"><div className="p-4 glass-panel flex items-center justify-between"><div className="flex items-center gap-3"><button onClick={goBack} className="text-neon"><i className="fas fa-arrow-left"></i></button>{chatUser && <><img src={chatUser.avatar} className="w-8 h-8 rounded-full"/><span className="text-white font-bold">{chatUser.displayName}</span></>}</div><div className="flex gap-4 text-neon"><button onClick={()=>{setCalling(true); setVideoCall(false)}}><i className="fas fa-phone"></i></button><button onClick={()=>{setCalling(true); setVideoCall(true)}}><i className="fas fa-video"></i></button></div></div><div className="flex-1 overflow-y-auto p-4 space-y-2" ref={scrollRef}>{msgs.map((m,i)=><div key={i} className={`flex ${m.from===user.uid?'justify-end':'justify-start'}`}><div className={`px-4 py-2 rounded-2xl max-w-[70%] text-sm ${m.from===user.uid?'btn-primary':'glass-panel text-white'}`}>{m.image ? <img src={m.image} className="max-h-40 rounded"/> : m.text}</div></div>)}</div><form onSubmit={send} className="p-3 glass-panel flex gap-2 items-center"><label className="text-gray-400 cursor-pointer"><i className="fas fa-paperclip"></i><input type="file" hidden onChange={handleMedia}/></label><input value={txt} onChange={e=>setTxt(e.target.value)} className="flex-1 input-box rounded-full px-4" placeholder="Message..." /><button className="text-neon px-2"><i className="fas fa-paper-plane"></i></button></form></div> );
        };

        const MusicApp = ({ user }) => {
             const [tracks, setTracks] = useState([]); const [myTracks, setMyTracks] = useState([]);
             useEffect(() => { fetch(`https://api.jamendo.com/v3.0/tracks/?client_id=ecbc9437&format=jsonpretty&limit=10&order=popularity_total`).then(r=>r.json()).then(d=>setTracks(d.results)).catch(()=>{}); const u = window.fb.fns.onSnapshot(window.fb.fns.collection(window.fb.db, "users", user.uid, "music"), s=>setMyTracks(s.docs.map(d=>d.data()))); return () => u(); }, []);
             const upload = async (e) => { const f = e.target.files[0]; if(!f) return; const r = await uploadToCloudinary(f); if(r) await window.fb.fns.addDoc(window.fb.fns.collection(window.fb.db, "users", user.uid, "music"), { name: f.name, url: r.url }); };
             return ( <div className="h-full p-4 overflow-y-auto pt-16"><h2 className="text-xl font-bold text-white mb-4">SONIC <span className="text-neon">WAVES</span></h2><div className="mb-6"><div className="flex justify-between items-center mb-2"><h3 className="text-white font-bold">My Playlist</h3><label className="text-neon text-xs cursor-pointer">+ Upload MP3<input type="file" hidden accept="audio/*" onChange={upload}/></label></div>{myTracks.map((t,i)=><div key={i} className="glass-panel p-2 mb-2 rounded flex items-center gap-2"><i className="fas fa-music text-neon"></i><div className="flex-1 truncate text-white text-sm">{t.name}</div><audio controls src={t.url} className="h-6 w-32"/></div>)}</div><h3 className="text-white font-bold mb-2">Global Stream</h3>{tracks.map(t=>(<div key={t.id} className="glass-panel p-3 rounded-xl mb-2 flex items-center gap-3"><img src={t.image} className="w-10 h-10 rounded"/><div className="flex-1 overflow-hidden"><div className="text-white text-sm font-bold truncate">{t.name}</div><div className="text-xs text-gray-500">{t.artist_name}</div></div><a href={t.audio} target="_blank" className="text-neon"><i className="fas fa-play"></i></a></div>))}</div> );
        };

        const AppsHub = ({ setView }) => (
            <div className="h-full p-6 overflow-y-auto pt-16">
                <h2 className="text-2xl font-bold text-white mb-6 brand-font">WEB4 <span className="text-neon">ECOSYSTEM</span></h2>
                <div className="grid grid-cols-2 gap-4">
                    <div onClick={()=>setView('wallet')} className="aspect-square glass-panel rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-volt transition group">
                        <div className="w-16 h-16 rounded-full bg-[#161616] flex items-center justify-center mb-3 border border-[#333] group-hover:bg-volt group-hover:text-black transition">
                             <i className="fas fa-wallet text-3xl text-volt group-hover:text-black"></i>
                        </div>
                        <span className="text-white font-bold">Wallet</span>
                    </div>
                    <div onClick={()=>setView('mining')} className="aspect-square glass-panel rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-neon transition">
                        <i className="fas fa-bolt text-4xl text-yellow-400 mb-2"></i>
                        <span className="text-white font-bold">Mining</span>
                    </div>
                    <div onClick={()=>setView('oracle')} className="aspect-square glass-panel rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-neon transition">
                        <i className="fas fa-brain text-4xl text-neon mb-2"></i>
                        <span className="text-white font-bold">Oracle AI</span>
                    </div>
                    <div onClick={()=>setView('warehouse')} className="aspect-square glass-panel rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-neon transition">
                        <i className="fas fa-box-open text-4xl text-blue-400 mb-2"></i>
                        <span className="text-white font-bold">Warehouse</span>
                    </div>
                    <div onClick={()=>setView('groups')} className="aspect-square glass-panel rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-neon transition">
                        <i className="fas fa-users text-4xl text-white mb-2"></i>
                        <span className="text-white font-bold">Groups</span>
                    </div>
                </div>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [user, setUser] = useState(null); const [view, setView] = useState('feed'); const [targetUid, setTargetUid] = useState(null);
            useEffect(() => window.fb.fns.onAuthStateChanged(window.fb.auth, u => setUser(u)), []);
            if(!user) return <Auth setUser={setUser} />;
            const NavBtn = ({ id, i, l }) => <button onClick={()=>{setTargetUid(null); setView(id)}} className={`flex flex-col items-center gap-1 transition-all ${view===id?'text-neon':'text-gray-500'} md:flex-row md:w-full md:p-3 md:rounded-xl md:hover:bg-white/5 md:gap-4`}><i className={`fas fa-${i} text-xl md:text-lg`}></i><span className="text-[10px] md:text-sm">{l}</span></button>;
            const CryptoTicker = () => (<div className="absolute top-0 left-0 right-0 h-8 bg-black z-50 overflow-hidden flex items-center border-b border-neon/30"><div className="whitespace-nowrap animate-marquee flex gap-8 text-xs font-mono text-neon font-bold tracking-widest"><span>BTC: $98,450 <span className="text-green-500">▲ 2.4%</span></span><span>ETH: $3,450 <span className="text-green-500">▲ 1.2%</span></span><span>CTY: $0.00042 <span className="text-white">● STABLE</span></span><span>SOL: $145 <span className="text-green-500">▲ 5.1%</span></span></div></div>);
            return (
                <div className="h-full w-full flex justify-center bg-black">
                    <CryptoTicker />
                    <aside className="hidden lg:flex w-64 flex-col p-6 bg-panel border-r border-neon/10 z-20 pt-16">
                        <div className="flex items-center gap-3 mb-10"><h1 className="text-xl font-bold text-white tracking-widest brand-font">CRYPTINITY</h1></div>
                        <nav className="space-y-2 flex-1"><NavBtn id="feed" i="home" l="Home" /><NavBtn id="apps" i="th" l="Apps" /><NavBtn id="messenger" i="comment-alt" l="Messenger" /><NavBtn id="music" i="music" l="Music" /><NavBtn id="profile" i="user" l="Profile" /><NavBtn id="settings" i="cog" l="Settings" /></nav>
                    </aside>
                    <main className="w-full lg:max-w-2xl h-full relative bg-dark grid-bg overflow-hidden shadow-2xl flex flex-col pt-6">
                        <header className="lg:hidden h-14 flex items-center justify-between px-4 glass-panel border-none rounded-none z-30 shrink-0"><span className="font-bold text-white tracking-widest brand-font">CRYPTINITY</span><div className="flex gap-4"><button onClick={()=>setView('messenger')}><i className="fas fa-comment-alt text-gray-400"></i></button><button onClick={()=>setView('settings')}><i className="fas fa-cog text-gray-400"></i></button></div></header>
                        <div className="p-2 border-b border-gray-800 shrink-0"><UserSearch goToProfile={id=>{setTargetUid(id); setView('profile');}}/></div>
                        <div className="flex-1 overflow-hidden relative">
                            {view === 'feed' && <SocialFeed user={user} goToProfile={(id)=>{setTargetUid(id);setView('profile')}} />}
                            {view === 'mining' && <MiningApp user={user} />}
                            {view === 'wallet' && <WalletApp user={user} goBack={()=>setView('apps')} />}
                            {view === 'apps' && <AppsHub setView={setView} />}
                            {view === 'music' && <MusicApp user={user} />}
                            {view === 'profile' && <Profile user={user} targetUid={targetUid} goBack={()=>setView('feed')} startChat={(uid)=>{setTargetUid(uid); setView('messenger');}} />}
                            {view === 'messenger' && <Messenger user={user} targetUid={targetUid} setTargetUid={setTargetUid} />}
                            {view === 'warehouse' && <Warehouse user={user} goBack={()=>setView('apps')} />}
                            {view === 'groups' && <Groups user={user} goBack={()=>setView('apps')} />}
                            {view === 'oracle' && <NeuralWidget />}
                            {view === 'settings' && <Settings user={user} signOut={()=>window.fb.fns.signOut(window.fb.auth)} />}
                        </div>
                        <nav className="lg:hidden h-16 glass-panel rounded-t-3xl border-t-0 flex items-center justify-around z-30 shrink-0"><NavBtn id="feed" i="home" l="Home" /><NavBtn id="apps" i="th" l="Apps" /><div className="relative -top-5"><button onClick={()=>setView('wallet')} className="w-14 h-14 rounded-full bg-volt flex items-center justify-center text-2xl shadow-[0_0_20px_rgba(204,255,0,0.5)]"><i className="fas fa-wallet text-black"></i></button></div><NavBtn id="music" i="music" l="Music" /><NavBtn id="profile" i="user" l="Me" /></nav>
                    </main>
                    <aside className="hidden xl:block w-72 h-full z-20 pt-8"><NeuralWidget /></aside>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>